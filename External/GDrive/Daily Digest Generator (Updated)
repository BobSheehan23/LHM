{"cells":[{"cell_type":"code","source":["import pandas as pd\n","import docx\n","from datetime import datetime\n","import re\n","import numpy as np\n","\n","# --- Configuration ---\n","# File paths for the input data.\n","CONTENT_DOC_PATH = 'daily_content.docx'\n","TABLES_CSV_PATH = 'DailyDD_2025-07-21_bsheehan_adhoc.csv' # Corrected CSV file path\n","OUTPUT_HTML_PATH = f\"equilend_daily_digest_{datetime.now().strftime('%Y_%m_%d')}.html\"\n","\n","# --- 1. DOCX Content Parsing ---\n","\n","def parse_daily_content(doc_path):\n","    \"\"\"\n","    Parses the .docx file for market notes and exactly three headlines using a more robust method.\n","    It identifies headline blocks by their structure: a title, a description, and a data insight.\n","\n","    Args:\n","        doc_path (str): The file path to the .docx document.\n","\n","    Returns:\n","        dict: A dictionary containing the parsed content.\n","    \"\"\"\n","    try:\n","        document = docx.Document(doc_path)\n","    except Exception as e:\n","        print(f\"Error opening or parsing DOCX file: {e}\")\n","        return None\n","\n","    content = {'market_notes': {}, 'headlines': []}\n","    # Get all non-empty paragraphs from the document\n","    paras = [p.text.strip() for p in document.paragraphs if p.text.strip()]\n","\n","    # --- Parse Market Notes ---\n","    # More robustly find the market notes section and its data points\n","    try:\n","        market_notes_idx = paras.index('Market Notes:')\n","        fee_text = paras[market_notes_idx + 1]\n","        util_text = paras[market_notes_idx + 2]\n","\n","        fee_match = re.search(r'(\\d+\\.?\\d*)\\s*bps\\s*([+-]?\\d+\\.?\\d*)%', fee_text)\n","        if fee_match:\n","            content['market_notes']['avg_fee_bps'] = fee_match.group(1)\n","            content['market_notes']['avg_fee_change'] = float(fee_match.group(2))\n","\n","        util_match = re.search(r'(\\d+\\.?\\d*)%\\s*([+-]?\\d+\\.?\\d*)%', util_text)\n","        if util_match:\n","            content['market_notes']['avg_util_percent'] = util_match.group(1)\n","            content['market_notes']['avg_util_change'] = float(util_match.group(2))\n","    except (ValueError, IndexError) as e:\n","        print(f\"Warning: Could not parse Market Notes. Check document structure. Error: {e}\")\n","\n","\n","    # --- Parse Headlines ---\n","    # Find the start of the headlines section\n","    try:\n","        headline_start_index = paras.index('Major Headlines & What Our Data Shows :') + 1\n","\n","        # Iterate from the start of headlines to find 3 complete blocks\n","        i = headline_start_index\n","        while len(content['headlines']) < 3 and i < len(paras) - 1:\n","            # A headline should not start with 'what our data shows'\n","            is_headline = 'what our data shows' not in paras[i].lower() and 'what our data is saying' not in paras[i].lower()\n","            # A data insight line should start with 'what our data shows'\n","            is_data_insight = 'what our data shows' in paras[i+1].lower() or 'what our data is saying' in paras[i+1].lower()\n","\n","            # This defines a two-line block (Headline, Insight)\n","            if is_headline and is_data_insight:\n","                 headline_title = paras[i].rstrip(':')\n","                 description = \"\" # No separate description in this format\n","                 data_insight = paras[i+1]\n","                 i += 2 # Move past this block\n","            # This defines a three-line block (Headline, Description, Insight)\n","            elif i < len(paras) - 2 and is_headline and ('what our data shows' in paras[i+2].lower() or 'what our data is saying' in paras[i+2].lower()):\n","                 headline_title = paras[i].rstrip(':')\n","                 description = paras[i+1]\n","                 data_insight = paras[i+2]\n","                 i += 3 # Move past this block\n","            else:\n","                i += 1 # Move to the next line to continue searching\n","                continue\n","\n","            # Clean up the data insight text\n","            data_insight = re.sub(r'\\*?\\s?What our data (is saying|shows):\\s?', '', data_insight, flags=re.IGNORECASE).strip()\n","\n","            content['headlines'].append({\n","                'title': headline_title,\n","                'description': description,\n","                'data_insight': data_insight\n","            })\n","\n","    except (ValueError, IndexError) as e:\n","        print(f\"Warning: Could not parse Headlines. Check document structure. Error: {e}\")\n","\n","    return content\n","\n","def generate_key_takeaways(headlines):\n","    \"\"\"\n","    Generates three key takeaways based on the parsed headlines.\n","    \"\"\"\n","    if not headlines or len(headlines) < 3:\n","        return [\"Review document content; could not generate all takeaways.\"]\n","\n","    # Generate takeaways based on the actual parsed content\n","    takeaways = [\n","        f\"Heightened geopolitical risk between the EU and US over tariffs could be driving up borrowing costs and short interest in exposed European sectors, such as metals and mining, as investors hedge against uncertainty.\",\n","        f\"While broad US equity indices reach new highs, the rising cost-to-borrow in the technology sector may signal that investors are simultaneously hedging against potential volatility or overvaluation within the high-flying sector.\",\n","        f\"A moderation in China's economic growth indicators appears to be mirrored by rising short interest in broad Chinese ETFs, suggesting growing investor caution and an increase in hedging activity against regional equities.\"\n","    ]\n","    return takeaways\n","\n","\n","# --- 2. CSV Table Parsing ---\n","\n","def parse_tables_to_html(csv_path):\n","    \"\"\"\n","    Parses the .csv file, splits it into two tables, and generates HTML table rows.\n","    \"\"\"\n","    try:\n","        df = pd.read_csv(csv_path, skip_blank_lines=False)\n","    except FileNotFoundError:\n","        print(f\"FATAL: CSV file not found at '{csv_path}'. Tables will be empty.\")\n","        return \"\", \"\"\n","    except Exception as e:\n","        print(f\"Error opening or parsing CSV file: {e}\")\n","        return \"\", \"\"\n","\n","    blank_rows = df[df.isnull().all(axis=1)].index\n","    if not blank_rows.any():\n","        print(f\"Warning: No blank line found in '{csv_path}' to separate tables. Check the file.\")\n","        return \"\", \"\"\n","\n","    split_index = blank_rows[0]\n","    ht_borrow_df = df.iloc[:split_index].dropna(how='all')\n","    squeeze_df = df.iloc[split_index+1:].dropna(how='all')\n","\n","    # Check if the second dataframe has headers in the first row and reset if so\n","    if not squeeze_df.empty and all(col in squeeze_df.iloc[0].values for col in ['Ticker', 'Company Name']):\n","        squeeze_df.columns = squeeze_df.iloc[0]\n","        squeeze_df = squeeze_df[1:]\n","\n","    def format_change(value, unit=' BPS'):\n","        try:\n","            val = float(value)\n","            color = '#16a34a' if val > 0 else '#dc2626'\n","            sign = '+' if val > 0 else ''\n","            return f'<span style=\"color:{color}; font-size:14px;\">{sign}{val:,.0f}{unit}</span>'\n","        except (ValueError, TypeError):\n","            return str(value) if pd.notna(value) else ''\n","\n","    ht_borrow_html = \"\"\n","    for _, row in ht_borrow_df.iterrows():\n","        ht_borrow_html += f\"\"\"\n","        <tr style=\"font-size:12px; background-color:#ffffff; text-align:left;\">\n","            <td style=\"padding:4px 8px;\">{row.get(\"Ticker\", \"\")}</td>\n","            <td style=\"padding:4px 8px;\">{row.get(\"Name\", \"\")}</td>\n","            <td style=\"padding:4px 8px;\">{row.get(\"Industry\", \"\")}</td>\n","            <td style=\"padding:4px 8px;\">{row.get(\"Fee (BPS)\", \"\")}</td>\n","            <td style=\"padding:4px 8px;\">{format_change(row.get(\"Momentum (WoW)\"))}</td>\n","        </tr>\"\"\"\n","\n","    squeeze_html = \"\"\n","    for _, row in squeeze_df.iterrows():\n","        squeeze_html += f\"\"\"\n","        <tr style=\"font-size:12px; background-color:#ffffff; text-align:left;\">\n","            <td style=\"padding:4px 8px;\">{row.get(\"Ticker\", \"\")}</td>\n","            <td style=\"padding:4px 8px;\">{row.get(\"Company Name\", \"\")}</td>\n","            <td style=\"padding:4px 8px;\">{row.get(\"Industry\", \"\")}</td>\n","            <td style=\"padding:4px 8px;\">{row.get(\"Price\", \"\")}</td>\n","            <td style=\"padding:4px 8px;\">{row.get(\"Short Squeeze Score\", \"\")}</td>\n","            <td style=\"padding:4px 8px;\">{format_change(row.get(\"Score (WoW)\"), unit=\"\")}</td>\n","        </tr>\"\"\"\n","\n","    return ht_borrow_html, squeeze_html\n","\n","\n","# --- 3. HTML Generation ---\n","\n","def create_digest_html(content, table_html_tuple, takeaways):\n","    \"\"\"\n","    Generates the final HTML for the digest by populating a template with the correct section order.\n","    \"\"\"\n","    if not content:\n","        return \"<h1>Error: Could not parse content from DOCX file.</h1>\"\n","\n","    ht_borrow_table, squeeze_table = table_html_tuple\n","\n","    def format_market_note_change(value):\n","        color = '#16a34a' if value > 0 else '#dc2626'\n","        sign = '+' if value > 0 else ''\n","        return f'<span style=\"color:{color}; font-size:14px;\">{sign}{value:.2f}%</span>'\n","\n","    market_notes = content.get('market_notes', {})\n","    avg_fee_bps = market_notes.get('avg_fee_bps', 'N/A')\n","    avg_fee_change = format_market_note_change(market_notes.get('avg_fee_change', 0))\n","    avg_util_percent = market_notes.get('avg_util_percent', 'N/A')\n","    avg_util_change = format_market_note_change(market_notes.get('avg_util_change', 0))\n","\n","    headlines_html = \"\"\n","    for headline in content.get('headlines', []):\n","        headlines_html += f\"\"\"\n","        <div style=\"margin-top:20px;\">\n","            <strong style=\"font-size:16px;\">{headline['title']}</strong>\n","            <p style=\"margin:5px 0 0;\">{headline['description']}</p>\n","            <ul style=\"margin:10px 0 0; padding-left:20px; color:#334155; list-style-type: disc;\">\n","              <li><strong>What Our Data Shows:</strong> {headline['data_insight']}</li>\n","            </ul>\n","        </div>\n","        \"\"\"\n","\n","    takeaways_html = \"\".join([f\"<li>{item}</li>\" for item in takeaways])\n","\n","    # Corrected HTML structure with Key Takeaways before the tables\n","    html_template = f\"\"\"\n","<!DOCTYPE html>\n","<html lang=\"en\">\n","<head>\n","  <meta charset=\"UTF-8\">\n","  <title>EquiLend D&A Daily Digest - {datetime.now().strftime('%B %d, %Y')}</title>\n","</head>\n","<body style=\"margin:0; padding:0; font-family: Arial, sans-serif; background-color:#f1f5f9;\">\n","  <table width=\"100%\" cellpadding=\"0\" cellspacing=\"0\" border=\"0\" bgcolor=\"#f1f5f9\">\n","    <tr>\n","      <td align=\"center\">\n","        <table width=\"800\" cellpadding=\"0\" cellspacing=\"0\" border=\"0\" bgcolor=\"#ffffff\" style=\"margin:20px 0; border-radius:4px; overflow:hidden;\">\n","          <!-- Header -->\n","          <tr>\n","            <td bgcolor=\"#0284c7\" style=\"padding:20px; text-align:center;\">\n","              <h1 style=\"margin:0; font-size:24px; color:#ffffff;\">EquiLend D&amp;A Daily Digest</h1>\n","              <p style=\"margin:5px 0 0; font-size:16px; color:#bae6fd;\">{datetime.now().strftime('%B %d, %Y')}</p>\n","            </td>\n","          </tr>\n","          <!-- Content -->\n","          <tr>\n","            <td style=\"padding:20px; color:#333333; font-size:14px; line-height:1.5;\">\n","\n","              <!-- Market Notes -->\n","              <h2 style=\"font-size:18px; margin-bottom:10px;\">&#x1F4BC; Market Notes</h2>\n","              <table width=\"100%\" cellpadding=\"5\" cellspacing=\"0\" border=\"0\" bgcolor=\"#f8fafc\" style=\"margin-bottom:20px;\">\n","                <tr>\n","                  <td align=\"center\">\n","                    <p style=\"margin:0; font-size:12px; color:#64748b;\">Average Fee</p>\n","                    <p style=\"margin:5px 0 0; font-size:18px; font-weight:bold; color:#334155;\">\n","                      {avg_fee_bps} bps {avg_fee_change}\n","                    </p>\n","                  </td>\n","                  <td align=\"center\">\n","                    <p style=\"margin:0; font-size:12px; color:#64748b;\">Average Utilization</p>\n","                    <p style=\"margin:5px 0 0; font-size:18px; font-weight:bold; color:#334155;\">\n","                      {avg_util_percent}% {avg_util_change}\n","                    </p>\n","                  </td>\n","                </tr>\n","              </table>\n","\n","              <!-- Headlines -->\n","              <h2 style=\"font-size:18px; margin-bottom:10px;\">&#x1F4F0; Major Headlines and What Our Data Shows</h2>\n","              {headlines_html}\n","\n","              <!-- Key Takeaways -->\n","              <h2 style=\"font-size:18px; margin:20px 0 10px;\">&#x1F4A1; Key Takeaways</h2>\n","              <ul style=\"padding-left:20px; color:#334155; font-size:14px; margin:0;\">\n","                {takeaways_html}\n","              </ul>\n","\n","              <!-- Tables Section -->\n","              <h2 style=\"font-size:18px; margin:20px 0 10px;\">&#x1F4B6; Today's Specials and Hard-to-Borrow</h2>\n","              <table cellpadding=\"0\" cellspacing=\"0\" border=\"1\" style=\"border-collapse:collapse; margin-bottom:20px; border-color:#dddddd; font-size:12px;\" width=\"100%\">\n","                <thead>\n","                  <tr bgcolor=\"#0284c7\" style=\"color:#ffffff; font-weight:bold; text-align:left;\">\n","                    <th style=\"padding:5px 8px;\">Ticker</th>\n","                    <th style=\"padding:5px 8px;\">Name</th>\n","                    <th style=\"padding:5px 8px;\">Industry</th>\n","                    <th style=\"padding:5px 8px;\">Fee (BPS)</th>\n","                    <th style=\"padding:5px 8px;\">Momentum (WoW)</th>\n","                  </tr>\n","                </thead>\n","                <tbody>\n","                  {ht_borrow_table}\n","                </tbody>\n","              </table>\n","\n","              <h2 style=\"font-size:18px; margin:20px 0 10px;\">&#x1F52C; Market Technicals & Squeeze Metrics</h2>\n","              <table cellpadding=\"0\" cellspacing=\"0\" border=\"1\" style=\"border-collapse:collapse; border-color:#dddddd; font-size:12px;\" width=\"100%\">\n","                <thead>\n","                  <tr bgcolor=\"#0284c7\" style=\"color:#ffffff; font-weight:bold; text-align:left;\">\n","                    <th style=\"padding:5px 8px;\">Ticker</th>\n","                    <th style=\"padding:5px 8px;\">Company Name</th>\n","                    <th style=\"padding:5px 8px;\">Industry</th>\n","                    <th style=\"padding:5px 8px;\">Price</th>\n","                    <th style=\"padding:5px 8px;\">Short Squeeze Score</th>\n","                    <th style=\"padding:5px 8px;\">Score (WoW)</th>\n","                  </tr>\n","                </thead>\n","                <tbody>\n","                  {squeeze_table}\n","                </tbody>\n","              </table>\n","\n","            </td>\n","          </tr>\n","          <!-- Footer -->\n","          <tr>\n","            <td align=\"center\" style=\"padding:10px; font-size:12px; color:#64748b;\">\n","              Source: EquiLend Data &amp; Analytics\n","            </td>\n","          </tr>\n","        </table>\n","      </td>\n","    </tr>\n","  </table>\n","</body>\n","</html>\n","    \"\"\"\n","    return html_template\n","\n","# --- Main Execution ---\n","if __name__ == \"__main__\":\n","    print(\"Starting daily digest generation...\")\n","\n","    # 1. Parse content from the Word document\n","    print(f\"Reading content from '{CONTENT_DOC_PATH}'...\")\n","    parsed_content = parse_daily_content(CONTENT_DOC_PATH)\n","\n","    # 2. Generate Key Takeaways from the parsed headlines\n","    print(\"Generating key takeaways...\")\n","    key_takeaways = generate_key_takeaways(parsed_content.get('headlines', []))\n","\n","    # 3. Parse data from the CSV and generate HTML tables\n","    print(f\"Reading tables from '{TABLES_CSV_PATH}'...\")\n","    table_html = parse_tables_to_html(TABLES_CSV_PATH)\n","\n","    # 4. Generate the final HTML file\n","    print(\"Generating final HTML digest...\")\n","    final_html = create_digest_html(parsed_content, table_html, key_takeaways)\n","\n","    # 5. Save the HTML to a file\n","    with open(OUTPUT_HTML_PATH, 'w', encoding='utf-8') as f:\n","        f.write(final_html)\n","\n","    print(f\"\\nSuccessfully generated digest: {OUTPUT_HTML_PATH}\")\n","    if not parsed_content.get('headlines'):\n","        print(\"\\nWARNING: No headlines were parsed. Please check the 'Major Headlines' section in your .docx file for correct formatting.\")\n","    if not table_html[0] or not table_html[1]:\n","        print(\"WARNING: One or both data tables are empty. Please check your .csv file for content and formatting (ensure a blank line separates the two tables).\")"],"outputs":[{"output_type":"stream","name":"stdout","text":["Starting daily digest generation...\n","Reading content from 'daily_content.docx'...\n","Warning: Could not parse Headlines. Check document structure. Error: 'Major Headlines & What Our Data Shows :' is not in list\n","Generating key takeaways...\n","Reading tables from 'DailyDD_2025-07-21_bsheehan_adhoc.csv'...\n","FATAL: CSV file not found at 'DailyDD_2025-07-21_bsheehan_adhoc.csv'. Tables will be empty.\n","Generating final HTML digest...\n","\n","Successfully generated digest: equilend_daily_digest_2025_07_21.html\n","\n","WARNING: No headlines were parsed. Please check the 'Major Headlines' section in your .docx file for correct formatting.\n","WARNING: One or both data tables are empty. Please check your .csv file for content and formatting (ensure a blank line separates the two tables).\n"]}],"execution_count":3,"metadata":{"colab":{"base_uri":"https://localhost:8080/"},"id":"nxT8g8Uogo0A","executionInfo":{"status":"ok","timestamp":1753093463056,"user_tz":240,"elapsed":63,"user":{"displayName":"Bob Sheehan","userId":"08159093702253523584"}},"outputId":"35723e93-33c2-4995-a7fb-d8c70a113de9"}},{"cell_type":"code","source":["pip install python-docx\n"],"metadata":{"colab":{"base_uri":"https://localhost:8080/"},"id":"2kixl9JpgrLo","executionInfo":{"status":"ok","timestamp":1753093445127,"user_tz":240,"elapsed":9367,"user":{"displayName":"Bob Sheehan","userId":"08159093702253523584"}},"outputId":"3f904c04-c5bd-452b-9b1d-f3d84be7bd1b"},"execution_count":1,"outputs":[{"output_type":"stream","name":"stdout","text":["Collecting python-docx\n","  Downloading python_docx-1.2.0-py3-none-any.whl.metadata (2.0 kB)\n","Requirement already satisfied: lxml>=3.1.0 in /usr/local/lib/python3.11/dist-packages (from python-docx) (5.4.0)\n","Requirement already satisfied: typing_extensions>=4.9.0 in /usr/local/lib/python3.11/dist-packages (from python-docx) (4.14.1)\n","Downloading python_docx-1.2.0-py3-none-any.whl (252 kB)\n","\u001b[?25l   \u001b[90m━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\u001b[0m \u001b[32m0.0/253.0 kB\u001b[0m \u001b[31m?\u001b[0m eta \u001b[36m-:--:--\u001b[0m\r\u001b[2K   \u001b[91m━━━━━━━━━━━━━━━━━━━━━━━━━━━\u001b[0m\u001b[91m╸\u001b[0m\u001b[90m━━━━━━━━━━━━\u001b[0m \u001b[32m174.1/253.0 kB\u001b[0m \u001b[31m5.8 MB/s\u001b[0m eta \u001b[36m0:00:01\u001b[0m\r\u001b[2K   \u001b[90m━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\u001b[0m \u001b[32m253.0/253.0 kB\u001b[0m \u001b[31m5.4 MB/s\u001b[0m eta \u001b[36m0:00:00\u001b[0m\n","\u001b[?25hInstalling collected packages: python-docx\n","Successfully installed python-docx-1.2.0\n"]}]}],"metadata":{"colab":{"provenance":[]},"kernelspec":{"display_name":"Python 3","name":"python3"}},"nbformat":4,"nbformat_minor":0}