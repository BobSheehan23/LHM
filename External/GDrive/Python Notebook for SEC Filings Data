{"cells":[{"cell_type":"code","source":["#\n","# SEC Filings Data: Institutional Holdings\n","#\n","# This notebook demonstrates how to programmatically access and analyze\n","# SEC Form 13F and N-PORT data using Python.\n","#\n","# Author: Bob Sheehan, CFA, CMT\n","# Date: {Current Date}\n","#\n","# This script uses the SEC's public API to retrieve institutional holdings data.\n","# It is designed to be run in a Jupyter or Colab notebook environment.\n","#\n","# Disclaimer: The SEC has \"Fair Access\" rules that limit the number of requests\n","# you can make. The code includes a delay to adhere to these guidelines.\n","#\n","\n","import requests\n","import pandas as pd\n","import time\n","from xml.etree import ElementTree as ET\n","\n","# --- Configuration ---\n","# You must provide a User-Agent string to access the SEC API.\n","# The SEC requires you to identify yourself to avoid being blocked.\n","# Use your name and a professional email.\n","HEADERS = {'User-Agent': 'Lighthouse Macro bsheehan@equilend.com'}\n","\n","# The name of the institutional investor (filer) you want to analyze.\n","FILER_NAME = \"Berkshire Hathaway Inc\"\n","\n","# The ticker of the stock you are interested in.\n","STOCK_TICKER = \"AAPL\"\n","\n","# --- Step 1: Find the CIK for the Filer ---\n","# The SEC API primarily uses CIKs to identify filers. We need to convert\n","# the company name to its corresponding CIK.\n","\n","def get_cik(company_name):\n","    \"\"\"\n","    Retrieves the CIK for a given company name from the SEC's CIK lookup service.\n","\n","    Args:\n","        company_name (str): The name of the company or institutional investor.\n","\n","    Returns:\n","        str: The CIK as a 10-digit string, or None if not found.\n","    \"\"\"\n","    search_url = f\"https://www.sec.gov/cgi-bin/browse-edgar?company={company_name}&owner=exclude&action=getcompany\"\n","    response = requests.get(search_url, headers=HEADERS)\n","\n","    if response.status_code != 200:\n","        print(f\"Error fetching CIK for {company_name}. Status code: {response.status_code}\")\n","        return None\n","\n","    # We can parse the CIK directly from the search result URL.\n","    # The CIK is a 10-digit number.\n","    cik_str = response.url.split('CIK=')[-1].split('&')[0]\n","\n","    # Ensure the CIK is a valid 10-digit string.\n","    if cik_str.isdigit() and len(cik_str) <= 10:\n","        # Pad with leading zeros if necessary to make it 10 digits\n","        return cik_str.zfill(10)\n","\n","    return None\n","\n","# Get the CIK for the filer.\n","print(f\"Finding CIK for '{FILER_NAME}'...\")\n","FILER_CIK = get_cik(FILER_NAME)\n","\n","if FILER_CIK:\n","    print(f\"Found CIK: {FILER_CIK}\")\n","else:\n","    print(f\"Could not find CIK for '{FILER_NAME}'. Please check the name.\")\n","    # Do not raise an error if CIK is not found, just exit gracefully.\n","    exit()\n","\n","# --- Step 2: Get a list of the Filer's 13F and N-PORT filings ---\n","# We'll use the CIK to get the filer's submission history.\n","# The SEC provides a JSON API for this.\n","\n","def get_filing_urls(cik):\n","    \"\"\"\n","    Retrieves the URLs for the latest 13F-HR and NPORT-P filings for a given CIK.\n","\n","    Args:\n","        cik (str): The CIK of the institutional investor.\n","\n","    Returns:\n","        dict: A dictionary with filing types as keys and a list of filing URLs as values.\n","    \"\"\"\n","    filing_urls = {'13F-HR': [], 'NPORT-P': []}\n","    submissions_url = f\"https://data.sec.gov/submissions/CIK{cik}.json\"\n","\n","    try:\n","        response = requests.get(submissions_url, headers=HEADERS)\n","        response.raise_for_status() # Raise an exception for bad status codes\n","\n","        data = response.json()\n","\n","        # Check if there are filings\n","        if 'filings' not in data or 'recent' not in data['filings']:\n","            print(f\"No filings found for CIK {cik}.\")\n","            return filing_urls\n","\n","        filings = data['filings']['recent']\n","\n","        for i in range(len(filings['form'])):\n","            form_type = filings['form'][i]\n","            if form_type in ['13F-HR', 'NPORT-P']:\n","                accession_number = filings['accessionNumber'][i].replace('-', '')\n","                file_number = filings['accessionNumber'][i].replace('-', '')\n","\n","                # Construct the filing URL from the accession number and CIK\n","                # The SEC has a predictable URL structure.\n","                base_url = f\"https://www.sec.gov/Archives/edgar/data/{cik}/{file_number}/{accession_number}\"\n","\n","                # For 13F, the file is usually an XML. For NPORT-P, it can be a JSON.\n","                # We'll try to guess the file name based on common patterns.\n","                if form_type == '13F-HR':\n","                    filing_urls['13F-HR'].append(f\"{base_url}.xml\")\n","                elif form_type == 'NPORT-P':\n","                    # NPORT-P filings have a specific naming convention\n","                    filing_urls['NPORT-P'].append(f\"{base_url}.json\")\n","\n","                # Adding a delay to be a good neighbor to the SEC's servers\n","                time.sleep(0.5)\n","\n","    except requests.exceptions.RequestException as e:\n","        print(f\"Error fetching submissions for CIK {cik}: {e}\")\n","\n","    return filing_urls\n","\n","# Get the filings. We will only look at the most recent filing for simplicity.\n","print(\"\\nRetrieving the latest filings...\")\n","FILING_URLS = get_filing_urls(FILER_CIK)\n","\n","latest_13f_url = FILING_URLS['13F-HR'][0] if FILING_URLS['13F-HR'] else None\n","latest_nport_url = FILING_URLS['NPORT-P'][0] if FILING_URLS['NPORT-P'] else None\n","\n","if latest_13f_url:\n","    print(f\"Latest 13F-HR URL: {latest_13f_url}\")\n","if latest_nport_url:\n","    print(f\"Latest NPORT-P URL: {latest_nport_url}\")\n","if not latest_13f_url and not latest_nport_url:\n","    print(\"No recent 13F or NPORT filings found.\")\n","\n","# --- Step 3: Parse the filings for the specific stock ---\n","# Now we need to parse the XML or JSON data to find the holdings.\n","# We'll create a function to handle both filing types.\n","\n","def parse_holdings(url, ticker):\n","    \"\"\"\n","    Parses a filing URL (XML or JSON) for holdings of a specific ticker.\n","\n","    Args:\n","        url (str): The URL of the filing to parse.\n","        ticker (str): The stock ticker to search for.\n","\n","    Returns:\n","        dict: A dictionary containing the holding details, or an empty dict if not found.\n","    \"\"\"\n","    try:\n","        response = requests.get(url, headers=HEADERS)\n","        response.raise_for_status()\n","\n","        # Check content type to determine parsing method\n","        content_type = response.headers.get('Content-Type', '').split(';')[0]\n","\n","        holdings_data = {}\n","\n","        if 'xml' in content_type:\n","            # Parse XML for 13F-HR filings\n","            root = ET.fromstring(response.content)\n","\n","            # Find the namespace to correctly parse the XML\n","            namespace_prefix = '{http://www.sec.gov/edgar/document/thirteenf/informationtable}'\n","\n","            for info_table in root.findall(f'.//{namespace_prefix}infoTable'):\n","                for info_entry in info_table.findall(f'{namespace_prefix}infoTable'):\n","                    name_of_issuer = info_entry.find(f'{namespace_prefix}nameOfIssuer').text\n","                    # Check if the name or CIK matches the stock\n","                    if name_of_issuer.lower() == ticker.lower():\n","                        holding_info = {\n","                            'shares': info_entry.find(f'{namespace_prefix}shrsOrPrnAmt').find(f'{namespace_prefix}sshPrnamt').text,\n","                            'value': info_entry.find(f'{namespace_prefix}value').text,\n","                            'filing_type': '13F-HR'\n","                        }\n","                        holdings_data = holding_info\n","                        break\n","\n","        elif 'json' in content_type:\n","            # Parse JSON for NPORT-P filings\n","            data = response.json()\n","\n","            # NPORT-P data structure is complex, often with a nested 'holdings' list\n","            if 'list' in data and 'NPORT' in data['list'] and 'holdings' in data['list']['NPORT']:\n","                for holding in data['list']['NPORT']['holdings']:\n","                    if holding.get('ticker') and holding['ticker'].lower() == ticker.lower():\n","                        holding_info = {\n","                            'shares': holding.get('val'),\n","                            'value': holding.get('val'),\n","                            'filing_type': 'NPORT-P'\n","                        }\n","                        holdings_data = holding_info\n","                        break\n","\n","        return holdings_data\n","\n","    except requests.exceptions.RequestException as e:\n","        print(f\"Error fetching or parsing URL {url}: {e}\")\n","        return {}\n","    except ET.ParseError as e:\n","        print(f\"Error parsing XML from {url}: {e}\")\n","        return {}\n","    except ValueError as e:\n","        print(f\"Error parsing JSON from {url}: {e}\")\n","        return {}\n","    except Exception as e:\n","        print(f\"An unexpected error occurred: {e}\")\n","        return {}\n","\n","# --- Main Logic: Execute and Display Results ---\n","print(f\"\\nSearching for holdings of '{STOCK_TICKER}'...\")\n","\n","found_holdings = []\n","if latest_13f_url:\n","    holdings_13f = parse_holdings(latest_13f_url, STOCK_TICKER)\n","    if holdings_13f:\n","        found_holdings.append(holdings_13f)\n","\n","if latest_nport_url:\n","    holdings_nport = parse_holdings(latest_nport_url, STOCK_TICKER)\n","    if holdings_nport:\n","        found_holdings.append(holdings_nport)\n","\n","if not found_holdings:\n","    print(f\"No recent holdings for '{STOCK_TICKER}' found in filings from '{FILER_NAME}'.\")\n","else:\n","    # Create a DataFrame to display the results clearly\n","    df = pd.DataFrame(found_holdings)\n","    print(\"\\n--- Institutional Holdings Data ---\")\n","    print(df)"],"outputs":[{"output_type":"stream","name":"stdout","text":["Finding CIK for 'Berkshire Hathaway Inc'...\n","Could not find CIK for 'Berkshire Hathaway Inc'. Please check the name.\n","\n","Retrieving the latest filings...\n","Error fetching submissions for CIK None: 404 Client Error: Not Found for url: https://data.sec.gov/submissions/CIKNone.json\n","No recent 13F or NPORT filings found.\n","\n","Searching for holdings of 'AAPL'...\n","No recent holdings for 'AAPL' found in filings from 'Berkshire Hathaway Inc'.\n"]}],"execution_count":2,"metadata":{"colab":{"base_uri":"https://localhost:8080/"},"id":"DZBVvbBIcGf7","executionInfo":{"status":"ok","timestamp":1755111860750,"user_tz":240,"elapsed":896,"user":{"displayName":"Bob Sheehan","userId":"08159093702253523584"}},"outputId":"d65fa51c-39d3-418d-dcb2-bd2638edbab9"}}],"metadata":{"colab":{"provenance":[]},"kernelspec":{"display_name":"Python 3","name":"python3"}},"nbformat":4,"nbformat_minor":0}