{"cells":[{"cell_type":"code","source":"# -*- coding: utf-8 -*-\n\"\"\"\ndaily_digest_generator.py\n\nThis script dynamically generates a daily HTML digest. It primarily parses content\nfrom a single Word document. As a redundancy, if it fails to parse the data\ntables from Word, or if the Word document is invalid, it will fall back to \nparsing them from specified Excel files.\n\nTo run:\n1. Make sure 'daily_content.docx' is in the same directory.\n2. For the fallback, ensure 'fee_table.xlsx' and 'squeeze_table.xlsx' are also present.\n3. Install required libraries: pip install python-docx pandas openpyxl\n4. Run the script from your terminal: python daily_digest_generator.py\n\"\"\"\n\nimport pandas as pd\nimport docx\nfrom datetime import datetime\nimport re\nimport os\n\n# --- Configuration ---\nCONTENT_DOC_PATH = 'daily_content.docx'\n# Excel files are used as a fallback if tables are not found in the Word doc\nFEE_TABLE_XLSX_PATH = 'fee_table.xlsx'\nSQUEEZE_TABLE_XLSX_PATH = 'squeeze_table.xlsx'\nOUTPUT_HTML_PATH = f\"equilend_daily_digest_{datetime.now().strftime('%Y_%m_%d')}.html\"\n\n# --- 1. Data Parsing ---\n\ndef parse_tables_from_excel(fee_path, squeeze_path):\n    \"\"\"\n    Parses the 'Hot & Getting Hotter' and 'Squeeze Metrics' tables from\n    their respective Excel files. This function serves as a fallback.\n    \"\"\"\n    hot_stocks_data = []\n    squeeze_stocks_data = []\n\n    # Parse Fee Table (Hot & Getting Hotter)\n    try:\n        if os.path.exists(fee_path):\n            fee_df = pd.read_excel(fee_path)\n            # Standardize column names to match what the HTML generator expects\n            fee_df.rename(columns={\n                'TICKER': 'ticker',\n                'Security Description': 'company_name',\n                'Industry': 'industry',\n                'Security Price (USD)': 'price',\n                'Fee 1 Week Diff (BPS)': 'fee_1_wow_bps'\n            }, inplace=True, errors='ignore')\n            hot_stocks_data = fee_df.to_dict('records')\n        else:\n            print(f\"Info: Fallback Excel file not found: {fee_path}\")\n    except Exception as e:\n        print(f\"Error parsing fallback fee table Excel: {e}\")\n\n    # Parse Squeeze Table\n    try:\n        if os.path.exists(squeeze_path):\n            squeeze_df = pd.read_excel(squeeze_path)\n            # Standardize column names\n            squeeze_df.rename(columns={\n                'TICKER': 'ticker',\n                'Security Description': 'company_name',\n                'Industry': 'industry',\n                'Price': 'price',\n                'Short Squeeze Score (SSS)': 'short_squeeze_score_sss',\n                'SSS WoW': 'sss_wow'\n            }, inplace=True, errors='ignore')\n            squeeze_stocks_data = squeeze_df.to_dict('records')\n        else:\n            print(f\"Info: Fallback Excel file not found: {squeeze_path}\")\n    except Exception as e:\n        print(f\"Error parsing fallback squeeze table Excel: {e}\")\n\n    return hot_stocks_data, squeeze_stocks_data\n\n\ndef parse_daily_content(doc_path):\n    \"\"\"\n    Parses a .docx file for text and table content. It's the primary source.\n    \"\"\"\n    content = {\n        'market_notes': {}, 'headlines': [], 'key_takeaways': [],\n        'hot_stocks_data': [], 'squeeze_stocks_data': []\n    }\n    \n    # --- NEW: Improved error handling for invalid .docx files ---\n    try:\n        document = docx.Document(doc_path)\n    except Exception as e:\n        print(f\"WARNING: Could not parse '{doc_path}'. It may be corrupted or not a true .docx file.\")\n        print(f\"         Error details: {e}\")\n        print(\"         The script will attempt to proceed using Excel fallbacks for table data.\")\n        # Return a partially empty content dict to allow fallback to proceed\n        return content\n\n    # --- Parse All Tables First ---\n    for table in document.tables:\n        if not table.rows: continue\n        header_cells = [cell.text.strip().lower() for cell in table.rows[0].cells]\n\n        if any('average fee' in h for h in header_cells):\n            try:\n                for row in table.rows:\n                    row_text = [cell.text.strip() for cell in row.cells]\n                    for i in range(0, len(row_text), 3):\n                        if i + 2 < len(row_text):\n                            metric, value, change_str = row_text[i].lower(), row_text[i+1], row_text[i+2]\n                            change_match = re.search(r'([+-]?\\d+\\.?\\d*)', change_str)\n                            change = float(change_match.group(1)) if change_match else 0.0\n                            if 'average fee' in metric: content['market_notes']['avg_fee_bps'] = value.replace('bps', '').strip(); content['market_notes']['avg_fee_change'] = change\n                            elif 'average utilization' in metric: content['market_notes']['avg_util_percent'] = value.replace('%', '').strip(); content['market_notes']['avg_util_change'] = change\n                            elif 'on loan value' in metric: content['market_notes']['on_loan_value'] = value.replace('$', '').strip(); content['market_notes']['on_loan_value_change'] = change\n                            elif 'total lendable value' in metric: content['market_notes']['lendable_value'] = value.replace('$', '').strip(); content['market_notes']['lendable_value_change'] = change\n            except Exception as e:\n                print(f\"Warning: Could not parse Market Notes from table. Error: {e}\")\n            continue\n\n        if 'fee 1 wow (bps)' in header_cells:\n            keys = ['ticker', 'company_name', 'industry', 'price', 'fee_1_wow_bps']\n            for row in table.rows[1:]:\n                row_data = {keys[i]: cell.text.strip() for i, cell in enumerate(row.cells)}\n                content['hot_stocks_data'].append(row_data)\n            continue\n\n        if 'short squeeze score (sss)' in header_cells:\n            keys = ['ticker', 'company_name', 'industry', 'price', 'short_squeeze_score_sss', 'sss_wow']\n            for row in table.rows[1:]:\n                row_data = {keys[i]: cell.text.strip() for i, cell in enumerate(row.cells)}\n                content['squeeze_stocks_data'].append(row_data)\n            continue\n\n    # --- Parse Paragraphs for Text Content ---\n    paras = [p.text.strip() for p in document.paragraphs if p.text.strip()]\n    current_section = None\n    current_headline = {}\n    for p_text in paras:\n        p_lower = p_text.lower()\n        if 'major headlines' in p_lower: current_section = 'headlines'; continue\n        elif 'key takeaways' in p_lower: current_section = 'takeaways'; continue\n        elif any(x in p_lower for x in ['market notes', 'hot & getting hotter', 'market technicals']): current_section = None; continue\n\n        if current_section == 'headlines':\n            if 'what our data shows:' in p_lower:\n                current_headline['data_insight'] = re.sub(r'what our data shows:\\s?', '', p_text, flags=re.I).strip()\n                if current_headline.get('title'): content['headlines'].append(current_headline); current_headline = {}\n            elif not current_headline.get('title'):\n                current_headline['title'] = p_text; current_headline['description'] = []\n            else: current_headline['description'].append(p_text)\n        elif current_section == 'takeaways': content['key_takeaways'].append(p_text.lstrip('-â€¢* ').strip())\n    if current_headline.get('title'): content['headlines'].append(current_headline) # Save last headline\n\n    for h in content['headlines']:\n        if isinstance(h.get('description'), list): h['description'] = \"\\n\".join(h['description'])\n\n    return content\n\n\n# --- 2. HTML Generation ---\n\ndef create_digest_html(content):\n    \"\"\"\n    Generates the final HTML for the digest, now with compact table styling.\n    \"\"\"\n    if not content or (not content.get('headlines') and not content.get('hot_stocks_data')):\n        return \"<h1>Error: Could not generate digest. No content found in Word or Excel sources.</h1>\"\n\n    def format_change(value, unit=' BPS', dec=0):\n        try:\n            val = float(str(value).replace(',', '').strip())\n            color = '#16a34a' if val > 0 else '#dc2626'\n            sign = '+' if val > 0 else ''\n            return f'<span style=\"color:{color}; font-weight:500;\">{sign}{val:,.{dec}f}{unit}</span>'\n        except (ValueError, TypeError):\n            return str(value).strip() if pd.notna(value) else ''\n\n    def format_market_note_change(value):\n        color = '#16a34a' if value >= 0 else '#dc2626'\n        sign = '+' if value >= 0 else ''\n        return f'<span style=\"color:{color}; font-size:14px; font-weight:500;\">{sign}{value:.2f}%</span>'\n\n    market_notes = content.get('market_notes', {})\n    avg_fee_change = format_market_note_change(market_notes.get('avg_fee_change', 0))\n    avg_util_change = format_market_note_change(market_notes.get('avg_util_change', 0))\n    on_loan_change = format_market_note_change(market_notes.get('on_loan_value_change', 0))\n    lendable_change = format_market_note_change(market_notes.get('lendable_value_change', 0))\n\n    headlines_html = \"\".join([f\"\"\"\n    <div style=\"margin-top:20px;\">\n        <strong style=\"font-size:16px; color:#1e3a8a;\">{h['title']}</strong>\n        <p style=\"margin:5px 0 0; white-space: pre-wrap; line-height:1.6;\">{h.get('description', '')}</p>\n        <div style=\"margin:12px 0 0; padding:12px; background-color:#f0f9ff; border-left: 3px solid #0284c7; border-radius: 0 4px 4px 0;\">\n          <strong style=\"color:#0284c7;\">What Our Data Shows:</strong> {h.get('data_insight', 'N/A')}\n        </div>\n    </div>\"\"\" for h in content.get('headlines', [])])\n\n    ht_borrow_html = \"\".join([f\"\"\"\n    <tr style=\"font-size:12px; background-color:#ffffff; text-align:left;\">\n        <td style=\"padding:4px 8px; border:1px solid #e2e8f0;\">{r.get(\"ticker\", \"\")}</td>\n        <td style=\"padding:4px 8px; border:1px solid #e2e8f0;\">{r.get(\"company_name\", \"\")}</td>\n        <td style=\"padding:4px 8px; border:1px solid #e2e8f0;\">{r.get(\"industry\", \"\")}</td>\n        <td style=\"padding:4px 8px; border:1px solid #e2e8f0;\">${str(r.get(\"price\", \"\")).replace('$', '')}</td>\n        <td style=\"padding:4px 8px; border:1px solid #e2e8f0;\">{format_change(r.get(\"fee_1_wow_bps\", \"\"))}</td>\n    </tr>\"\"\" for r in content.get('hot_stocks_data', [])])\n\n    squeeze_html = \"\".join([f\"\"\"\n    <tr style=\"font-size:12px; background-color:#ffffff; text-align:left;\">\n        <td style=\"padding:4px 8px; border:1px solid #e2e8f0;\">{r.get(\"ticker\", \"\")}</td>\n        <td style=\"padding:4px 8px; border:1px solid #e2e8f0;\">{r.get(\"company_name\", \"\")}</td>\n        <td style=\"padding:4px 8px; border:1px solid #e2e8f0;\">{r.get(\"industry\", \"\")}</td>\n        <td style=\"padding:4px 8px; border:1px solid #e2e8f0;\">${str(r.get(\"price\", \"\")).replace('$', '')}</td>\n        <td style=\"padding:4px 8px; border:1px solid #e2e8f0;\">{r.get(\"short_squeeze_score_sss\", \"\")}</td>\n        <td style=\"padding:4px 8px; border:1px solid #e2e8f0;\">{format_change(r.get(\"sss_wow\", \"\"), unit=\"\", dec=0)}</td>\n    </tr>\"\"\" for r in content.get('squeeze_stocks_data', [])])\n\n    takeaways_html = \"\".join([f'<li style=\"margin-bottom:8px;\">{item}</li>' for item in content.get('key_takeaways', [])])\n\n    html_template = f\"\"\"\n<!DOCTYPE html>\n<html lang=\"en\">\n<head>\n  <meta charset=\"UTF-8\">\n  <title>EquiLend D&A Daily Digest - {datetime.now().strftime('%B %d, %Y')}</title>\n</head>\n<body style=\"margin:0; padding:0; font-family: Arial, sans-serif; background-color:#f1f5f9;\">\n  <table width=\"100%\" cellpadding=\"0\" cellspacing=\"0\" border=\"0\" bgcolor=\"#f1f5f9\">\n    <tr><td align=\"center\">\n    <table width=\"800\" cellpadding=\"0\" cellspacing=\"0\" border=\"0\" bgcolor=\"#ffffff\" style=\"margin:20px 0; border-radius:8px; overflow:hidden; border: 1px solid #e2e8f0;\">\n      <tr><td bgcolor=\"#0c4a6e\" style=\"padding:20px; text-align:center;\">\n          <h1 style=\"margin:0; font-size:24px; color:#ffffff; font-weight:600;\">EquiLend D&A Daily Digest</h1>\n          <p style=\"margin:5px 0 0; font-size:16px; color:#bae6fd;\">{datetime.now().strftime('%B %d, %Y')}</p>\n      </td></tr>\n      <tr><td style=\"padding:24px; color:#334155; font-size:14px; line-height:1.6;\">\n          <h2 style=\"font-size:18px; margin:0 0 12px; color:#0c4a6e; border-bottom: 2px solid #f1f5f9; padding-bottom: 8px;\">&#x1F4BC; Market Notes</h2>\n          <table width=\"100%\" cellpadding=\"8\" cellspacing=\"0\" border=\"0\" bgcolor=\"#f8fafc\" style=\"margin-bottom:25px; border-radius:6px;\">\n            <tr>\n              <td align=\"center\" width=\"50%\"><p style=\"margin:0; font-size:12px; color:#64748b;\">Average Fee</p><p style=\"margin:5px 0 0; font-size:18px; font-weight:bold;\">{market_notes.get('avg_fee_bps', 'N/A')} bps {avg_fee_change}</p></td>\n              <td align=\"center\" width=\"50%\"><p style=\"margin:0; font-size:12px; color:#64748b;\">Average Utilization</p><p style=\"margin:5px 0 0; font-size:18px; font-weight:bold;\">{market_notes.get('avg_util_percent', 'N/A')}% {avg_util_change}</p></td>\n            </tr>\n            <tr>\n              <td align=\"center\" width=\"50%\"><p style=\"margin:0; font-size:12px; color:#64748b;\">On Loan Value</p><p style=\"margin:5px 0 0; font-size:18px; font-weight:bold;\">${market_notes.get('on_loan_value', 'N/A')} {on_loan_change}</p></td>\n              <td align=\"center\" width=\"50%\"><p style=\"margin:0; font-size:12px; color:#64748b;\">Total Lendable Value</p><p style=\"margin:5px 0 0; font-size:18px; font-weight:bold;\">${market_notes.get('lendable_value', 'N/A')} {lendable_change}</p></td>\n            </tr>\n          </table>\n          <h2 style=\"font-size:18px; margin:0 0 10px; color:#0c4a6e; border-bottom: 2px solid #f1f5f9; padding-bottom: 8px;\">&#x1F4F0; Major Headlines</h2>\n          {headlines_html}\n          <h2 style=\"font-size:18px; margin:25px 0 10px; color:#0c4a6e; border-bottom: 2px solid #f1f5f9; padding-bottom: 8px;\">&#x1F525; Hot & Getting Hotter</h2>\n          <div style=\"font-size:12px; font-style:italic; color:#64748b; margin-bottom:10px;\">Top stocks with high and rising fees, indicating increased short interest.</div>\n          <table cellpadding=\"0\" cellspacing=\"0\" style=\"border-collapse:collapse; font-size:12px;\" width=\"100%\">\n            <thead><tr bgcolor=\"#f1f5f9\" style=\"color:#334155; font-weight:bold; text-align:left;\">\n                <th style=\"padding:4px 8px; border:1px solid #e2e8f0;\">Ticker</th><th style=\"padding:4px 8px; border:1px solid #e2e8f0;\">Company</th><th style=\"padding:4px 8px; border:1px solid #e2e8f0;\">Industry</th><th style=\"padding:4px 8px; border:1px solid #e2e8f0;\">Price</th><th style=\"padding:4px 8px; border:1px solid #e2e8f0;\">Fee 1W Change</th>\n            </tr></thead>\n            <tbody>{ht_borrow_html}</tbody>\n          </table>\n          <h2 style=\"font-size:18px; margin:25px 0 10px; color:#0c4a6e; border-bottom: 2px solid #f1f5f9; padding-bottom: 8px;\">&#x1F52C; Market Technicals & Squeeze Metrics</h2>\n          <table cellpadding=\"0\" cellspacing=\"0\" style=\"border-collapse:collapse; font-size:12px;\" width=\"100%\">\n            <thead><tr bgcolor=\"#f1f5f9\" style=\"color:#334155; font-weight:bold; text-align:left;\">\n                <th style=\"padding:4px 8px; border:1px solid #e2e8f0;\">Ticker</th><th style=\"padding:4px 8px; border:1px solid #e2e8f0;\">Company</th><th style=\"padding:4px 8px; border:1px solid #e2e8f0;\">Industry</th><th style=\"padding:4px 8px; border:1px solid #e2e8f0;\">Price</th><th style=\"padding:4px 8px; border:1px solid #e2e8f0;\">SSS</th><th style=\"padding:4px 8px; border:1px solid #e2e8f0;\">SSS WoW</th>\n            </tr></thead>\n            <tbody>{squeeze_html}</tbody>\n          </table>\n          <h2 style=\"font-size:18px; margin:25px 0 10px; color:#0c4a6e; border-bottom: 2px solid #f1f5f9; padding-bottom: 8px;\">&#x1F4A1; Key Takeaways</h2>\n          <ul style=\"padding-left:20px; color:#334155; font-size:14px; margin:0; list-style-type:disc;\">{takeaways_html}</ul>\n      </td></tr>\n      <tr><td align=\"center\" style=\"padding:15px; font-size:12px; color:#64748b; background-color:#f8fafc; border-top: 1px solid #e2e8f0;\">\n          Source: EquiLend Data &amp; Analytics\n      </td></tr>\n    </table>\n    </td></tr>\n  </table>\n</body>\n</html>\n    \"\"\"\n    return html_template\n\n# --- Main Execution ---\nif __name__ == \"__main__\":\n    print(\"Starting daily digest generation...\")\n\n    # 1. Primary attempt: Parse all content from the Word document\n    print(f\"Reading content from primary source: '{CONTENT_DOC_PATH}'...\")\n    parsed_content = parse_daily_content(CONTENT_DOC_PATH)\n\n    # 2. Redundancy Check: If data tables are empty after parsing docx, try the Excel fallback\n    if not parsed_content.get('hot_stocks_data') or not parsed_content.get('squeeze_stocks_data'):\n        print(\"\\nPrimary source parsing incomplete for tables. Attempting Excel fallback...\")\n        hot_stocks_excel, squeeze_stocks_excel = parse_tables_from_excel(FEE_TABLE_XLSX_PATH, SQUEEZE_TABLE_XLSX_PATH)\n        \n        # Populate with excel data only if the original is empty\n        if not parsed_content.get('hot_stocks_data') and hot_stocks_excel:\n            parsed_content['hot_stocks_data'] = hot_stocks_excel\n            print(f\"-> Successfully loaded 'Hot & Getting Hotter' from '{FEE_TABLE_XLSX_PATH}'\")\n\n        if not parsed_content.get('squeeze_stocks_data') and squeeze_stocks_excel:\n            parsed_content['squeeze_stocks_data'] = squeeze_stocks_excel\n            print(f\"-> Successfully loaded 'Squeeze Metrics' from '{SQUEEZE_TABLE_XLSX_PATH}'\")\n\n    # 3. Generate the final HTML file\n    print(\"\\nGenerating final HTML digest...\")\n    final_html = create_digest_html(parsed_content)\n\n    # 4. Save the HTML to a file\n    with open(OUTPUT_HTML_PATH, 'w', encoding='utf-8') as f:\n        f.write(final_html)\n\n    print(f\"\\nSuccessfully generated digest: {OUTPUT_HTML_PATH}\")\n    print(\"You can open this HTML file in any web browser.\")","outputs":[],"execution_count":null,"metadata":{}}],"metadata":{"colab":{"from_bard":true},"kernelspec":{"display_name":"Python 3","name":"python3"}},"nbformat":4,"nbformat_minor":0}