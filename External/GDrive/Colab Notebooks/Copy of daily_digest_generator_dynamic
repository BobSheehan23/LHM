{"cells":[{"cell_type":"code","source":["import pandas as pd\n","import docx\n","from datetime import datetime\n","import re\n","import numpy as np\n","\n","# --- Configuration ---\n","# The script will read all content from these three files.\n","# Ensure they are in the same directory as the script.\n","CONTENT_DOC_PATH = 'daily_content.docx'\n","FEE_TABLE_XLSX_PATH = '/content/fee_table.xlsx'\n","SQUEEZE_TABLE_XLSX_PATH = '/content/squeeze_table.xlsx' # Updated path to the Excel file\n","OUTPUT_HTML_PATH = f\"equilend_daily_digest_{datetime.now().strftime('%Y_%m_%d')}.html\"\n","\n","# --- 1. DOCX Content Parsing ---\n","\n","def parse_daily_content(doc_path):\n","    \"\"\"\n","    Parses the .docx file for all text content, including market notes, headlines, and key takeaways.\n","    \"\"\"\n","    try:\n","        document = docx.Document(doc_path)\n","    except Exception as e:\n","        print(f\"Error opening or parsing DOCX file: {e}\")\n","        return None\n","\n","    content = {'market_notes': {}, 'headlines': [], 'key_takeaways': []}\n","    paras = [p.text.strip() for p in document.paragraphs if p.text.strip()]\n","\n","    # --- Parse Market Notes ---\n","    try:\n","        market_notes_idx = -1\n","        for i, p_text in enumerate(paras):\n","            if 'market notes' in p_text.lower():\n","                market_notes_idx = i\n","                break\n","\n","        if market_notes_idx != -1:\n","            for i in range(market_notes_idx + 1, len(paras)):\n","                line = paras[i]\n","                if not (line.startswith('*') or line.startswith('•')): break\n","\n","                line = line.lstrip('*• ').strip()\n","                if 'Average Fee:' in line:\n","                    match = re.search(r'(\\d+\\.?\\d*)\\s*bps\\s*\\((.*)\\)', line)\n","                    if not match: # Fallback for different format\n","                        match = re.search(r'(\\d+\\.?\\d*)\\s*bps\\s*(.*)', line)\n","                    if match:\n","                        content['market_notes']['avg_fee_bps'] = match.group(1)\n","                        content['market_notes']['avg_fee_change'] = float(match.group(2).replace('%','').replace('+',''))\n","                elif 'Average Utilization:' in line:\n","                    match = re.search(r'(\\d+\\.?\\d*)%\\s*\\((.*)\\)', line)\n","                    if not match:\n","                         match = re.search(r'(\\d+\\.?\\d*)%\\s*(.*)', line)\n","                    if match:\n","                        content['market_notes']['avg_util_percent'] = match.group(1)\n","                        content['market_notes']['avg_util_change'] = float(match.group(2).replace('%','').replace('+',''))\n","                elif 'On Loan Value:' in line:\n","                    match = re.search(r'\\$(\\d+\\.?\\d*T)\\s*\\((.*)\\)', line)\n","                    if not match:\n","                        match = re.search(r'(\\d+\\.?\\d*T)\\s*(.*)', line)\n","                    if match:\n","                        content['market_notes']['on_loan_value'] = match.group(1)\n","                        content['market_notes']['on_loan_value_change'] = float(match.group(2).replace('%','').replace('+',''))\n","                elif 'Total Lendable Value:' in line:\n","                    match = re.search(r'\\$(\\d+\\.?\\d*T)\\s*\\((.*)\\)', line)\n","                    if not match:\n","                        match = re.search(r'(\\d+\\.?\\d*T)\\s*(.*)', line)\n","                    if match:\n","                        content['market_notes']['lendable_value'] = match.group(1)\n","                        content['market_notes']['lendable_value_change'] = float(match.group(2).replace('%','').replace('+',''))\n","    except Exception as e:\n","        print(f\"Warning: Could not parse Market Notes. Error: {e}\")\n","\n","    # --- Parse Headlines ---\n","    try:\n","        headline_start_index = -1\n","        for i, p_text in enumerate(paras):\n","            if 'major headlines' in p_text.lower():\n","                headline_start_index = i + 1\n","                break\n","\n","        if headline_start_index != -1:\n","            i = headline_start_index\n","            while i < len(paras):\n","                end_of_block_idx = -1\n","                # Find the next data insight line\n","                for j in range(i + 1, len(paras)):\n","                    if 'what our data shows' in paras[j].lower():\n","                        end_of_block_idx = j\n","                        break\n","\n","                if end_of_block_idx != -1:\n","                    title = paras[i].rstrip(':').rstrip('.')\n","                    description = \"\\n\".join(paras[i+1:end_of_block_idx])\n","                    data_insight_raw = paras[end_of_block_idx]\n","                    data_insight = re.sub(r'[\\starbullet\\s]*What our data shows:\\s?', '', data_insight_raw, flags=re.IGNORECASE).strip()\n","\n","                    content['headlines'].append({\n","                        'title': title,\n","                        'description': description,\n","                        'data_insight': data_insight\n","                    })\n","                    i = end_of_block_idx + 1\n","                else:\n","                    break # No more headline blocks found\n","    except Exception as e:\n","        print(f\"Warning: Could not parse Headlines. Error: {e}\")\n","\n","    # --- Parse Key Takeaways ---\n","    try:\n","        takeaways_start_index = -1\n","        for i, p_text in enumerate(paras):\n","            if 'key takeaways' in p_text.lower():\n","                takeaways_start_index = i + 1\n","                break\n","        if takeaways_start_index != -1:\n","            for i in range(takeaways_start_index, len(paras)):\n","                line = paras[i].lstrip('-•* ').strip()\n","                if not line: continue\n","                content['key_takeaways'].append(line)\n","    except Exception as e:\n","        print(f\"Warning: Could not parse Key Takeaways. Error: {e}\")\n","\n","    return content\n","\n","# --- 2. Table Parsing ---\n","\n","def parse_tables(fee_path, squeeze_path):\n","    \"\"\"\n","    Parses the fee table from an Excel file and the squeeze table from an Excel file.\n","    \"\"\"\n","    ht_borrow_html = \"\"\n","    squeeze_html = \"\"\n","\n","    def format_change(value, unit=' BPS'):\n","        try:\n","            cleaned_value = str(value).replace(',', '').strip()\n","            val = float(cleaned_value)\n","            color = '#16a34a' if val > 0 else '#dc2626'\n","            sign = '+' if val > 0 else ''\n","            return f'<span style=\"color:{color}; font-size:14px;\">{sign}{val:,.2f}{unit}</span>'\n","        except (ValueError, TypeError):\n","            return str(value).strip() if pd.notna(value) else ''\n","\n","    # --- Parse \"Hot & Getting Hotter\" Table from Excel ---\n","    try:\n","        fee_df = pd.read_excel(fee_path) # Read Excel file\n","        # Dynamically find the WoW column (could be 'Fee WoW (bps)' or 'Fee 1 Week Diff (Bps)', etc.)\n","        wow_col_fee = next((col for col in fee_df.columns if 'WoW' in col and 'Fee' in col), None)\n","        price_col_fee = next((col for col in fee_df.columns if 'Price' in col), None)\n","\n","        for _, row in fee_df.iterrows():\n","            ht_borrow_html += f\"\"\"\n","            <tr style=\"font-size:12px; background-color:#ffffff; text-align:left;\">\n","                <td style=\"padding:4px 8px;\">{row.get(\"TICKER\", \"\")}</td>\n","                <td style=\"padding:4px 8px;\">{row.get(\"Security Description\", \"\")}</td>\n","                <td style=\"padding:4px 8px;\">{row.get(\"Industry\", \"\")}</td>\n","                <td style=\"padding:4px 8px;\">{row.get(price_col_fee, \"\")}</td>\n","                <td style=\"padding:4px 8px;\">{format_change(row.get(wow_col_fee))}</td>\n","            </tr>\"\"\"\n","    except FileNotFoundError:\n","        print(f\"ERROR: Fee Table Excel not found at '{fee_path}'. Please provide the file.\")\n","    except Exception as e:\n","        print(f\"Warning: Could not parse Fee Table Excel. Error: {e}\")\n","\n","\n","    # --- Parse \"Squeeze Metrics\" Table from Excel ---\n","    try:\n","        squeeze_df = pd.read_excel(squeeze_path)\n","        wow_col_squeeze = next((col for col in squeeze_df.columns if 'WoW' in col and 'Squeeze' in col), None)\n","        price_col_squeeze = next((col for col in squeeze_df.columns if 'Price' in col), None)\n","\n","\n","        for _, row in squeeze_df.iterrows():\n","            squeeze_html += f\"\"\"\n","            <tr style=\"font-size:12px; background-color:#ffffff; text-align:left;\">\n","                <td style=\"padding:4px 8px;\">{row.get(\"TICKER\", \"\")}</td>\n","                <td style=\"padding:4px 8px;\">{row.get(\"Security Description\", \"\")}</td>\n","                <td style=\"padding:4px 8px;\">{row.get(\"Industry\", \"\")}</td>\n","                <td style=\"padding:4px 8px;\">{row.get(price_col_squeeze, \"\")}</td>\n","                <td style=\"padding:4px 8px;\">{row.get(\"Squeeze Score\", \"\")}</td>\n","                <td style=\"padding:4px 8px;\">{format_change(row.get(wow_col_squeeze), unit=\"\")}</td>\n","            </tr>\"\"\"\n","    except FileNotFoundError:\n","        print(f\"ERROR: Squeeze Table Excel not found at '{squeeze_path}'. Please provide the file.\")\n","    except Exception as e:\n","        print(f\"Warning: Could not parse Squeeze Table Excel. Error: {e}\")\n","\n","    return ht_borrow_html, squeeze_html\n","\n","# --- 3. HTML Generation ---\n","\n","def create_digest_html(content, table_html_tuple):\n","    \"\"\"\n","    Generates the final HTML for the digest by populating a template.\n","    \"\"\"\n","    if not content:\n","        return \"<h1>Error: Could not generate content.</h1>\"\n","\n","    ht_borrow_table, squeeze_table = table_html_tuple\n","\n","    def format_market_note_change(value):\n","        color = '#16a34a' if value >= 0 else '#dc2626'\n","        sign = '+' if value >= 0 else ''\n","        return f'<span style=\"color:{color}; font-size:14px;\">{sign}{value:.2f}%</span>'\n","\n","    market_notes = content.get('market_notes', {})\n","    avg_fee_bps = market_notes.get('avg_fee_bps', 'N/A')\n","    avg_fee_change = format_market_note_change(market_notes.get('avg_fee_change', 0))\n","    avg_util_percent = market_notes.get('avg_util_percent', 'N/A')\n","    avg_util_change = format_market_note_change(market_notes.get('avg_util_change', 0))\n","    on_loan_value = market_notes.get('on_loan_value', 'N/A')\n","    on_loan_value_change = format_market_note_change(market_notes.get('on_loan_value_change', 0))\n","    lendable_value = market_notes.get('lendable_value', 'N/A')\n","    lendable_value_change = format_market_note_change(market_notes.get('lendable_value_change', 0))\n","\n","    headlines_html = \"\"\n","    for headline in content.get('headlines', []):\n","        headlines_html += f\"\"\"\n","        <div style=\"margin-top:20px;\">\n","            <strong style=\"font-size:16px;\">{headline['title']}</strong>\n","            <p style=\"margin:5px 0 0; white-space: pre-wrap;\">{headline['description']}</p>\n","            <ul style=\"margin:10px 0 0; padding-left:20px; color:#334155; list-style-type: disc;\">\n","              <li><strong>What Our Data Shows:</strong> {headline['data_insight']}</li>\n","            </ul>\n","        </div>\n","        \"\"\"\n","\n","    takeaways_html = \"\".join([f\"<li>{item}</li>\" for item in content.get('key_takeaways', [])])\n","\n","    html_template = f\"\"\"\n","<!DOCTYPE html>\n","<html lang=\"en\">\n","<head>\n","  <meta charset=\"UTF-8\">\n","  <title>EquiLend D&A Daily Digest - {datetime.now().strftime('%B %d, %Y')}</title>\n","</head>\n","<body style=\"margin:0; padding:0; font-family: Arial, sans-serif; background-color:#f1f5f9;\">\n","  <table width=\"100%\" cellpadding=\"0\" cellspacing=\"0\" border=\"0\" bgcolor=\"#f1f5f9\">\n","    <tr>\n","      <td align=\"center\">\n","        <table width=\"800\" cellpadding=\"0\" cellspacing=\"0\" border=\"0\" bgcolor=\"#ffffff\" style=\"margin:20px 0; border-radius:4px; overflow:hidden;\">\n","          <!-- Header -->\n","          <tr>\n","            <td bgcolor=\"#0284c7\" style=\"padding:20px; text-align:center;\">\n","              <h1 style=\"margin:0; font-size:24px; color:#ffffff;\">EquiLend D&amp;A Daily Digest</h1>\n","              <p style=\"margin:5px 0 0; font-size:16px; color:#bae6fd;\">{datetime.now().strftime('%B %d, %Y')}</p>\n","            </td>\n","          </tr>\n","          <!-- Content -->\n","          <tr>\n","            <td style=\"padding:20px; color:#334155; font-size:14px; line-height:1.5;\">\n","\n","              <!-- Market Notes -->\n","              <h2 style=\"font-size:18px; margin-bottom:10px; color:#0284c7;\">&#x1F4BC; Market Notes</h2>\n","              <table width=\"100%\" cellpadding=\"5\" cellspacing=\"0\" border=\"0\" bgcolor=\"#f8fafc\" style=\"margin-bottom:20px;\">\n","                <tr>\n","                  <td align=\"center\" width=\"50%\">\n","                    <p style=\"margin:0; font-size:12px; color:#64748b;\">Average Fee</p>\n","                    <p style=\"margin:5px 0 0; font-size:18px; font-weight:bold; color:#334155;\">\n","                      {avg_fee_bps} bps {avg_fee_change}\n","                    </p>\n","                  </td>\n","                  <td align=\"center\" width=\"50%\">\n","                    <p style=\"margin:0; font-size:12px; color:#64748b;\">Average Utilization</p>\n","                    <p style=\"margin:5px 0 0; font-size:18px; font-weight:bold; color:#334155;\">\n","                      {avg_util_percent}% {avg_util_change}\n","                    </p>\n","                  </td>\n","                </tr>\n","                <tr>\n","                  <td align=\"center\" width=\"50%\">\n","                    <p style=\"margin:0; font-size:12px; color:#64748b;\">On Loan Value</p>\n","                    <p style=\"margin:5px 0 0; font-size:18px; font-weight:bold; color:#334155;\">\n","                      ${on_loan_value} {on_loan_value_change}\n","                    </p>\n","                  </td>\n","                  <td align=\"center\" width=\"50%\">\n","                    <p style=\"margin:0; font-size:12px; color:#64748b;\">Total Lendable Value</p>\n","                    <p style=\"margin:5px 0 0; font-size:18px; font-weight:bold; color:#334155;\">\n","                      ${lendable_value} {lendable_value_change}\n","                    </p>\n","                  </td>\n","                </tr>\n","              </table>\n","\n","              <!-- Headlines -->\n","              <h2 style=\"font-size:18px; margin-bottom:10px; color:#0284c7;\">&#x1F4F0; Major Headlines and What Our Data Shows</h2>\n","              {headlines_html}\n","\n","              <!-- Tables Section -->\n","              <h2 style=\"font-size:18px; margin:20px 0 10px; color:#0284c7;\">&#x1F525; Hot & Getting Hotter</h2>\n","              <div style=\"font-size:14px; font-style:italic; color:#334155; margin-bottom:10px; padding-left:5px;\">Top 5 Stocks with fees > 50,000 bps & rising</div>\n","              <table cellpadding=\"0\" cellspacing=\"0\" border=\"1\" style=\"border-collapse:collapse; margin-bottom:20px; border-color:#dddddd; font-size:12px;\" width=\"100%\">\n","                <thead>\n","                  <tr bgcolor=\"#0284c7\" style=\"color:#ffffff; font-weight:bold; text-align:left;\">\n","                    <th style=\"padding:5px 8px; white-space: nowrap;\">Ticker</th>\n","                    <th style=\"padding:5px 8px; white-space: nowrap;\">Company Name</th>\n","                    <th style=\"padding:5px 8px; white-space: nowrap;\">Industry</th>\n","                    <th style=\"padding:5px 8px; white-space: nowrap;\">Price</th>\n","                    <th style=\"padding:5px 8px; white-space: nowrap;\">Fee 1 WoW (bps)</th>\n","                  </tr>\n","                </thead>\n","                <tbody>\n","                  {ht_borrow_table}\n","                </tbody>\n","              </table>\n","\n","              <h2 style=\"font-size:18px; margin:20px 0 10px; color:#0284c7;\">&#x1F52C; Market Technicals & Squeeze Metrics</h2>\n","              <table cellpadding=\"0\" cellspacing=\"0\" border=\"1\" style=\"border-collapse:collapse; border-color:#dddddd; font-size:12px;\" width=\"100%\">\n","                <thead>\n","                  <tr bgcolor=\"#0284c7\" style=\"color:#ffffff; font-weight:bold; text-align:left;\">\n","                    <th style=\"padding:5px 8px; white-space: nowrap;\">Ticker</th>\n","                    <th style=\"padding:5px 8px; white-space: nowrap;\">Company Name</th>\n","                    <th style=\"padding:5px 8px; white-space: nowrap;\">Industry</th>\n","                    <th style=\"padding:5px 8px; white-space: nowrap;\">Price</th>\n","                    <th style=\"padding:5px 8px; white-space: nowrap;\">Short Squeeze Score (SSS)</th>\n","                    <th style=\"padding:5px 8px; white-space: nowrap;\">SSS WoW</th>\n","                  </tr>\n","                </thead>\n","                <tbody>\n","                  {squeeze_table}\n","                </tbody>\n","              </table>\n","\n","              <!-- Key Takeaways -->\n","              <h2 style=\"font-size:18px; margin:20px 0 10px; color:#0284c7;\">&#x1F4A1; Key Takeaways</h2>\n","              <ul style=\"padding-left:20px; color:#334155; font-size:14px; margin:0;\">\n","                {takeaways_html}\n","              </ul>\n","\n","            </td>\n","          </tr>\n","          <!-- Footer -->\n","          <tr>\n","            <td align=\"center\" style=\"padding:10px; font-size:12px; color:#64748b;\">\n","              Source: EquiLend Data &amp; Analytics\n","            </td>\n","          </tr>\n","        </table>\n","      </td>\n","    </tr>\n","  </table>\n","</body>\n","</html>\n","    \"\"\"\n","    return html_template\n","\n","# --- Main Execution ---\n","if __name__ == \"__main__\":\n","    print(\"Starting daily digest generation...\")\n","\n","    # 1. Parse content from the Word document\n","    print(f\"Reading content from '{CONTENT_DOC_PATH}'...\")\n","    parsed_content = parse_daily_content(CONTENT_DOC_PATH)\n","\n","    # 2. Parse data from the table files\n","    print(f\"Reading tables from '{FEE_TABLE_XLSX_PATH}' and '{SQUEEZE_TABLE_XLSX_PATH}'...\") # Updated print message\n","    table_html = parse_tables(FEE_TABLE_XLSX_PATH, SQUEEZE_TABLE_XLSX_PATH) # Call the updated function\n","\n","    # 3. Generate the final HTML file\n","    print(\"Generating final HTML digest...\")\n","    final_html = create_digest_html(parsed_content, table_html)\n","\n","    # 4. Save the HTML to a file\n","    with open(OUTPUT_HTML_PATH, 'w', encoding='utf-8') as f:\n","        f.write(final_html)\n","\n","    print(f\"\\nSuccessfully generated digest: {OUTPUT_HTML_PATH}\")"],"outputs":[{"output_type":"stream","name":"stdout","text":["Starting daily digest generation...\n","Reading content from 'daily_content.docx'...\n","Reading tables from '/content/fee_table.xlsx' and '/content/squeeze_table.xlsx'...\n","Generating final HTML digest...\n","\n","Successfully generated digest: equilend_daily_digest_2025_08_06.html\n"]}],"execution_count":null,"metadata":{"colab":{"base_uri":"https://localhost:8080/"},"id":"wSnKPQ-ySmOQ","executionInfo":{"status":"ok","timestamp":1754500344160,"user_tz":240,"elapsed":101,"user":{"displayName":"Bob Sheehan","userId":"08159093702253523584"}},"outputId":"b35e2b1e-800e-4109-9582-8d29922067a2"}},{"cell_type":"code","source":[],"metadata":{"id":"63QBYtuiWBOf"},"execution_count":null,"outputs":[]}],"metadata":{"colab":{"provenance":[{"file_id":"1O1pBzDCSgjVwyxlOAQ181NnkqpaQghEt","timestamp":1754501352832}]},"kernelspec":{"display_name":"Python 3","name":"python3"}},"nbformat":4,"nbformat_minor":0}