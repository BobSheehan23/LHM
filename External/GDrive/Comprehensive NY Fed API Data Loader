{"cells":[{"cell_type":"code","source":"import pandas as pd\nimport requests\nfrom io import StringIO\nimport json\nfrom datetime import datetime, timedelta\nfrom typing import List, Optional\n\n# --- Core Helper Function (Enhanced) ---\n\ndef fetch_nyfed_data(endpoint: str, json_path: Optional[List[str]] = None, data_format: str = 'json') -> Optional[pd.DataFrame]:\n    \"\"\"\n    A more robust helper function to fetch and parse data from the NY Fed API.\n\n    Args:\n        endpoint (str): The specific API endpoint to query after '/api/'.\n        json_path (Optional[List[str]]): A list of keys to navigate the nested JSON to find the data list.\n                                         Example: ['markets', 'operations']\n        data_format (str): The desired format ('json', 'xml', 'csv'). Defaults to 'json'.\n\n    Returns:\n        pandas.DataFrame: A DataFrame containing the requested data, or None if the request fails.\n    \"\"\"\n    BASE_URL = \"https://markets.newyorkfed.org/api\"\n    # The API uses .csv for some endpoints in the path itself, not as a format specifier\n    if data_format == 'csv':\n        url = f\"{BASE_URL}/{endpoint}\"\n    else:\n        url = f\"{BASE_URL}/{endpoint}.{data_format}\"\n\n    print(f\"Fetching data from: {url}\")\n\n    try:\n        response = requests.get(url, timeout=30)\n        response.raise_for_status()  # Raises an HTTPError for bad responses (4XX or 5XX)\n\n        if data_format == 'json':\n            data = response.json()\n            \n            if json_path:\n                data_list = data\n                for key in json_path:\n                    data_list = data_list[key]\n                return pd.DataFrame(data_list)\n            else:\n                # Fallback for simple/unknown structures\n                print(\"Warning: No json_path provided. Attempting to find data list automatically.\")\n                for key, value in data.items():\n                    if isinstance(value, dict):\n                        for sub_key, sub_value in value.items():\n                            if isinstance(sub_value, list):\n                                return pd.DataFrame(sub_value)\n                print(f\"Error: Could not automatically find data list in JSON response for endpoint: {endpoint}\")\n                return None\n\n\n        elif data_format == 'csv':\n            return pd.read_csv(StringIO(response.text))\n        else:\n            print(f\"Unsupported format: {data_format}\")\n            return None\n\n    except requests.exceptions.RequestException as e:\n        print(f\"Error fetching data from {url}: {e}\")\n        return None\n    except (json.JSONDecodeError, KeyError) as e:\n        print(f\"Error processing data from {url}. Check endpoint and json_path. Error: {e}\")\n        return None\n    except Exception as e:\n        print(f\"An unexpected error occurred for endpoint {endpoint}: {e}\")\n        return None\n\n# --- 1. System Open Market Account (SOMA) Holdings ---\n\ndef get_soma_holdings(holding_type: str, date: str = 'latest') -> Optional[pd.DataFrame]:\n    \"\"\"\n    Gets SOMA holdings for a specific security type and date.\n    \n    Args:\n        holding_type (str): 'summary', 'agency', or 'tsy'.\n        date (str): Date in 'YYYY-MM-DD' format or 'latest'.\n    \"\"\"\n    if holding_type not in ['summary', 'agency', 'tsy']:\n        raise ValueError(\"holding_type must be one of 'summary', 'agency', or 'tsy'\")\n        \n    if holding_type == 'summary':\n        return fetch_nyfed_data(\"soma/summary\", json_path=['soma', 'summary'])\n    else:\n        return fetch_nyfed_data(f\"soma/{holding_type}/get/asof/{date}\", json_path=['soma', holding_type])\n\n# --- 2. Market Operations (Repo, Securities Lending, etc.) ---\n\ndef search_operations(\n    op_category: str, \n    op_type: str, \n    start_date: str, \n    end_date: str\n) -> Optional[pd.DataFrame]:\n    \"\"\"\n    A generic function to search across different operation types within a date range.\n    \n    Args:\n        op_category (str): 'rp' (Repo), 'seclending', 'ambs', 'tsy'.\n        op_type (str): The specific type of operation (e.g., 'repo', 'reverserepo', 'lending', 'outright').\n        start_date (str): Start date in YYYY-MM-DD format.\n        end_date (str): End date in YYYY-MM-DD format.\n    \"\"\"\n    endpoint_map = {\n        'rp': f\"rp/results/search?opType={op_type}&startDate={start_date}&endDate={end_date}\",\n        'seclending': f\"seclending/results/search?opType={op_type}&startDate={start_date}&endDate={end_date}\",\n        'ambs': f\"ambs/results/search?opType={op_type}&startDate={start_date}&endDate={end_date}\",\n        'tsy': f\"tsy/results/search?opType={op_type}&startDate={start_date}&endDate={end_date}\"\n    }\n    json_path_map = {\n        'rp': ['repo', 'operations'],\n        'seclending': ['securitiesLending', 'operations'],\n        'ambs': ['ambs', 'operations'],\n        'tsy': ['tsy', 'operations']\n    }\n    \n    if op_category not in endpoint_map:\n        raise ValueError(f\"op_category must be one of {list(endpoint_map.keys())}\")\n        \n    return fetch_nyfed_data(endpoint_map[op_category], json_path=json_path_map[op_category])\n\ndef get_fx_swaps_operations(last_n: int = 25) -> Optional[pd.DataFrame]:\n    \"\"\"Gets the last n Central Bank Liquidity Swap operations.\"\"\"\n    return fetch_nyfed_data(f\"fxs/fxs/last/{last_n}\", json_path=['centralBankLiquiditySwaps', 'operations'])\n\n\n# --- 3. Reference Rates (SOFR, EFFR, etc.) ---\n\ndef search_reference_rates(rate_type: str, start_date: str, end_date: str) -> Optional[pd.DataFrame]:\n    \"\"\"\n    Searches for reference rates within a date range.\n    \n    Args:\n        rate_type (str): 'SOFR', 'BGCR', 'TGCR', 'EFFR', 'OBFR', 'ALL'.\n        start_date (str): Start date in YYYY-MM-DD format.\n        end_date (str): End date in YYYY-MM-DD format.\n    \"\"\"\n    endpoint = f\"rates/all/search?rateType={rate_type.upper()}&startDate={start_date}&endDate={end_date}\"\n    return fetch_nyfed_data(endpoint, json_path=['rates', 'refRates'])\n\n\n# --- 4. Primary Dealer Statistics ---\n\ndef get_primary_dealer_data(series_id: str = 'all', date: str = 'latest') -> Optional[pd.DataFrame]:\n    \"\"\"\n    Gets Primary Dealer data for a specific series or date.\n    \n    Args:\n        series_id (str): A specific time series ID, or 'all' to get the full CSV dataset.\n        date (str): Date in 'YYYY-MM-DD' format or 'latest'.\n    \"\"\"\n    if series_id == 'all':\n        return fetch_nyfed_data(\"pd/get/all/timeseries\", data_format='csv')\n    elif date != 'latest':\n         return fetch_nyfed_data(f\"pd/get/asof/{date}\", json_path=['markets', 'primaryDealerStats'])\n    else:\n         return fetch_nyfed_data(f\"pd/get/{series_id}\", json_path=['markets', 'primaryDealerStats'])\n\ndef get_primary_dealer_market_share(period: str = 'qtrly') -> Optional[pd.DataFrame]:\n    \"\"\"\n    Gets the latest primary dealer market share data.\n    \n    Args:\n        period (str): 'qtrly' or 'ytd'.\n    \"\"\"\n    if period not in ['qtrly', 'ytd']:\n        raise ValueError(\"period must be 'qtrly' or 'ytd'\")\n    return fetch_nyfed_data(f\"marketshare/{period}/latest\", json_path=['markets', 'marketShare'])","outputs":[],"execution_count":null,"metadata":{}}],"metadata":{"colab":{"from_bard":true},"kernelspec":{"display_name":"Python 3","name":"python3"}},"nbformat":4,"nbformat_minor":0}