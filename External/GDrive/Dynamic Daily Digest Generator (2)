{"cells":[{"cell_type":"code","source":"# -*- coding: utf-8 -*-\n\"\"\"\ndaily_digest_generator.py\n\nThis script dynamically generates an HTML daily digest by parsing all content\nand tables directly from a single Microsoft Word document.\n\"\"\"\n\nimport pandas as pd\nimport docx\nfrom datetime import datetime\nimport re\nimport numpy as np\n\n# --- Configuration ---\n# The script will read all content from this single Word document.\n# Ensure it is in the same directory as the script.\nCONTENT_DOC_PATH = 'daily_content.docx'\nOUTPUT_HTML_PATH = f\"equilend_daily_digest_{datetime.now().strftime('%Y_%m_%d')}.html\"\n\n# --- 1. DOCX Content Parsing ---\n\ndef parse_daily_content(doc_path):\n    \"\"\"\n    Parses a .docx file for all text and table content, including market notes,\n    headlines, key takeaways, and data tables.\n    \"\"\"\n    try:\n        document = docx.Document(doc_path)\n    except Exception as e:\n        print(f\"Error opening or parsing DOCX file: {doc_path}. Error: {e}\")\n        return None\n\n    content = {\n        'market_notes': {},\n        'headlines': [],\n        'key_takeaways': [],\n        'hot_stocks_data': [],\n        'squeeze_stocks_data': []\n    }\n\n    # --- Parse Paragraphs for Headlines and Key Takeaways ---\n    paras = [p.text.strip() for p in document.paragraphs if p.text.strip()]\n\n    # Parse Headlines\n    try:\n        headline_start_index = -1\n        for i, p_text in enumerate(paras):\n            if 'major headlines' in p_text.lower():\n                headline_start_index = i + 1\n                break\n\n        if headline_start_index != -1:\n            i = headline_start_index\n            while i < len(paras):\n                # Find the start of the next headline block\n                if 'what our data shows' in paras[i].lower() or 'key takeaways' in paras[i].lower():\n                    i += 1\n                    continue\n\n                # Find the end of the current block (the \"What our data shows\" part)\n                end_of_block_idx = -1\n                for j in range(i + 1, len(paras)):\n                    if 'what our data shows' in paras[j].lower():\n                        end_of_block_idx = j\n                        break\n\n                if end_of_block_idx != -1:\n                    title = paras[i].rstrip(':').rstrip('.')\n                    description = \"\\n\".join(paras[i+1:end_of_block_idx])\n                    data_insight_raw = paras[end_of_block_idx]\n                    data_insight = re.sub(r'[\\starbullet\\s]*What our data shows:\\s?', '', data_insight_raw, flags=re.IGNORECASE).strip()\n\n                    content['headlines'].append({\n                        'title': title,\n                        'description': description,\n                        'data_insight': data_insight\n                    })\n                    i = end_of_block_idx + 1\n                else:\n                    break  # No more headline blocks found\n    except Exception as e:\n        print(f\"Warning: Could not parse Headlines. Error: {e}\")\n\n    # Parse Key Takeaways\n    try:\n        takeaways_start_index = -1\n        for i, p_text in enumerate(paras):\n            if 'key takeaways' in p_text.lower():\n                takeaways_start_index = i + 1\n                break\n\n        if takeaways_start_index != -1:\n            for i in range(takeaways_start_index, len(paras)):\n                line = paras[i].lstrip('-â€¢* ').strip()\n                # Stop if we hit another section or an empty line that indicates the end\n                if not line or 'hot & getting hotter' in line.lower() or 'market technicals' in line.lower():\n                    break\n                content['key_takeaways'].append(line)\n    except Exception as e:\n        print(f\"Warning: Could not parse Key Takeaways. Error: {e}\")\n\n\n    # --- Parse Tables for Market Notes and Stock Data ---\n    for table in document.tables:\n        if not table.rows:\n            continue\n\n        # Get header to identify the table\n        header_cells = [cell.text.strip().lower() for cell in table.rows[0].cells]\n\n        # Identify and parse \"Hot & Getting Hotter\" table\n        if 'fee 1 wow (bps)' in header_cells:\n            keys = [h.replace(' ', '_') for h in header_cells]\n            for row in table.rows[1:]:\n                row_data = {keys[i]: cell.text.strip() for i, cell in enumerate(row.cells)}\n                content['hot_stocks_data'].append(row_data)\n\n        # Identify and parse \"Squeeze Metrics\" table\n        elif 'short squeeze score (sss)' in header_cells:\n            keys = [h.replace(' ', '_') for h in header_cells]\n            for row in table.rows[1:]:\n                row_data = {keys[i]: cell.text.strip() for i, cell in enumerate(row.cells)}\n                content['squeeze_stocks_data'].append(row_data)\n\n        # Identify and parse \"Market Notes\" table by its structure\n        elif len(table.rows) >= 4 and len(header_cells) >= 3:\n            try:\n                for row in table.rows:\n                    cells = [cell.text.strip() for cell in row.cells]\n                    if len(cells) >= 3:\n                        metric = cells[0].lower()\n                        value = cells[1]\n                        change_str = cells[2]\n                        change_match = re.search(r'([+-]?\\d+\\.?\\d*)%?', change_str)\n                        change = float(change_match.group(1).replace('+', '')) if change_match else 0.0\n\n                        if 'average fee' in metric:\n                            content['market_notes']['avg_fee_bps'] = value.replace('bps', '').strip()\n                            content['market_notes']['avg_fee_change'] = change\n                        elif 'average utilization' in metric:\n                            content['market_notes']['avg_util_percent'] = value.replace('%', '').strip()\n                            content['market_notes']['avg_util_change'] = change\n                        elif 'on loan value' in metric:\n                            content['market_notes']['on_loan_value'] = value.replace('$', '').strip()\n                            content['market_notes']['on_loan_value_change'] = change\n                        elif 'total lendable value' in metric:\n                            content['market_notes']['lendable_value'] = value.replace('$', '').strip()\n                            content['market_notes']['lendable_value_change'] = change\n            except Exception as e:\n                print(f\"Warning: Could not parse Market Notes from table. Error: {e}\")\n\n    return content\n\n\n# --- 2. HTML Generation ---\n\ndef create_digest_html(content):\n    \"\"\"\n    Generates the final HTML for the digest by populating a template with the\n    parsed content.\n    \"\"\"\n    if not content:\n        return \"<h1>Error: Could not generate content because the source document could not be parsed.</h1>\"\n\n    # Helper function to format numeric changes with color\n    def format_change(value, unit=' BPS', decimal_places=0):\n        try:\n            cleaned_value = str(value).replace(',', '').strip()\n            val = float(cleaned_value)\n            color = '#16a34a' if val > 0 else '#dc2626'\n            sign = '+' if val > 0 else ''\n            format_string = f'{{val:,.{decimal_places}f}}{{unit}}' if decimal_places > 0 else f'{{val:,.0f}}{{unit}}'\n            return f'<span style=\"color:{color}; font-size:14px;\">{sign}{format_string.format(val=val, unit=unit)}</span>'\n        except (ValueError, TypeError):\n            return str(value).strip() if pd.notna(value) else ''\n\n    # Helper function for market note percentage changes\n    def format_market_note_change(value):\n        color = '#16a34a' if value >= 0 else '#dc2626'\n        sign = '+' if value >= 0 else ''\n        return f'<span style=\"color:{color}; font-size:14px;\">{sign}{value:.2f}%</span>'\n\n    # --- Prepare Market Notes ---\n    market_notes = content.get('market_notes', {})\n    avg_fee_bps = market_notes.get('avg_fee_bps', 'N/A')\n    avg_fee_change_value = market_notes.get('avg_fee_change', 0)\n    avg_fee_change = format_market_note_change(avg_fee_change_value) if isinstance(avg_fee_change_value, (int, float)) else 'N/A'\n\n    avg_util_percent = market_notes.get('avg_util_percent', 'N/A')\n    avg_util_change_value = market_notes.get('avg_util_change', 0)\n    avg_util_change = format_market_note_change(avg_util_change_value) if isinstance(avg_util_change_value, (int, float)) else 'N/A'\n\n    on_loan_value = market_notes.get('on_loan_value', 'N/A')\n    on_loan_value_change_value = market_notes.get('on_loan_value_change', 0)\n    on_loan_value_change = format_market_note_change(on_loan_value_change_value) if isinstance(on_loan_value_change_value, (int, float)) else 'N/A'\n\n    lendable_value = market_notes.get('lendable_value', 'N/A')\n    lendable_value_change_value = market_notes.get('lendable_value_change', 0)\n    lendable_value_change = format_market_note_change(lendable_value_change_value) if isinstance(lendable_value_change_value, (int, float)) else 'N/A'\n\n    # --- Prepare Headlines ---\n    headlines_html = \"\"\n    for headline in content.get('headlines', []):\n        headlines_html += f\"\"\"\n        <div style=\"margin-top:20px;\">\n            <strong style=\"font-size:16px;\">{headline['title']}</strong>\n            <p style=\"margin:5px 0 0; white-space: pre-wrap;\">{headline['description']}</p>\n            <ul style=\"margin:10px 0 0; padding-left:20px; color:#334155; list-style-type: disc;\">\n              <li><strong>What Our Data Shows:</strong> {headline['data_insight']}</li>\n            </ul>\n        </div>\n        \"\"\"\n\n    # --- Prepare \"Hot & Getting Hotter\" Table ---\n    ht_borrow_html = \"\"\n    for row in content.get('hot_stocks_data', []):\n        price_val = row.get('price', '')\n        formatted_price = f\"${price_val.replace('$', '')}\" if price_val else \"\"\n        ht_borrow_html += f\"\"\"\n        <tr style=\"font-size:12px; background-color:#ffffff; text-align:left;\">\n            <td style=\"padding:4px 8px;\">{row.get(\"ticker\", \"\")}</td>\n            <td style=\"padding:4px 8px;\">{row.get(\"company_name\", \"\")}</td>\n            <td style=\"padding:4px 8px;\">{row.get(\"industry\", \"\")}</td>\n            <td style=\"padding:4px 8px;\">{formatted_price}</td>\n            <td style=\"padding:4px 8px;\">{format_change(row.get(\"fee_1_wow_(bps)\", \"\"))}</td>\n        </tr>\"\"\"\n\n    # --- Prepare \"Squeeze Metrics\" Table ---\n    squeeze_html = \"\"\n    for row in content.get('squeeze_stocks_data', []):\n        price_val = row.get('price', '')\n        formatted_price = f\"${price_val.replace('$', '')}\" if price_val else \"\"\n        squeeze_html += f\"\"\"\n        <tr style=\"font-size:12px; background-color:#ffffff; text-align:left;\">\n            <td style=\"padding:4px 8px;\">{row.get(\"ticker\", \"\")}</td>\n            <td style=\"padding:4px 8px;\">{row.get(\"company_name\", \"\")}</td>\n            <td style=\"padding:4px 8px;\">{row.get(\"industry\", \"\")}</td>\n            <td style=\"padding:4px 8px;\">{formatted_price}</td>\n            <td style=\"padding:4px 8px;\">{row.get(\"short_squeeze_score_(sss)\", \"\")}</td>\n            <td style=\"padding:4px 8px;\">{format_change(row.get(\"sss_wow\", \"\"), unit=\"\", decimal_places=0)}</td>\n        </tr>\"\"\"\n\n    # --- Prepare Key Takeaways ---\n    takeaways_html = \"\".join([f\"<li>{item}</li>\" for item in content.get('key_takeaways', [])])\n\n    # --- Assemble Final HTML ---\n    html_template = f\"\"\"\n<!DOCTYPE html>\n<html lang=\"en\">\n<head>\n  <meta charset=\"UTF-8\">\n  <title>EquiLend D&A Daily Digest - {datetime.now().strftime('%B %d, %Y')}</title>\n</head>\n<body style=\"margin:0; padding:0; font-family: Arial, sans-serif; background-color:#f1f5f9;\">\n  <table width=\"100%\" cellpadding=\"0\" cellspacing=\"0\" border=\"0\" bgcolor=\"#f1f5f9\">\n    <tr>\n      <td align=\"center\">\n        <table width=\"800\" cellpadding=\"0\" cellspacing=\"0\" border=\"0\" bgcolor=\"#ffffff\" style=\"margin:20px 0; border-radius:4px; overflow:hidden;\">\n          <!-- Header -->\n          <tr>\n            <td bgcolor=\"#0284c7\" style=\"padding:20px; text-align:center;\">\n              <h1 style=\"margin:0; font-size:24px; color:#ffffff;\">EquiLend D&amp;A Daily Digest</h1>\n              <p style=\"margin:5px 0 0; font-size:16px; color:#bae6fd;\">{datetime.now().strftime('%B %d, %Y')}</p>\n            </td>\n          </tr>\n          <!-- Content -->\n          <tr>\n            <td style=\"padding:20px; color:#334155; font-size:14px; line-height:1.5;\">\n\n              <!-- Market Notes -->\n              <h2 style=\"font-size:18px; margin-bott","outputs":[],"execution_count":null,"metadata":{}}],"metadata":{"colab":{"from_bard":true},"kernelspec":{"display_name":"Python 3","name":"python3"}},"nbformat":4,"nbformat_minor":0}