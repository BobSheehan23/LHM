{"cells":[{"cell_type":"code","source":["import pandas as pd\n","import matplotlib.pyplot as plt\n","import matplotlib.dates as mdates\n","from docx import Document\n","from docx.shared import Inches\n","import io\n","\n","# --- Data Loading and Preparation ---\n","\n","# Load the datasets from the provided CSV files\n","try:\n","    df_main = pd.read_csv('aap.csv')\n","    df_extra = pd.read_csv('aap1.csv')\n","except FileNotFoundError:\n","    print(\"Make sure 'aap.csv' and 'aap1.csv' are in the same directory.\")\n","    # Exit the program if the files are not found\n","    exit()\n","\n","\n","# Clean column names by stripping leading/trailing whitespace\n","df_main.columns = df_main.columns.str.strip()\n","df_extra.columns = df_extra.columns.str.strip()\n","\n","# Standardize the 'Business Date' column to datetime objects for merging\n","df_main['Business Date'] = pd.to_datetime(df_main['Business Date'])\n","df_extra['Business Date'] = pd.to_datetime(df_extra['Business Date'])\n","\n","# Merge the two dataframes on the 'Business Date'\n","df = pd.merge(df_main, df_extra, on='Business Date', how='left')\n","\n","# Sort the data by date to ensure chronological order for plotting\n","df = df.sort_values('Business Date').reset_index(drop=True)\n","\n","# --- Chart Generation ---\n","\n","# Define EquiLend's branding color palette\n","EquiLend_blue = '#002D56'\n","EquiLend_teal = '#00A39C'\n","EquiLend_grey = '#A5A5A5'\n","EquiLend_light_grey = '#D9D9D9'\n","hot_color = '#FF5733'\n","highlight_color = '#FFC300'\n","\n","# Create a multi-panel figure for the visualizations\n","fig, (ax1, ax2, ax3, ax4) = plt.subplots(4, 1, figsize=(12, 18), sharex=True)\n","fig.suptitle('Securities Finance Data Analysis: AAP', fontsize=18, fontweight='bold', color=EquiLend_blue)\n","\n","# --- Common styling function for all axes ---\n","def style_ax(ax):\n","    \"\"\"Applies consistent EquiLend branding and styling to a matplotlib axis.\"\"\"\n","    ax.grid(True, which='both', linestyle='--', linewidth=0.5, color=EquiLend_light_grey)\n","    ax.tick_params(axis='x', colors=EquiLend_grey)\n","    ax.tick_params(axis='y', colors=EquiLend_grey)\n","    ax.spines['top'].set_visible(False)\n","    ax.spines['right'].set_visible(False)\n","    ax.spines['left'].set_color(EquiLend_light_grey)\n","    ax.spines['bottom'].set_color(EquiLend_light_grey)\n","    ax.yaxis.label.set_color(EquiLend_blue)\n","    ax.yaxis.label.set_fontweight('bold')\n","    ax.xaxis.label.set_color(EquiLend_blue)\n","    ax.xaxis.label.set_fontweight('bold')\n","    ax.legend(loc='upper left')\n","\n","# --- Plot 1: Security Price and On Loan Quantity ---\n","ax1.plot(df['Business Date'], df['Security Price'], color=EquiLend_teal, label='Security Price (USD)', linewidth=2.5)\n","ax1.set_ylabel('Security Price (USD)')\n","style_ax(ax1)\n","\n","ax1_twin = ax1.twinx()\n","ax1_twin.fill_between(df['Business Date'], df['On Loan Quantity'], color=EquiLend_grey, alpha=0.3, label='On Loan Quantity')\n","ax1_twin.set_ylabel('On Loan Quantity (Shares)', color=EquiLend_grey, fontweight='bold')\n","ax1_twin.tick_params(axis='y', colors=EquiLend_grey)\n","ax1_twin.spines['top'].set_visible(False)\n","ax1_twin.spines['left'].set_visible(False)\n","ax1_twin.spines['bottom'].set_color(EquiLend_light_grey)\n","ax1_twin.spines['right'].set_color(EquiLend_light_grey)\n","ax1_twin.legend(loc='upper right')\n","\n","# --- Plot 2: Cost to Borrow (Fee) ---\n","ax2.plot(df['Business Date'], df['Fee 1 (bps)'], color=hot_color, label='Fee (bps)', linewidth=2.5)\n","ax2.set_ylabel('Cost to Borrow (bps)')\n","style_ax(ax2)\n","\n","# --- Plot 3: Utilization ---\n","ax3.plot(df['Business Date'], df['Utilization_x'], color='#7D3C98', label='Utilization (%)', linewidth=2.5)\n","ax3.set_ylabel('Utilization (%)')\n","style_ax(ax3)\n","\n","# --- Plot 4: Squeeze Score ---\n","ax4.bar(df['Business Date'], df['Squeeze Score_x'], color=highlight_color, label='Squeeze Score', width=1.5)\n","ax4.set_ylabel('Squeeze Score')\n","style_ax(ax4)\n","\n","# --- Final Chart Formatting ---\n","# Format the x-axis to display dates clearly\n","ax4.xaxis.set_major_formatter(mdates.DateFormatter('%b %d, %Y'))\n","fig.autofmt_xdate(rotation=45, ha='right')\n","\n","plt.tight_layout(rect=[0, 0.03, 1, 0.95])\n","\n","# Save the chart to a memory buffer to be inserted into the Word document\n","chart_image_buffer = io.BytesIO()\n","plt.savefig(chart_image_buffer, format='png', dpi=300, bbox_inches='tight')\n","chart_image_buffer.seek(0)\n","plt.close(fig)\n","\n","print(\"Chart generation complete.\")\n","\n","# --- Report Generation ---\n","\n","# --- Report Content ---\n","report_title = \"Data & Analytics Use Case: Identifying a Short Squeeze in AAP Using EquiLend Data\"\n","report_date = \"July 30, 2025\"\n","to_line = \"To: Nancy Allen, Managing Director, Global Head of Data & Analytics\"\n","from_line = \"From: Bob Sheehan, CFA, CMT, Vice President, Market Strategy & Research\"\n","\n","introduction_text = (\n","    \"This document presents a use case analysis of securities finance data for Advance Auto Parts (ticker: AAP) \"\n","    \"from late April to late July 2025. It is intended to demonstrate how clients can leverage the EquiLend Data & \"\n","    \"Analytics suite to derive actionable insights from our short interest and market sentiment indicators.\"\n",")\n","\n","what_we_did_text = (\n","    \"We analyzed time-series data for the security AAP, focusing on four key securities finance metrics from our dataset:\\n\\n\"\n","    \"- **On Loan Quantity:** The total number of shares on loan. This is a primary indicator of short interest demand.\\n\"\n","    \"- **Cost to Borrow (Fee):** The annualized fee in basis points (bps) required to borrow the security. \"\n","    \"Rising fees often indicate higher demand for shorting or a scarcity of lendable shares.\\n\"\n","    \"- **Utilization:** The percentage of the total lendable supply of a security that is currently on loan. \"\n","    \"High utilization can be a precursor to a short squeeze.\\n\"\n","    \"- **Squeeze Score:** An EquiLend proprietary metric that combines multiple factors, including utilization, \"\n","    \"borrowing costs, and market data to quantify the risk of a potential short squeeze.\\n\\n\"\n","    \"Using Python, we processed and visualized this data to identify relationships between these metrics and the \"\n","    \"security's price action over the three-month period.\"\n",")\n","\n","why_we_did_it_text = (\n","    \"The primary objective of this analysis is to create a compelling, data-driven narrative for our buy-side data product. \"\n","    \"By focusing on a real-world example, we can clearly illustrate how our proprietary data, especially the **Squeeze Score**, \"\n","    \"can serve as a valuable indicator of market sentiment and potential catalysts for significant price movements. \"\n","    \"This use case is designed to show clients how our data can be integrated into their discretionary macro or tactical \"\n","    \"asset allocation process for both risk management and the identification of potential opportunities.\"\n",")\n","\n","what_the_data_is_telling_us_text = (\n","    \"The analysis of AAP's securities finance data reveals a distinct narrative in four phases, culminating in a significant \"\n","    \"price event that our data may have signaled.\\n\\n\"\n","    \"**Phase 1: The Calm (Late April - Mid-May)**\\n\"\n","    \"In the initial period, from late April to mid-May 2025, the data shows a relatively stable environment. The security price \"\n","    \"traded in a range between approximately $31 and $34. Short interest, as measured by `On Loan Quantity`, was stable, and \"\n","    \"`Utilization` remained steady around 30%. The `Squeeze Score` was low and stable, holding at a value of 15 for most of the period. \"\n","    \"This baseline activity suggests a lack of strong directional conviction from short sellers.\\n\\n\"\n","    \"**Phase 2: The Squeeze Event (Late May)**\\n\"\n","    \"The situation changed on May 22, 2025. The `Squeeze Score` experienced a more than threefold increase, jumping from 16 on \"\n","    \"May 21 to 53 on May 22. This spike in the Squeeze Score coincided with a sharp upward movement in the stock's price, \"\n","    \"which rose from $31.31 to $49.17 in a single day. In the days leading up to and during this event, `On Loan Quantity` and \"\n","    \"`Utilization` both saw a notable increase, with utilization climbing from 32.57% to a peak of 37.24%. This sequence could be \"\n","    \"interpreted as a classic short squeeze. The rising difficulty and risk in maintaining short positions, as quantified by the \"\n","    \"sharp increase in our Squeeze Score, preceded a rapid price appreciation as short sellers were likely forced to cover their positions.\\n\\n\"\n","    \"**Phase 3: Elevated Pressure (June)**\\n\"\n","    \"Following the late-May price surge, the pressure on short sellers did not immediately abate. The `Squeeze Score` remained \"\n","    \"elevated throughout June, peaking at 57 on June 10, indicating that conditions for a squeeze remained high. The securityâ€™s \"\n","    \"price consolidated at a new, higher plateau, generally trading between $48 and $53. Interestingly, the `On Loan Quantity` \"\n","    \"began to drift lower during this time, suggesting some short positions were being closed out, though not aggressively.\\n\\n\"\n","    \"**Phase 4: Cost Climax and Normalization (July)**\\n\"\n","    \"The month of July appears to represent the climax and potential resolution of this short-interest-driven event. The `Cost to Borrow` \"\n","    \"saw a spike, reaching a period high of 83.38 bps on July 11. This spike in borrowing costs occurred as the `On Loan Quantity` \"\n","    \"also hit its peak of over 16 million shares. This combination often signals maximum stress on short sellers, as the cost to \"\n","    \"maintain positions becomes exceptionally high. Following this climax, from mid-to-late July, both the borrowing fee and the quantity \"\n","    \"of shares on loan began to decline steadily. Concurrently, the price of AAP continued to trend upwards, reaching a high of $66.50.\"\n",")\n","\n","conclusion_text = (\n","    \"The analysis of AAP from May to July 2025 serves as a powerful use case for EquiLend's data analytics. The proprietary \"\n","    \"`Squeeze Score` provided a timely signal that conditions were becoming hazardous for short sellers. An investor monitoring \"\n","    \"this data could have been alerted to the potential for a significant upward price move. This case study effectively illustrates \"\n","    \"that our data is not just descriptive; it can be a valuable input for systematic or discretionary trading strategies. For a \"\n","    \"portfolio manager, these indicators could provide the context needed to manage risk on an existing short position or to \"\n","    \"initiate a tactical long position to capitalize on the developing market dynamics.\"\n",")\n","\n","\n","# --- Document Assembly ---\n","document = Document()\n","\n","# Add titles and headers\n","document.add_heading(report_title, level=1)\n","document.add_paragraph(to_line)\n","document.add_paragraph(from_line)\n","document.add_paragraph(f\"Date: {report_date}\")\n","document.add_paragraph()\n","\n","# Add report sections\n","document.add_heading(\"1. What We Did\", level=2)\n","document.add_paragraph(what_we_did_text)\n","\n","document.add_heading(\"2. Why We Did It\", level=2)\n","document.add_paragraph(why_we_did_it_text)\n","\n","document.add_heading(\"3. What the Data Is Telling Us\", level=2)\n","# Insert the chart image into the document\n","document.add_picture(chart_image_buffer, width=Inches(6.5))\n","document.add_paragraph(what_the_data_is_telling_us_text)\n","\n","\n","document.add_heading(\"Conclusion\", level=2)\n","document.add_paragraph(conclusion_text)\n","\n","# Save the final Word document\n","file_name = \"EquiLend_AAP_Short_Interest_Analysis.docx\"\n","document.save(file_name)\n","\n","print(f\"\\nReport '{file_name}' has been successfully generated.\")"],"outputs":[{"output_type":"stream","name":"stdout","text":["Make sure 'aap.csv' and 'aap1.csv' are in the same directory.\n"]},{"output_type":"error","ename":"NameError","evalue":"name 'df_main' is not defined","traceback":["\u001b[0;31m---------------------------------------------------------------------------\u001b[0m","\u001b[0;31mNameError\u001b[0m                                 Traceback (most recent call last)","\u001b[0;32m/tmp/ipython-input-969437151.py\u001b[0m in \u001b[0;36m<cell line: 0>\u001b[0;34m()\u001b[0m\n\u001b[1;32m     18\u001b[0m \u001b[0;34m\u001b[0m\u001b[0m\n\u001b[1;32m     19\u001b[0m \u001b[0;31m# Clean column names by stripping leading/trailing whitespace\u001b[0m\u001b[0;34m\u001b[0m\u001b[0;34m\u001b[0m\u001b[0m\n\u001b[0;32m---> 20\u001b[0;31m \u001b[0mdf_main\u001b[0m\u001b[0;34m.\u001b[0m\u001b[0mcolumns\u001b[0m \u001b[0;34m=\u001b[0m \u001b[0mdf_main\u001b[0m\u001b[0;34m.\u001b[0m\u001b[0mcolumns\u001b[0m\u001b[0;34m.\u001b[0m\u001b[0mstr\u001b[0m\u001b[0;34m.\u001b[0m\u001b[0mstrip\u001b[0m\u001b[0;34m(\u001b[0m\u001b[0;34m)\u001b[0m\u001b[0;34m\u001b[0m\u001b[0;34m\u001b[0m\u001b[0m\n\u001b[0m\u001b[1;32m     21\u001b[0m \u001b[0mdf_extra\u001b[0m\u001b[0;34m.\u001b[0m\u001b[0mcolumns\u001b[0m \u001b[0;34m=\u001b[0m \u001b[0mdf_extra\u001b[0m\u001b[0;34m.\u001b[0m\u001b[0mcolumns\u001b[0m\u001b[0;34m.\u001b[0m\u001b[0mstr\u001b[0m\u001b[0;34m.\u001b[0m\u001b[0mstrip\u001b[0m\u001b[0;34m(\u001b[0m\u001b[0;34m)\u001b[0m\u001b[0;34m\u001b[0m\u001b[0;34m\u001b[0m\u001b[0m\n\u001b[1;32m     22\u001b[0m \u001b[0;34m\u001b[0m\u001b[0m\n","\u001b[0;31mNameError\u001b[0m: name 'df_main' is not defined"]}],"execution_count":8,"metadata":{"colab":{"base_uri":"https://localhost:8080/","height":228},"collapsed":true,"id":"nizxOMDhiuxr","executionInfo":{"status":"error","timestamp":1753899878173,"user_tz":240,"elapsed":142,"user":{"displayName":"Bob Sheehan","userId":"08159093702253523584"}},"outputId":"70492470-87c5-4cc4-e57a-c0f1c49614b0"}},{"cell_type":"code","metadata":{"colab":{"base_uri":"https://localhost:8080/"},"id":"56239b52","executionInfo":{"status":"ok","timestamp":1753899565486,"user_tz":240,"elapsed":5915,"user":{"displayName":"Bob Sheehan","userId":"08159093702253523584"}},"outputId":"2063fdae-a371-4589-d229-d3ee752c9d55"},"source":["%pip install python-docx"],"execution_count":7,"outputs":[{"output_type":"stream","name":"stdout","text":["Requirement already satisfied: python-docx in /usr/local/lib/python3.11/dist-packages (1.2.0)\n","Requirement already satisfied: lxml>=3.1.0 in /usr/local/lib/python3.11/dist-packages (from python-docx) (5.4.0)\n","Requirement already satisfied: typing_extensions>=4.9.0 in /usr/local/lib/python3.11/dist-packages (from python-docx) (4.14.1)\n"]}]}],"metadata":{"colab":{"provenance":[]},"kernelspec":{"display_name":"Python 3","name":"python3"}},"nbformat":4,"nbformat_minor":0}