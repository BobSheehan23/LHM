{"cells":[{"cell_type":"code","source":["pip install python-docx"],"metadata":{"colab":{"base_uri":"https://localhost:8080/"},"id":"wfbsZ11_Xomn","executionInfo":{"status":"ok","timestamp":1753107841547,"user_tz":240,"elapsed":7744,"user":{"displayName":"Bob Sheehan","userId":"08159093702253523584"}},"outputId":"10270ba4-1157-4e85-d537-a9b4ca5bb64d"},"execution_count":1,"outputs":[{"output_type":"stream","name":"stdout","text":["Collecting python-docx\n","  Downloading python_docx-1.2.0-py3-none-any.whl.metadata (2.0 kB)\n","Requirement already satisfied: lxml>=3.1.0 in /usr/local/lib/python3.11/dist-packages (from python-docx) (5.4.0)\n","Requirement already satisfied: typing_extensions>=4.9.0 in /usr/local/lib/python3.11/dist-packages (from python-docx) (4.14.1)\n","Downloading python_docx-1.2.0-py3-none-any.whl (252 kB)\n","\u001b[?25l   \u001b[90m━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\u001b[0m \u001b[32m0.0/253.0 kB\u001b[0m \u001b[31m?\u001b[0m eta \u001b[36m-:--:--\u001b[0m\r\u001b[2K   \u001b[91m━━━━━━━━━━━━━━━━━━━━━━━━\u001b[0m\u001b[90m╺\u001b[0m\u001b[90m━━━━━━━━━━━━━━━\u001b[0m \u001b[32m153.6/253.0 kB\u001b[0m \u001b[31m4.6 MB/s\u001b[0m eta \u001b[36m0:00:01\u001b[0m\r\u001b[2K   \u001b[90m━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\u001b[0m \u001b[32m253.0/253.0 kB\u001b[0m \u001b[31m4.7 MB/s\u001b[0m eta \u001b[36m0:00:00\u001b[0m\n","\u001b[?25hInstalling collected packages: python-docx\n","Successfully installed python-docx-1.2.0\n"]}]},{"cell_type":"code","source":["import pandas as pd\n","import docx\n","from datetime import datetime\n","import re\n","import numpy as np\n","\n","# --- Configuration ---\n","# File paths for the input data.\n","CONTENT_DOC_PATH = 'daily_content.docx'\n","OUTPUT_HTML_PATH = f\"equilend_daily_digest_{datetime.now().strftime('%Y_%m_%d')}.html\"\n","\n","# --- 1. DOCX Content and Table Parsing ---\n","\n","def parse_docx_tables_from_text(paras):\n","    \"\"\"\n","    Finds and parses tables that are pasted as plain text in the .docx file.\n","\n","    It identifies table sections by their text headers and parses the subsequent\n","    comma-separated lines.\n","\n","    Args:\n","        paras (list): A list of all paragraph texts from the document.\n","\n","    Returns:\n","        tuple: A tuple containing the HTML for the two table bodies.\n","    \"\"\"\n","    ht_borrow_html = \"\"\n","    squeeze_html = \"\"\n","\n","    def format_change(value, unit=' BPS'):\n","        try:\n","            cleaned_value = str(value).replace(',', '').strip()\n","            val = float(cleaned_value)\n","            color = '#16a34a' if val > 0 else '#dc2626'\n","            sign = '+' if val > 0 else ''\n","            return f'<span style=\"color:{color}; font-size:14px;\">{sign}{val:,.0f}{unit}</span>'\n","        except (ValueError, TypeError):\n","            return str(value).strip() if pd.notna(value) else ''\n","\n","    # --- Find and Parse \"Hard-to-Borrow\" Table ---\n","    try:\n","        ht_start_index = -1\n","        for i, p_text in enumerate(paras):\n","            if \"today's specials and hard-to-borrow\" in p_text.lower():\n","                ht_start_index = i + 1 # Data starts after the header\n","                break\n","\n","        if ht_start_index != -1:\n","            # The line after the section header is the table header\n","            header = [h.strip() for h in paras[ht_start_index].split(',')]\n","            header_map = {h: i for i, h in enumerate(header)}\n","\n","            # Iterate through lines after the table header\n","            for i in range(ht_start_index + 1, len(paras)):\n","                line = paras[i]\n","                if not line or \"market technicals\" in line.lower(): # Stop if blank or next section\n","                    break\n","\n","                cells = [cell.strip().replace('\"', '') for cell in line.split(',')]\n","                if len(cells) < len(header): continue # Skip malformed lines\n","\n","                ht_borrow_html += f\"\"\"\n","                <tr style=\"font-size:12px; background-color:#ffffff; text-align:left;\">\n","                    <td style=\"padding:4px 8px;\">{cells[header_map['TICKER']]}</td>\n","                    <td style=\"padding:4px 8px;\">{cells[header_map['Security Description']]}</td>\n","                    <td style=\"padding:4px 8px;\">{cells[header_map['Industry']]}</td>\n","                    <td style=\"padding:4px 8px;\">{cells[header_map['Price']]}</td>\n","                    <td style=\"padding:4px 8px;\">{cells[header_map['Fee Band']]}</td>\n","                    <td style=\"padding:4px 8px;\">{format_change(cells[header_map['Fee WoW (BPS)']])}</td>\n","                </tr>\"\"\"\n","    except Exception as e:\n","        print(f\"Warning: Could not parse Hard-to-Borrow table from text. Error: {e}\")\n","\n","    # --- Find and Parse \"Squeeze Metrics\" Table ---\n","    try:\n","        sq_start_index = -1\n","        for i, p_text in enumerate(paras):\n","            if \"market technicals & squeeze metrics\" in p_text.lower():\n","                sq_start_index = i + 1\n","                break\n","\n","        if sq_start_index != -1:\n","            header = [h.strip() for h in paras[sq_start_index].split(',')]\n","            header_map = {h: i for i, h in enumerate(header)}\n","\n","            for i in range(sq_start_index + 1, len(paras)):\n","                line = paras[i]\n","                if not line or \"key takeaways\" in line.lower():\n","                    break\n","\n","                cells = [cell.strip().replace('\"', '') for cell in line.split(',')]\n","                if len(cells) < len(header): continue\n","\n","                squeeze_html += f\"\"\"\n","                <tr style=\"font-size:12px; background-color:#ffffff; text-align:left;\">\n","                    <td style=\"padding:4px 8px;\">{cells[header_map['TICKER']]}</td>\n","                    <td style=\"padding:4px 8px;\">{cells[header_map['Security Description']]}</td>\n","                    <td style=\"padding:4px 8px;\">{cells[header_map['Industry']]}</td>\n","                    <td style=\"padding:4px 8px;\">{cells[header_map['Price']]}</td>\n","                    <td style=\"padding:4px 8px;\">{cells[header_map['SSS']]}</td>\n","                    <td style=\"padding:4px 8px;\">{format_change(cells[header_map['SSS WoW']], unit=\"\")}</td>\n","                </tr>\"\"\"\n","    except Exception as e:\n","        print(f\"Warning: Could not parse Squeeze Metrics table from text. Error: {e}\")\n","\n","    return ht_borrow_html, squeeze_html\n","\n","\n","def parse_daily_content(doc_path):\n","    \"\"\"\n","    Parses the .docx file for market notes and exactly three headlines.\n","    \"\"\"\n","    try:\n","        document = docx.Document(doc_path)\n","    except Exception as e:\n","        print(f\"Error opening or parsing DOCX file: {e}\")\n","        return None, []\n","\n","    content = {'market_notes': {}, 'headlines': []}\n","    paras = [p.text.strip() for p in document.paragraphs if p.text.strip()]\n","\n","    # --- Parse Market Notes ---\n","    try:\n","        market_notes_idx = -1\n","        for i, p_text in enumerate(paras):\n","            if 'market notes' in p_text.lower():\n","                market_notes_idx = i\n","                break\n","\n","        if market_notes_idx != -1:\n","            fee_text = paras[market_notes_idx + 1]\n","            util_text = paras[market_notes_idx + 2]\n","\n","            fee_match = re.search(r'(\\d+\\.?\\d*)\\s*bps\\s*([+-]?\\d+\\.?\\d*)%', fee_text)\n","            if fee_match:\n","                content['market_notes']['avg_fee_bps'] = fee_match.group(1)\n","                content['market_notes']['avg_fee_change'] = float(fee_match.group(2))\n","\n","            util_match = re.search(r'(\\d+\\.?\\d*)%\\s*([+-]?\\d+\\.?\\d*)%', util_text)\n","            if util_match:\n","                content['market_notes']['avg_util_percent'] = util_match.group(1)\n","                content['market_notes']['avg_util_change'] = float(util_match.group(2))\n","    except (ValueError, IndexError) as e:\n","        print(f\"Warning: Could not parse Market Notes. Check document structure. Error: {e}\")\n","\n","    # --- Parse Headlines ---\n","    try:\n","        headline_start_index = -1\n","        for i, p_text in enumerate(paras):\n","            if 'major headlines' in p_text.lower():\n","                headline_start_index = i + 1\n","                break\n","\n","        if headline_start_index != -1:\n","            i = headline_start_index\n","            while len(content['headlines']) < 3 and i < len(paras):\n","                end_of_block_idx = -1\n","                for j in range(i, len(paras)):\n","                    if 'what our data shows' in paras[j].lower() or 'what our data is saying' in paras[j].lower():\n","                        end_of_block_idx = j\n","                        break\n","\n","                if end_of_block_idx != -1:\n","                    first_line = paras[i]\n","                    parts = re.split(r'(: |\\.[ ](?=[A-Z]))', first_line, 1)\n","\n","                    if len(parts) == 3:\n","                        title = (parts[0] + parts[1]).strip()\n","                        description_parts = [parts[2].strip()]\n","                        description_parts.extend(paras[i+1:end_of_block_idx])\n","                        description = \"\\n\".join(part for part in description_parts if part)\n","                    else:\n","                        title = first_line.rstrip(':').rstrip('.')\n","                        description = \"\\n\".join(paras[i+1:end_of_block_idx])\n","\n","                    data_insight_raw = paras[end_of_block_idx]\n","                    data_insight = re.sub(r'\\*?\\s?What our data (shows|is saying):\\s?', '', data_insight_raw, flags=re.IGNORECASE).strip()\n","\n","                    content['headlines'].append({\n","                        'title': title,\n","                        'description': description,\n","                        'data_insight': data_insight\n","                    })\n","                    i = end_of_block_idx + 1\n","                else:\n","                    break\n","    except (ValueError, IndexError) as e:\n","        print(f\"Warning: Could not parse Headlines. Check document structure. Error: {e}\")\n","\n","    return content, paras\n","\n","def generate_key_takeaways(headlines):\n","    \"\"\"\n","    Generates three key takeaways based on the parsed headlines.\n","    \"\"\"\n","    if not headlines or len(headlines) < 3:\n","        return [\"Review document content; could not generate all takeaways.\"]\n","\n","    takeaways = [\n","        \"Heightened geopolitical risk between the EU and US over tariffs could be driving up borrowing costs and short interest in exposed European sectors.\",\n","        \"The rising cost-to-borrow in the technology sector may signal that investors are simultaneously hedging against pullbacks within the high-flying sector.\",\n","        \"A moderation in China's economic growth indicators may be making investors more cautious on equities in the region.\"\n","    ]\n","    return takeaways\n","\n","# --- 2. HTML Generation ---\n","\n","def create_digest_html(content, table_html_tuple, takeaways):\n","    \"\"\"\n","    Generates the final HTML for the digest by populating a template.\n","    \"\"\"\n","    if not content:\n","        return \"<h1>Error: Could not parse content from DOCX file.</h1>\"\n","\n","    ht_borrow_table, squeeze_table = table_html_tuple\n","\n","    def format_market_note_change(value):\n","        color = '#16a34a' if value > 0 else '#dc2626'\n","        sign = '+' if value > 0 else ''\n","        return f'<span style=\"color:{color}; font-size:14px;\">{sign}{value:.2f}%</span>'\n","\n","    market_notes = content.get('market_notes', {})\n","    avg_fee_bps = market_notes.get('avg_fee_bps', 'N/A')\n","    avg_fee_change = format_market_note_change(market_notes.get('avg_fee_change', 0))\n","    avg_util_percent = market_notes.get('avg_util_percent', 'N/A')\n","    avg_util_change = format_market_note_change(market_notes.get('avg_util_change', 0))\n","\n","    headlines_html = \"\"\n","    for headline in content.get('headlines', []):\n","        headlines_html += f\"\"\"\n","        <div style=\"margin-top:20px;\">\n","            <strong style=\"font-size:16px;\">{headline['title']}</strong>\n","            <p style=\"margin:5px 0 0; white-space: pre-wrap;\">{headline['description']}</p>\n","            <ul style=\"margin:10px 0 0; padding-left:20px; color:#334155; list-style-type: disc;\">\n","              <li><strong>What Our Data Shows:</strong> {headline['data_insight']}</li>\n","            </ul>\n","        </div>\n","        \"\"\"\n","\n","    takeaways_html = \"\".join([f\"<li>{item}</li>\" for item in takeaways])\n","\n","    html_template = f\"\"\"\n","<!DOCTYPE html>\n","<html lang=\"en\">\n","<head>\n","  <meta charset=\"UTF-8\">\n","  <title>EquiLend D&A Daily Digest - {datetime.now().strftime('%B %d, %Y')}</title>\n","</head>\n","<body style=\"margin:0; padding:0; font-family: Arial, sans-serif; background-color:#f1f5f9;\">\n","  <table width=\"100%\" cellpadding=\"0\" cellspacing=\"0\" border=\"0\" bgcolor=\"#f1f5f9\">\n","    <tr>\n","      <td align=\"center\">\n","        <table width=\"800\" cellpadding=\"0\" cellspacing=\"0\" border=\"0\" bgcolor=\"#ffffff\" style=\"margin:20px 0; border-radius:4px; overflow:hidden;\">\n","          <!-- Header -->\n","          <tr>\n","            <td bgcolor=\"#0284c7\" style=\"padding:20px; text-align:center;\">\n","              <h1 style=\"margin:0; font-size:24px; color:#ffffff;\">EquiLend D&amp;A Daily Digest</h1>\n","              <p style=\"margin:5px 0 0; font-size:16px; color:#bae6fd;\">{datetime.now().strftime('%B %d, %Y')}</p>\n","            </td>\n","          </tr>\n","          <!-- Content -->\n","          <tr>\n","            <td style=\"padding:20px; color:#333333; font-size:14px; line-height:1.5;\">\n","\n","              <!-- Market Notes -->\n","              <h2 style=\"font-size:18px; margin-bottom:10px; color:#0284c7;\">&#x1F4BC; Market Notes</h2>\n","              <table width=\"100%\" cellpadding=\"5\" cellspacing=\"0\" border=\"0\" bgcolor=\"#f8fafc\" style=\"margin-bottom:20px;\">\n","                <tr>\n","                  <td align=\"center\">\n","                    <p style=\"margin:0; font-size:12px; color:#64748b;\">Average Fee</p>\n","                    <p style=\"margin:5px 0 0; font-size:18px; font-weight:bold; color:#334155;\">\n","                      {avg_fee_bps} bps {avg_fee_change}\n","                    </p>\n","                  </td>\n","                  <td align=\"center\">\n","                    <p style=\"margin:0; font-size:12px; color:#64748b;\">Average Utilization</p>\n","                    <p style=\"margin:5px 0 0; font-size:18px; font-weight:bold; color:#334155;\">\n","                      {avg_util_percent}% {avg_util_change}\n","                    </p>\n","                  </td>\n","                </tr>\n","              </table>\n","\n","              <!-- Headlines -->\n","              <h2 style=\"font-size:18px; margin-bottom:10px; color:#0284c7;\">&#x1F4F0; Major Headlines and What Our Data Shows</h2>\n","              {headlines_html}\n","\n","              <!-- Tables Section -->\n","              <h2 style=\"font-size:18px; margin:20px 0 10px; color:#0284c7;\">&#x1F4B6; Today's Specials and Hard-to-Borrow</h2>\n","              <table cellpadding=\"0\" cellspacing=\"0\" border=\"1\" style=\"border-collapse:collapse; margin-bottom:20px; border-color:#dddddd; font-size:12px;\" width=\"100%\">\n","                <thead>\n","                  <tr bgcolor=\"#0284c7\" style=\"color:#ffffff; font-weight:bold; text-align:left;\">\n","                    <th style=\"padding:5px 8px; white-space: nowrap;\">Ticker</th>\n","                    <th style=\"padding:5px 8px; white-space: nowrap;\">Security Description</th>\n","                    <th style=\"padding:5px 8px; white-space: nowrap;\">Industry</th>\n","                    <th style=\"padding:5px 8px; white-space: nowrap;\">Price</th>\n","                    <th style=\"padding:5px 8px; white-space: nowrap;\">Fee Band</th>\n","                    <th style=\"padding:5px 8px; white-space: nowrap;\">Fee WoW (BPS)</th>\n","                  </tr>\n","                </thead>\n","                <tbody>\n","                  {ht_borrow_table}\n","                </tbody>\n","              </table>\n","\n","              <h2 style=\"font-size:18px; margin:20px 0 10px; color:#0284c7;\">&#x1F52C; Market Technicals & Squeeze Metrics</h2>\n","              <table cellpadding=\"0\" cellspacing=\"0\" border=\"1\" style=\"border-collapse:collapse; border-color:#dddddd; font-size:12px;\" width=\"100%\">\n","                <thead>\n","                  <tr bgcolor=\"#0284c7\" style=\"color:#ffffff; font-weight:bold; text-align:left;\">\n","                    <th style=\"padding:5px 8px; white-space: nowrap;\">Ticker</th>\n","                    <th style=\"padding:5px 8px; white-space: nowrap;\">Security Description</th>\n","                    <th style=\"padding:5px 8px; white-space: nowrap;\">Industry</th>\n","                    <th style=\"padding:5px 8px; white-space: nowrap;\">Price</th>\n","                    <th style=\"padding:5px 8px; white-space: nowrap;\">SSS</th>\n","                    <th style=\"padding:5px 8px; white-space: nowrap;\">SSS WoW</th>\n","                  </tr>\n","                </thead>\n","                <tbody>\n","                  {squeeze_table}\n","                </tbody>\n","              </table>\n","\n","              <!-- Key Takeaways -->\n","              <h2 style=\"font-size:18px; margin:20px 0 10px; color:#0284c7;\">&#x1F4A1; Key Takeaways</h2>\n","              <ul style=\"padding-left:20px; color:#334155; font-size:14px; margin:0;\">\n","                {takeaways_html}\n","              </ul>\n","\n","            </td>\n","          </tr>\n","          <!-- Footer -->\n","          <tr>\n","            <td align=\"center\" style=\"padding:10px; font-size:12px; color:#64748b;\">\n","              Source: EquiLend Data &amp; Analytics\n","            </td>\n","          </tr>\n","        </table>\n","      </td>\n","    </tr>\n","  </table>\n","</body>\n","</html>\n","    \"\"\"\n","    return html_template\n","\n","# --- Main Execution ---\n","if __name__ == \"__main__\":\n","    print(\"Starting daily digest generation...\")\n","\n","    # 1. Parse content from the Word document\n","    print(f\"Reading content from '{CONTENT_DOC_PATH}'...\")\n","    parsed_content, all_paras = parse_daily_content(CONTENT_DOC_PATH)\n","\n","    # 2. Generate Key Takeaways from the parsed headlines\n","    print(\"Generating key takeaways...\")\n","    key_takeaways = generate_key_takeaways(parsed_content.get('headlines', []))\n","\n","    # 3. Get HTML for the tables from the Word document's text\n","    print(\"Parsing tables from the Word document text...\")\n","    table_html = parse_docx_tables_from_text(all_paras)\n","\n","    # 4. Generate the final HTML file\n","    print(\"Generating final HTML digest...\")\n","    final_html = create_digest_html(parsed_content, table_html, key_takeaways)\n","\n","    # 5. Save the HTML to a file\n","    with open(OUTPUT_HTML_PATH, 'w', encoding='utf-8') as f:\n","        f.write(final_html)\n","\n","    print(f\"\\nSuccessfully generated digest: {OUTPUT_HTML_PATH}\")\n","    if not parsed_content.get('headlines'):\n","        print(\"\\nWARNING: No headlines were parsed. Please check the 'Major Headlines' section in your .docx file for correct formatting.\")\n","    if not table_html[0] and not table_html[1]:\n","        print(\"\\nWARNING: No tables were found or parsed from the Word document. Please ensure they are pasted as plain text and not images.\")"],"outputs":[{"output_type":"stream","name":"stdout","text":["Starting daily digest generation...\n","Reading content from 'daily_content.docx'...\n","Error opening or parsing DOCX file: Package not found at 'daily_content.docx'\n","Generating key takeaways...\n"]},{"output_type":"error","ename":"AttributeError","evalue":"'NoneType' object has no attribute 'get'","traceback":["\u001b[0;31m---------------------------------------------------------------------------\u001b[0m","\u001b[0;31mAttributeError\u001b[0m                            Traceback (most recent call last)","\u001b[0;32m/tmp/ipython-input-3-2162941117.py\u001b[0m in \u001b[0;36m<cell line: 0>\u001b[0;34m()\u001b[0m\n\u001b[1;32m    354\u001b[0m     \u001b[0;31m# 2. Generate Key Takeaways from the parsed headlines\u001b[0m\u001b[0;34m\u001b[0m\u001b[0;34m\u001b[0m\u001b[0m\n\u001b[1;32m    355\u001b[0m     \u001b[0mprint\u001b[0m\u001b[0;34m(\u001b[0m\u001b[0;34m\"Generating key takeaways...\"\u001b[0m\u001b[0;34m)\u001b[0m\u001b[0;34m\u001b[0m\u001b[0;34m\u001b[0m\u001b[0m\n\u001b[0;32m--> 356\u001b[0;31m     \u001b[0mkey_takeaways\u001b[0m \u001b[0;34m=\u001b[0m \u001b[0mgenerate_key_takeaways\u001b[0m\u001b[0;34m(\u001b[0m\u001b[0mparsed_content\u001b[0m\u001b[0;34m.\u001b[0m\u001b[0mget\u001b[0m\u001b[0;34m(\u001b[0m\u001b[0;34m'headlines'\u001b[0m\u001b[0;34m,\u001b[0m \u001b[0;34m[\u001b[0m\u001b[0;34m]\u001b[0m\u001b[0;34m)\u001b[0m\u001b[0;34m)\u001b[0m\u001b[0;34m\u001b[0m\u001b[0;34m\u001b[0m\u001b[0m\n\u001b[0m\u001b[1;32m    357\u001b[0m \u001b[0;34m\u001b[0m\u001b[0m\n\u001b[1;32m    358\u001b[0m     \u001b[0;31m# 3. Get HTML for the tables from the Word document's text\u001b[0m\u001b[0;34m\u001b[0m\u001b[0;34m\u001b[0m\u001b[0m\n","\u001b[0;31mAttributeError\u001b[0m: 'NoneType' object has no attribute 'get'"]}],"execution_count":3,"metadata":{"colab":{"base_uri":"https://localhost:8080/","height":280},"id":"hq_kmByiXe2n","executionInfo":{"status":"error","timestamp":1753107975337,"user_tz":240,"elapsed":39,"user":{"displayName":"Bob Sheehan","userId":"08159093702253523584"}},"outputId":"980ccd90-62d4-4680-c840-dfc78c622b6a"}}],"metadata":{"colab":{"provenance":[]},"kernelspec":{"display_name":"Python 3","name":"python3"}},"nbformat":4,"nbformat_minor":0}