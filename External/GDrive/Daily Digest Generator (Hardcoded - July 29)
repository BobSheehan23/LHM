{"cells":[{"cell_type":"code","source":"import pandas as pd\nfrom datetime import datetime\nimport re\nimport numpy as np\n\n# --- Configuration ---\n# The output file will be named with today's date.\nOUTPUT_HTML_PATH = f\"equilend_daily_digest_{datetime.now().strftime('%Y_%m_%d')}.html\"\n\n# --- 1. Hardcoded Content and Data ---\n\ndef get_hardcoded_content():\n    \"\"\"\n    Returns all the text content for the digest.\n    This section can be updated with the day's specific narrative content.\n    \"\"\"\n    content = {\n        'market_notes': {\n            'avg_fee_bps': '43.95',\n            'avg_fee_change': -3.39,\n            'avg_util_percent': '6.99',\n            'avg_util_change': -0.29,\n            'on_loan_value': '3.03T',\n            'on_loan_value_change': -0.4,\n            'lendable_value': '43.28T',\n            'lendable_value_change': -0.11\n        },\n        'headlines': [\n            {\n                'title': 'Hedge Funds Aggressively Cover Shorts While Remaining Underweight Tech',\n                'description': 'Last week saw a significant short-covering rally by hedge funds, a 3-standard deviation event, yet their overall positioning remains net short. In a notable rotation, hedge funds have been unwinding risk in TMT (Technology, Media, and Telecom) stocks at the fastest pace in a year, leading to a historic underweight in the tech sector versus the MSCI World Index. Concurrently, they have been increasing their exposure to consumer staples, which is now at a multi-year high.',\n                'data_insight': 'This rotation is visible in our data. The Technology Select Sector SPDR Fund (XLK) has seen its on-loan quantity decrease by 1.5M shares over the past week, while the Consumer Staples Select Sector SPDR Fund (XLP) saw its on-loan quantity increase by over 800k shares in the same period, which may reflect this shift in hedge fund positioning.'\n            },\n            {\n                'title': 'S&P 500, NASDAQ Continue Record Setting Run, Driven by Tech Earnings and AI Optimism',\n                'description': 'Both the S&P 500 and Nasdaq Composite indices have pushed to new record highs, marking their fourth weekly gain in the past five. This upward momentum is largely attributed to stronger-than-expected corporate earnings, particularly from \"Magnificent Seven\" tech giants like Alphabet, and continued enthusiasm surrounding advancements in artificial intelligence. The Magnificent 7 has now recouped its losses from December and reached a new all-time high.',\n                'data_insight': 'As broad markets rally, we are seeing a corresponding decrease in short interest for major index ETFs. The SPDR S&P 500 ETF Trust (SPY) has seen its on-loan quantity decrease by approximately 4.8 million shares over the past week, which could signal that institutional investors are reducing their hedges in response to the positive market momentum.'\n            },\n            {\n                'title': 'Plant-based Protein Products the latest in Meme-Stock Mania',\n                'description': 'Beyond Meat (BYND) and Above Food Ingredients (ABVE) saw sharp price spikes last week, driven by a surge in retail trading volume and social media momentum. BYND jumped over 20% on high short interest, while ABVE more than doubled after announcing a reverse merger tied to gold-backed digital assets. Both experienced extreme volatility and trading halts, with analysts flagging the moves as speculative and disconnected from underlying business fundamentals.',\n                'data_insight': 'Beyond Meat (BYND) has seen its active utilization sit consistently above 90% as on loan quantity has reached a near all-time peak of over 28 million shares. Likewise, Above Food Ingredients (ABVE) has seen heightened short interest with borrowing costs at an all-time high of over 52,000 bps and On Loan Quantity surpassing 2 million shares for the first time ever in the last month.'\n            }\n        ],\n        'key_takeaways': [\n            \"Despite a major short-covering rally, hedge funds appear to be rotating out of technology and into consumer staples, a defensive move that could signal caution about the tech sector's high valuations.\",\n            \"The record-setting run in major US indices is being accompanied by a decrease in short interest for broad market ETFs, suggesting that institutional investors are becoming more confident in the rally's durability.\",\n            \"A resurgence in meme-stock activity, particularly in the plant-based protein sector, is leading to extreme volatility and heightened short interest, indicating a highly speculative environment for these names.\"\n        ]\n    }\n    return content\n\ndef get_hardcoded_tables_html():\n    \"\"\"\n    Returns HTML for the two data tables using the hardcoded data for July 29.\n    \"\"\"\n    # Data for \"Hot & Getting Hotter\"\n    ht_borrow_data = [\n        {\"TICKER\": \"FOXX\", \"Company Name\": \"FOXX DEVELOPMENT\", \"Industry\": \"Tech Hardware & Equip\", \"Price\": \"$7.22\", \"FeeWoW (bps)\": \"2875\"},\n        {\"TICKER\": \"CYCC\", \"Company Name\": \"CYCLACEL PHARMA\", \"Industry\": \"Biotechnology\", \"Price\": \"$15.39\", \"FeeWoW (bps)\": \"16324.92\"},\n        {\"TICKER\": \"NDRA\", \"Company Name\": \"ENDRA LIFE SCIENCES\", \"Industry\": \"Health Care Equip\", \"Price\": \"$6.35\", \"FeeWoW (bps)\": \"6240.95\"},\n        {\"TICKER\": \"DGNX\", \"Company Name\": \"DIGINEX LIMITED\", \"Industry\": \"Software and Services\", \"Price\": \"$54.02\", \"FeeWoW (bps)\": \"4394.14\"},\n        {\"TICKER\": \"BMGL\", \"Company Name\": \"BASEL MEDICAL\", \"Industry\": \"Health Care Prvdrs & Srvcs\", \"Price\": \"$2.24\", \"FeeWoW (bps)\": \"1617.43\"},\n    ]\n\n    # Data for \"Market Technicals & Squeeze Metrics\"\n    squeeze_data = [\n        {\"TICKER\": \"STEM\", \"Company Name\": \"STEM INC COM (REV SPT)\", \"Industry\": \"Capital Goods\", \"Price\": \"$18.91\", \"SSS\": 91, \"SSS WoW\": \"52\"},\n        {\"TICKER\": \"VOR\", \"Company Name\": \"VOR BIOPHARMA INC\", \"Industry\": \"Biotechnology\", \"Price\": \"$2.42\", \"SSS\": 89, \"SSS WoW\": \"0\"},\n        {\"TICKER\": \"ABVX FP\", \"Company Name\": \"ABIVAX\", \"Industry\": \"Biotechnology\", \"Price\": \"$66.24\", \"SSS\": 88, \"SSS WoW\": \"25\"},\n        {\"TICKER\": \"WOLF\", \"Company Name\": \"WOLFSPEED INC COM\", \"Industry\": \"Semis & Equip\", \"Price\": \"$1.68\", \"SSS\": 85, \"SSS WoW\": \"20\"},\n        {\"TICKER\": \"ABAT\", \"Company Name\": \"AMERICAN BATTERY\", \"Industry\": \"Metals & Mining\", \"Price\": \"$2.88\", \"SSS\": 83, \"SSS WoW\": \"15\"},\n    ]\n\n    def format_change(value, unit=' BPS'):\n        try:\n            cleaned_value = str(value).replace(',', '').strip()\n            val = float(cleaned_value)\n            color = '#16a34a' if val > 0 else '#dc2626'\n            sign = '+' if val > 0 else ''\n            return f'<span style=\"color:{color}; font-size:14px;\">{sign}{val:,.2f}{unit}</span>'\n        except (ValueError, TypeError):\n            return str(value).strip() if pd.notna(value) else ''\n            \n    ht_borrow_html = \"\"\n    for row in ht_borrow_data:\n        ht_borrow_html += f\"\"\"\n        <tr style=\"font-size:12px; background-color:#ffffff; text-align:left;\">\n            <td style=\"padding:4px 8px;\">{row.get(\"TICKER\", \"\")}</td>\n            <td style=\"padding:4px 8px;\">{row.get(\"Company Name\", \"\")}</td>\n            <td style=\"padding:4px 8px;\">{row.get(\"Industry\", \"\")}</td>\n            <td style=\"padding:4px 8px;\">{row.get(\"Price\", \"\")}</td>\n            <td style=\"padding:4px 8px;\">{format_change(row.get(\"FeeWoW (bps)\"))}</td>\n        </tr>\"\"\"\n\n    squeeze_html = \"\"\n    for row in squeeze_data:\n        squeeze_html += f\"\"\"\n        <tr style=\"font-size:12px; background-color:#ffffff; text-align:left;\">\n            <td style=\"padding:4px 8px;\">{row.get(\"TICKER\", \"\")}</td>\n            <td style=\"padding:4px 8px;\">{row.get(\"Company Name\", \"\")}</td>\n            <td style=\"padding:4px 8px;\">{row.get(\"Industry\", \"\")}</td>\n            <td style=\"padding:4px 8px;\">{row.get(\"Price\", \"\")}</td>\n            <td style=\"padding:4px 8px;\">{row.get(\"SSS\", \"\")}</td>\n            <td style=\"padding:4px 8px;\">{format_change(row.get(\"SSS WoW\"), unit=\"\")}</td>\n        </tr>\"\"\"\n        \n    return ht_borrow_html, squeeze_html\n\n\n# --- 2. HTML Generation ---\n\ndef create_digest_html(content, table_html_tuple):\n    \"\"\"\n    Generates the final HTML for the digest by populating a template.\n    \"\"\"\n    if not content:\n        return \"<h1>Error: Could not generate content.</h1>\"\n        \n    ht_borrow_table, squeeze_table = table_html_tuple\n    \n    def format_market_note_change(value):\n        color = '#16a34a' if value > 0 else '#dc2626'\n        sign = '+' if val > 0 else ''\n        return f'<span style=\"color:{color}; font-size:14px;\">{sign}{value:.2f}%</span>'\n\n    market_notes = content.get('market_notes', {})\n    avg_fee_bps = market_notes.get('avg_fee_bps', 'N/A')\n    avg_fee_change = format_market_note_change(market_notes.get('avg_fee_change', 0))\n    avg_util_percent = market_notes.get('avg_util_percent', 'N/A')\n    avg_util_change = format_market_note_change(market_notes.get('avg_util_change', 0))\n    on_loan_value = market_notes.get('on_loan_value', 'N/A')\n    on_loan_value_change = format_market_note_change(market_notes.get('on_loan_value_change', 0))\n    lendable_value = market_notes.get('lendable_value', 'N/A')\n    lendable_value_change = format_market_note_change(market_notes.get('lendable_value_change', 0))\n\n    headlines_html = \"\"\n    for headline in content.get('headlines', []):\n        headlines_html += f\"\"\"\n        <div style=\"margin-top:20px;\">\n            <strong style=\"font-size:16px;\">{headline['title']}</strong>\n            <p style=\"margin:5px 0 0; white-space: pre-wrap;\">{headline['description']}</p>\n            <ul style=\"margin:10px 0 0; padding-left:20px; color:#334155; list-style-type: disc;\">\n              <li><strong>What Our Data Shows:</strong> {headline['data_insight']}</li>\n            </ul>\n        </div>\n        \"\"\"\n        \n    takeaways_html = \"\".join([f\"<li>{item}</li>\" for item in content.get('key_takeaways', [])])\n\n    html_template = f\"\"\"\n<!DOCTYPE html>\n<html lang=\"en\">\n<head>\n  <meta charset=\"UTF-8\">\n  <title>EquiLend D&A Daily Digest - July 29, 2025</title>\n</head>\n<body style=\"margin:0; padding:0; font-family: Arial, sans-serif; background-color:#f1f5f9;\">\n  <table width=\"100%\" cellpadding=\"0\" cellspacing=\"0\" border=\"0\" bgcolor=\"#f1f5f9\">\n    <tr>\n      <td align=\"center\">\n        <table width=\"800\" cellpadding=\"0\" cellspacing=\"0\" border=\"0\" bgcolor=\"#ffffff\" style=\"margin:20px 0; border-radius:4px; overflow:hidden;\">\n          <!-- Header -->\n          <tr>\n            <td bgcolor=\"#0284c7\" style=\"padding:20px; text-align:center;\">\n              <h1 style=\"margin:0; font-size:24px; color:#ffffff;\">EquiLend D&amp;A Daily Digest</h1>\n              <p style=\"margin:5px 0 0; font-size:16px; color:#bae6fd;\">July 29, 2025</p>\n            </td>\n          </tr>\n          <!-- Content -->\n          <tr>\n            <td style=\"padding:20px; color:#334155; font-size:14px; line-height:1.5;\">\n              \n              <!-- Market Notes -->\n              <h2 style=\"font-size:18px; margin-bottom:10px; color:#0284c7;\">&#x1F4BC; Market Notes</h2>\n              <table width=\"100%\" cellpadding=\"5\" cellspacing=\"0\" border=\"0\" bgcolor=\"#f8fafc\" style=\"margin-bottom:20px;\">\n                <tr>\n                  <td align=\"center\" width=\"50%\">\n                    <p style=\"margin:0; font-size:12px; color:#64748b;\">Average Fee</p>\n                    <p style=\"margin:5px 0 0; font-size:18px; font-weight:bold; color:#334155;\">\n                      {avg_fee_bps} bps {avg_fee_change}\n                    </p>\n                  </td>\n                  <td align=\"center\" width=\"50%\">\n                    <p style=\"margin:0; font-size:12px; color:#64748b;\">Average Utilization</p>\n                    <p style=\"margin:5px 0 0; font-size:18px; font-weight:bold; color:#334155;\">\n                      {avg_util_percent}% {avg_util_change}\n                    </p>\n                  </td>\n                </tr>\n                <tr>\n                  <td align=\"center\" width=\"50%\">\n                    <p style=\"margin:0; font-size:12px; color:#64748b;\">On Loan Value</p>\n                    <p style=\"margin:5px 0 0; font-size:18px; font-weight:bold; color:#334155;\">\n                      ${on_loan_value} {on_loan_value_change}\n                    </p>\n                  </td>\n                  <td align=\"center\" width=\"50%\">\n                    <p style=\"margin:0; font-size:12px; color:#64748b;\">Total Lendable Value</p>\n                    <p style=\"margin:5px 0 0; font-size:18px; font-weight:bold; color:#334155;\">\n                      ${lendable_value} {lendable_value_change}\n                    </p>\n                  </td>\n                </tr>\n              </table>\n    \n              <!-- Headlines -->\n              <h2 style=\"font-size:18px; margin-bottom:10px; color:#0284c7;\">&#x1F4F0; Major Headlines and What Our Data Shows</h2>\n              {headlines_html}\n\n              <!-- Tables Section -->\n              <h2 style=\"font-size:18px; margin:20px 0 10px; color:#0284c7;\">&#x1F525; Hot & Getting Hotter</h2>\n              <table cellpadding=\"0\" cellspacing=\"0\" border=\"1\" style=\"border-collapse:collapse; margin-bottom:20px; border-color:#dddddd; font-size:12px;\" width=\"100%\">\n                <thead>\n                  <tr bgcolor=\"#0284c7\" style=\"color:#ffffff; font-weight:bold; text-align:left;\">\n                    <th style=\"padding:5px 8px; white-space: nowrap;\">Ticker</th>\n                    <th style=\"padding:5px 8px; white-space: nowrap;\">Company Name</th>\n                    <th style=\"padding:5px 8px; white-space: nowrap;\">Industry</th>\n                    <th style=\"padding:5px 8px; white-space: nowrap;\">Price</th>\n                    <th style=\"padding:5px 8px; white-space: nowrap;\">FeeWoW (bps)</th>\n                  </tr>\n                </thead>\n                <tbody>\n                  {ht_borrow_html}\n                </tbody>\n              </table>\n    \n              <h2 style=\"font-size:18px; margin:20px 0 10px; color:#0284c7;\">&#x1F52C; Market Technicals & Squeeze Metrics</h2>\n              <table cellpadding=\"0\" cellspacing=\"0\" border=\"1\" style=\"border-collapse:collapse; border-color:#dddddd; font-size:12px;\" width=\"100%\">\n                <thead>\n                  <tr bgcolor=\"#0284c7\" style=\"color:#ffffff; font-weight:bold; text-align:left;\">\n                    <th style=\"padding:5px 8px; white-space: nowrap;\">Ticker</th>\n                    <th style=\"padding:5px 8px; white-space: nowrap;\">Company Name</th>\n                    <th style=\"padding:5px 8px; white-space: nowrap;\">Industry</th>\n                    <th style=\"padding:5px 8px; white-space: nowrap;\">Price</th>\n                    <th style=\"padding:5px 8px; white-space: nowrap;\">Short Squeeze Score (SSS)</th>\n                    <th style=\"padding:5px 8px; white-space: nowrap;\">SSS WoW</th>\n                  </tr>\n                </thead>\n                <tbody>\n                  {squeeze_table}\n                </tbody>\n              </table>\n              \n              <!-- Key Takeaways -->\n              <h2 style=\"font-size:18px; margin:20px 0 10px; color:#0284c7;\">&#x1F4A1; Key Takeaways</h2>\n              <ul style=\"padding-left:20px; color:#334155; font-size:14px; margin:0;\">\n                {takeaways_html}\n              </ul>\n    \n            </td>\n          </tr>\n          <!-- Footer -->\n          <tr>\n            <td align=\"center\" style=\"padding:10px; font-size:12px; color:#64748b;\">\n              Source: EquiLend Data &amp; Analytics\n            </td>\n          </tr>\n        </table>\n      </td>\n    </tr>\n  </table>\n</body>\n</html>\n    \"\"\"\n    return html_template\n\n# --- Main Execution ---\nif __name__ == \"__main__\":\n    print(\"Starting daily digest generation...\")\n\n    # 1. Get hardcoded content\n    print(\"Loading hardcoded content...\")\n    hardcoded_content = get_hardcoded_content()\n\n    # 2. Get HTML for the hardcoded tables\n    print(\"Generating tables from hardcoded data...\")\n    table_html = get_hardcoded_tables_html()\n\n    # 3. Generate the final HTML file\n    print(\"Generating final HTML digest...\")\n    final_html = create_digest_html(hardcoded_content, table_html)\n\n    # 4. Save the HTML to a file\n    with open(OUTPUT_HTML_PATH, 'w', encoding='utf-8') as f:\n        f.write(final_html)\n\n    print(f\"\\nSuccessfully generated digest: {OUTPUT_HTML_PATH}\")\n    print(\"This version is fully hardcoded and does not depend on external files.\")","outputs":[],"execution_count":null,"metadata":{}}],"metadata":{"colab":{"from_bard":true},"kernelspec":{"display_name":"Python 3","name":"python3"}},"nbformat":4,"nbformat_minor":0}