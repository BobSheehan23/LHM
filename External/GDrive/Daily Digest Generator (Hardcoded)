{"cells":[{"cell_type":"code","source":["import pandas as pd\n","from datetime import datetime\n","import re\n","import numpy as np\n","\n","# --- Configuration ---\n","# The output file will be named with today's date.\n","OUTPUT_HTML_PATH = f\"equilend_daily_digest_{datetime.now().strftime('%Y_%m_%d')}.html\"\n","\n","# --- 1. Hardcoded Content and Data ---\n","\n","def get_hardcoded_content():\n","    \"\"\"\n","    Returns all the text content for the digest.\n","    This section can be updated with the day's specific narrative content.\n","    \"\"\"\n","    content = {\n","        'market_notes': {\n","            'avg_fee_bps': '44.77',\n","            'avg_fee_change': -1.58,\n","            'avg_util_percent': '7.08',\n","            'avg_util_change': 0.87,\n","            'on_loan_value': '3.06T',\n","            'on_loan_value_change': 0.84,\n","            'lendable_value': '43.31T',\n","            'lendable_value_change': -0.02\n","        },\n","        'headlines': [\n","            {\n","                'title': 'US and EU Reach Trade Deal:',\n","                'description': 'The U.S. and the European Union reached a new framework agreement: most EU exports to the U.S. will now face a 15% tariff, half of the previously threatened 30–50%. It includes up to $600 billion in EU investment pledges in the U.S. Investors welcomed this as a trade war averted, pushing European and U.S. equity futures higher. Key sectors like pharmaceuticals, automotives and beer companies (e.g. Heineken) stand to benefit.',\n","                'data_insight': 'The positive trade news appears to be reducing hedging demand for sectors most exposed to international tariffs. Our data for the SPDR S&P Kensho New Economies Composite ETF (KOMP), which has significant exposure to global supply chains, shows a one-day decrease in shares on loan of over 1.2 million. A reduction in short interest for a globally-focused ETF like this may indicate increased investor optimism.'\n","            },\n","            {\n","                'title': 'Tesla and Samsung Announce $16.5B Deal:',\n","                'description': 'Elon Musk confirmed a $16.5 billion chip supply agreement with Samsung, which will manufacture Tesla’s AI6 processors at its new Texas fab. Samsung shares soared nearly 7%. This adds momentum in semiconductor competition with TSMC.',\n","                'data_insight': 'The global technology sector has seen a meteoric rise in 2025 with the influx of AI investment and semiconductor supply concerns following the tariff fallouts. This has led to our data seeing a significant upturn in short interest for tech names as borrowing costs have risen to 220 bps, up from between 80 and 90 bps before the April tariff announcements with the volume of shares on loan following a similar trend.'\n","            },\n","            {\n","                'title': 'Wall Street ‘Euphoria’ continues renewed meme-stock frenzy:',\n","                'description': 'A fresh wave of meme-stock mania hit Wall Street last week, with retail traders piling into names like GoPro, Krispy Kreme, and Beyond Meat. GoPro shares surged nearly 50% last week before easing, driven more by hype and social media buzz than fundamentals. Analysts warn the rally echoes the speculative frenzy of 2021, with signs of excessive euphoria, short squeezes, and call-option spikes raising concerns of an overheated market.',\n","                'data_insight': 'There has been significant borrowing interest seen in GoPro Inc. (GPRO) with the durable camera producers, one of the latest trending meme-stocks. Movements in the past week have been substantial, with On Loan Quantity up 150% to 19.9M shares and borrowing costs rising to 113 bps from only 18.'\n","            }\n","        ],\n","        'key_takeaways': [\n","            \"Resolutions in major trade disputes are fueling market rallies and reducing hedging demand in globally exposed sectors.\",\n","            \"Significant corporate deals, like the one between Tesla and Samsung, are adding momentum to the already hot semiconductor and tech sectors, though rising borrowing costs suggest some investor caution remains.\",\n","            \"A renewed meme-stock frenzy, exemplified by names like GoPro, indicates a high level of speculative activity in the market, with borrowing data showing a sharp increase in short-term demand for these volatile stocks.\"\n","        ]\n","    }\n","    return content\n","\n","def get_hardcoded_tables_html():\n","    \"\"\"\n","    Returns HTML for the two data tables using the hardcoded data.\n","    \"\"\"\n","    # Data for \"Hot & Getting Hotter\"\n","    ht_borrow_data = [\n","        {\"TICKER\": \"SLRX\", \"Company Name\": \"SALARIUS PHARMACEUTICALS\", \"Industry\": \"Biotechnology\", \"Price\": \"$0.71\", \"Fee\": \"87853.7\", \"Fee WoW (bps)\": \"6269.88\"},\n","        {\"TICKER\": \"NDRA\", \"Company Name\": \"ENDRA LIFE SCIENCES\", \"Industry\": \"Health Care Equip & Supp\", \"Price\": \"$6.50\", \"Fee\": \"77637.95\", \"Fee WoW (bps)\": \"12141.88\"},\n","        {\"TICKER\": \"CYCC\", \"Company Name\": \"CYCLACEL PHARMA\", \"Industry\": \"Biotechnology\", \"Price\": \"$10.76\", \"Fee\": \"67051.55\", \"Fee WoW (bps)\": \"13979.15\"},\n","        {\"TICKER\": \"NUWE\", \"Company Name\": \"NUWELLIS\", \"Industry\": \"Health Care Equip & Supp\", \"Price\": \"$14.33\", \"Fee\": \"55957.59\", \"Fee WoW (bps)\": \"44976.39\"},\n","        {\"TICKER\": \"HTOO\", \"Company Name\": \"FUSION FUEL GREEN\", \"Industry\": \"Capital Goods\", \"Price\": \"$6.71\", \"Fee\": \"52392.45\", \"Fee WoW (bps)\": \"50877.26\"},\n","    ]\n","\n","    # Data for \"Market Technicals & Squeeze Metrics\"\n","    squeeze_data = [\n","        {\"TICKER\": \"VOR\", \"Company Name\": \"VOR BIOPHARMA\", \"Industry\": \"Biotechnology\", \"Price\": \"$2.09\", \"SSS\": 89, \"SSS Week Diff\": 1},\n","        {\"TICKER\": \"WOLF\", \"Company Name\": \"WOLFSPEED INC\", \"Industry\": \"Semiconductors & Equip\", \"Price\": \"$1.71\", \"SSS\": 85, \"SSS Week Diff\": 57},\n","        {\"TICKER\": \"ABVX\", \"Company Name\": \"ABIVAX SPON\", \"Industry\": \"Biotechnology\", \"Price\": \"$68.58\", \"SSS\": 82, \"SSS Week Diff\": 49},\n","        {\"TICKER\": \"SANA\", \"Company Name\": \"SANA BIOTECHNOLOGY\", \"Industry\": \"Biotechnology\", \"Price\": \"$5.14\", \"SSS\": 75, \"SSS Week Diff\": 9},\n","        {\"TICKER\": \"AEHR\", \"Company Name\": \"AEHR TEST SYSTEMS\", \"Industry\": \"Semiconductors & Equip\", \"Price\": \"$20.10\", \"SSS\": 76, \"SSS Week Diff\": 33},\n","    ]\n","\n","    def format_change(value, unit=' BPS'):\n","        try:\n","            cleaned_value = str(value).replace(',', '').strip()\n","            val = float(cleaned_value)\n","            color = '#16a34a' if val > 0 else '#dc2626'\n","            sign = '+' if val > 0 else ''\n","            return f'<span style=\"color:{color}; font-size:14px;\">{sign}{val:,.2f}{unit}</span>'\n","        except (ValueError, TypeError):\n","            return str(value).strip() if pd.notna(value) else ''\n","\n","    ht_borrow_html = \"\"\n","    for row in ht_borrow_data:\n","        fee_val = f\"{float(row.get('Fee', '0').replace(',', '')):,.2f}\"\n","        ht_borrow_html += f\"\"\"\n","        <tr style=\"font-size:12px; background-color:#ffffff; text-align:left;\">\n","            <td style=\"padding:4px 8px;\">{row.get(\"TICKER\", \"\")}</td>\n","            <td style=\"padding:4px 8px;\">{row.get(\"Company Name\", \"\")}</td>\n","            <td style=\"padding:4px 8px;\">{row.get(\"Industry\", \"\")}</td>\n","            <td style=\"padding:4px 8px;\">{row.get(\"Price\", \"\")}</td>\n","            <td style=\"padding:4px 8px;\">{fee_val}</td>\n","            <td style=\"padding:4px 8px;\">{format_change(row.get(\"Fee WoW (bps)\"))}</td>\n","        </tr>\"\"\"\n","\n","    squeeze_html = \"\"\n","    for row in squeeze_data:\n","        squeeze_html += f\"\"\"\n","        <tr style=\"font-size:12px; background-color:#ffffff; text-align:left;\">\n","            <td style=\"padding:4px 8px;\">{row.get(\"TICKER\", \"\")}</td>\n","            <td style=\"padding:4px 8px;\">{row.get(\"Company Name\", \"\")}</td>\n","            <td style=\"padding:4px 8px;\">{row.get(\"Industry\", \"\")}</td>\n","            <td style=\"padding:4px 8px;\">{row.get(\"Price\", \"\")}</td>\n","            <td style=\"padding:4px 8px;\">{row.get(\"SSS\", \"\")}</td>\n","            <td style=\"padding:4px 8px;\">{format_change(row.get(\"SSS Week Diff\"), unit=\"\")}</td>\n","        </tr>\"\"\"\n","\n","    return ht_borrow_html, squeeze_html\n","\n","\n","# --- 2. HTML Generation ---\n","\n","def create_digest_html(content, table_html_tuple):\n","    \"\"\"\n","    Generates the final HTML for the digest by populating a template.\n","    \"\"\"\n","    if not content:\n","        return \"<h1>Error: Could not generate content.</h1>\"\n","\n","    ht_borrow_table, squeeze_table = table_html_tuple\n","\n","    def format_market_note_change(value):\n","        color = '#16a34a' if value > 0 else '#dc2626'\n","        sign = '+' if value > 0 else ''\n","        return f'<span style=\"color:{color}; font-size:14px;\">{sign}{value:.2f}%</span>'\n","\n","    market_notes = content.get('market_notes', {})\n","    avg_fee_bps = market_notes.get('avg_fee_bps', 'N/A')\n","    avg_fee_change = format_market_note_change(market_notes.get('avg_fee_change', 0))\n","    avg_util_percent = market_notes.get('avg_util_percent', 'N/A')\n","    avg_util_change = format_market_note_change(market_notes.get('avg_util_change', 0))\n","    on_loan_value = market_notes.get('on_loan_value', 'N/A')\n","    on_loan_value_change = format_market_note_change(market_notes.get('on_loan_value_change', 0))\n","    lendable_value = market_notes.get('lendable_value', 'N/A')\n","    lendable_value_change = format_market_note_change(market_notes.get('lendable_value_change', 0))\n","\n","    headlines_html = \"\"\n","    for headline in content.get('headlines', []):\n","        headlines_html += f\"\"\"\n","        <div style=\"margin-top:20px;\">\n","            <strong style=\"font-size:16px;\">{headline['title']}</strong>\n","            <p style=\"margin:5px 0 0; white-space: pre-wrap;\">{headline['description']}</p>\n","            <ul style=\"margin:10px 0 0; padding-left:20px; color:#334155; list-style-type: disc;\">\n","              <li><strong>What Our Data Shows:</strong> {headline['data_insight']}</li>\n","            </ul>\n","        </div>\n","        \"\"\"\n","\n","    takeaways_html = \"\".join([f\"<li>{item}</li>\" for item in content.get('key_takeaways', [])])\n","\n","    html_template = f\"\"\"\n","<!DOCTYPE html>\n","<html lang=\"en\">\n","<head>\n","  <meta charset=\"UTF-8\">\n","  <title>EquiLend D&A Daily Digest - July 28, 2025</title>\n","</head>\n","<body style=\"margin:0; padding:0; font-family: Arial, sans-serif; background-color:#f1f5f9;\">\n","  <table width=\"100%\" cellpadding=\"0\" cellspacing=\"0\" border=\"0\" bgcolor=\"#f1f5f9\">\n","    <tr>\n","      <td align=\"center\">\n","        <table width=\"800\" cellpadding=\"0\" cellspacing=\"0\" border=\"0\" bgcolor=\"#ffffff\" style=\"margin:20px 0; border-radius:4px; overflow:hidden;\">\n","          <!-- Header -->\n","          <tr>\n","            <td bgcolor=\"#0284c7\" style=\"padding:20px; text-align:center;\">\n","              <h1 style=\"margin:0; font-size:24px; color:#ffffff;\">EquiLend D&amp;A Daily Digest</h1>\n","              <p style=\"margin:5px 0 0; font-size:16px; color:#bae6fd;\">July 28, 2025</p>\n","            </td>\n","          </tr>\n","          <!-- Content -->\n","          <tr>\n","            <td style=\"padding:20px; color:#333333; font-size:14px; line-height:1.5;\">\n","\n","              <!-- Market Notes -->\n","              <h2 style=\"font-size:18px; margin-bottom:10px; color:#0284c7;\">&#x1F4BC; Market Notes</h2>\n","              <table width=\"100%\" cellpadding=\"5\" cellspacing=\"0\" border=\"0\" bgcolor=\"#f8fafc\" style=\"margin-bottom:20px;\">\n","                <tr>\n","                  <td align=\"center\" width=\"50%\">\n","                    <p style=\"margin:0; font-size:12px; color:#64748b;\">Average Fee</p>\n","                    <p style=\"margin:5px 0 0; font-size:18px; font-weight:bold; color:#334155;\">\n","                      {avg_fee_bps} bps {avg_fee_change}\n","                    </p>\n","                  </td>\n","                  <td align=\"center\" width=\"50%\">\n","                    <p style=\"margin:0; font-size:12px; color:#64748b;\">Average Utilization</p>\n","                    <p style=\"margin:5px 0 0; font-size:18px; font-weight:bold; color:#334155;\">\n","                      {avg_util_percent}% {avg_util_change}\n","                    </p>\n","                  </td>\n","                </tr>\n","                <tr>\n","                  <td align=\"center\" width=\"50%\">\n","                    <p style=\"margin:0; font-size:12px; color:#64748b;\">On Loan Value</p>\n","                    <p style=\"margin:5px 0 0; font-size:18px; font-weight:bold; color:#334155;\">\n","                      ${on_loan_value} {on_loan_value_change}\n","                    </p>\n","                  </td>\n","                  <td align=\"center\" width=\"50%\">\n","                    <p style=\"margin:0; font-size:12px; color:#64748b;\">Total Lendable Value</p>\n","                    <p style=\"margin:5px 0 0; font-size:18px; font-weight:bold; color:#334155;\">\n","                      ${lendable_value} {lendable_value_change}\n","                    </p>\n","                  </td>\n","                </tr>\n","              </table>\n","\n","              <!-- Headlines -->\n","              <h2 style=\"font-size:18px; margin-bottom:10px; color:#0284c7;\">&#x1F4F0; Major Headlines and What Our Data Shows</h2>\n","              {headlines_html}\n","\n","              <!-- Tables Section -->\n","              <h2 style=\"font-size:18px; margin:20px 0 10px; color:#0284c7;\">&#x1F525; Hot & Getting Hotter</h2>\n","              <table cellpadding=\"0\" cellspacing=\"0\" border=\"1\" style=\"border-collapse:collapse; margin-bottom:20px; border-color:#dddddd; font-size:12px;\" width=\"100%\">\n","                <thead>\n","                  <tr bgcolor=\"#0284c7\" style=\"color:#ffffff; font-weight:bold; text-align:left;\">\n","                    <th style=\"padding:5px 8px; white-space: nowrap;\">Ticker</th>\n","                    <th style=\"padding:5px 8px; white-space: nowrap;\">Company Name</th>\n","                    <th style=\"padding:5px 8px; white-space: nowrap;\">Industry</th>\n","                    <th style=\"padding:5px 8px; white-space: nowrap;\">Price</th>\n","                    <th style=\"padding:5px 8px; white-space: nowrap;\">Fee (BPS)</th>\n","                    <th style=\"padding:5px 8px; white-space: nowrap;\">Fee WoW (bps)</th>\n","                  </tr>\n","                </thead>\n","                <tbody>\n","                  {ht_borrow_table}\n","                </tbody>\n","              </table>\n","\n","              <h2 style=\"font-size:18px; margin:20px 0 10px; color:#0284c7;\">&#x1F52C; Market Technicals & Squeeze Metrics</h2>\n","              <table cellpadding=\"0\" cellspacing=\"0\" border=\"1\" style=\"border-collapse:collapse; border-color:#dddddd; font-size:12px;\" width=\"100%\">\n","                <thead>\n","                  <tr bgcolor=\"#0284c7\" style=\"color:#ffffff; font-weight:bold; text-align:left;\">\n","                    <th style=\"padding:5px 8px; white-space: nowrap;\">Ticker</th>\n","                    <th style=\"padding:5px 8px; white-space: nowrap;\">Company Name</th>\n","                    <th style=\"padding:5px 8px; white-space: nowrap;\">Industry</th>\n","                    <th style=\"padding:5px 8px; white-space: nowrap;\">Price</th>\n","                    <th style=\"padding:5px 8px; white-space: nowrap;\">SSS</th>\n","                    <th style=\"padding:5px 8px; white-space: nowrap;\">SSS Week Diff</th>\n","                  </tr>\n","                </thead>\n","                <tbody>\n","                  {squeeze_table}\n","                </tbody>\n","              </table>\n","\n","              <!-- Key Takeaways -->\n","              <h2 style=\"font-size:18px; margin:20px 0 10px; color:#0284c7;\">&#x1F4A1; Key Takeaways</h2>\n","              <ul style=\"padding-left:20px; color:#334155; font-size:14px; margin:0;\">\n","                {takeaways_html}\n","              </ul>\n","\n","            </td>\n","          </tr>\n","          <!-- Footer -->\n","          <tr>\n","            <td align=\"center\" style=\"padding:10px; font-size:12px; color:#64748b;\">\n","              Source: EquiLend Data &amp; Analytics\n","            </td>\n","          </tr>\n","        </table>\n","      </td>\n","    </tr>\n","  </table>\n","</body>\n","</html>\n","    \"\"\"\n","    return html_template\n","\n","# --- Main Execution ---\n","if __name__ == \"__main__\":\n","    print(\"Starting daily digest generation...\")\n","\n","    # 1. Get hardcoded content\n","    print(\"Loading hardcoded content...\")\n","    hardcoded_content = get_hardcoded_content()\n","\n","    # 2. Get HTML for the hardcoded tables\n","    print(\"Generating tables from hardcoded data...\")\n","    table_html = get_hardcoded_tables_html()\n","\n","    # 3. Generate the final HTML file\n","    print(\"Generating final HTML digest...\")\n","    final_html = create_digest_html(hardcoded_content, table_html)\n","\n","    # 4. Save the HTML to a file\n","    with open(OUTPUT_HTML_PATH, 'w', encoding='utf-8') as f:\n","        f.write(final_html)\n","\n","    print(f\"\\nSuccessfully generated digest: {OUTPUT_HTML_PATH}\")\n","    print(\"This version is fully hardcoded and does not depend on external files.\")"],"outputs":[{"output_type":"stream","name":"stdout","text":["Starting daily digest generation...\n","Loading hardcoded content...\n","Generating tables from hardcoded data...\n","Generating final HTML digest...\n","\n","Successfully generated digest: equilend_daily_digest_2025_07_28.html\n","This version is fully hardcoded and does not depend on external files.\n"]}],"execution_count":1,"metadata":{"colab":{"base_uri":"https://localhost:8080/"},"id":"tNs5fHao_4pt","executionInfo":{"status":"ok","timestamp":1753705624975,"user_tz":240,"elapsed":2061,"user":{"displayName":"Bob Sheehan","userId":"08159093702253523584"}},"outputId":"bdd801eb-043a-4650-e2ec-16992b926c3c"}},{"cell_type":"code","source":["%pip install python-docx"],"metadata":{"colab":{"base_uri":"https://localhost:8080/"},"id":"8K-axaniCTJJ","executionInfo":{"status":"ok","timestamp":1753706593038,"user_tz":240,"elapsed":6064,"user":{"displayName":"Bob Sheehan","userId":"08159093702253523584"}},"outputId":"ffedbe37-add7-4f6c-a54d-11a39ae6746e"},"execution_count":5,"outputs":[{"output_type":"stream","name":"stdout","text":["Requirement already satisfied: python-docx in /usr/local/lib/python3.11/dist-packages (1.2.0)\n","Requirement already satisfied: lxml>=3.1.0 in /usr/local/lib/python3.11/dist-packages (from python-docx) (5.4.0)\n","Requirement already satisfied: typing_extensions>=4.9.0 in /usr/local/lib/python3.11/dist-packages (from python-docx) (4.14.1)\n"]}]},{"cell_type":"code","metadata":{"colab":{"base_uri":"https://localhost:8080/"},"id":"dc09888f","executionInfo":{"status":"ok","timestamp":1753708759968,"user_tz":240,"elapsed":38,"user":{"displayName":"Bob Sheehan","userId":"08159093702253523584"}},"outputId":"6b300311-24f1-4c81-d63c-36e6a773de79"},"source":["import pandas as pd\n","from datetime import datetime\n","import re\n","import numpy as np\n","import docx # Keep import in case other functions need it, but won't be used for content\n","\n","# --- Configuration ---\n","# The output file will be named with today's date.\n","OUTPUT_HTML_FILEBASED_PATH = f\"equilend_daily_digest_filebased_{datetime.now().strftime('%Y_%m_%d_%H_%M_%S')}.html\"\n","\n","# --- 1. Data Loading and Processing ---\n","\n","def read_daily_content_from_csv(file_path):\n","    \"\"\"\n","    Reads content and table data from a single CSV file.\n","    Assumes specific columns ('Section', 'Type', 'Value', 'Change', 'Title', 'Description', 'Data Insight', 'Takeaway')\n","    and sections ('Market Notes', 'Headline', 'Key Takeaway', 'Hot & Getting Hotter Table', 'Squeeze Metrics Table')\n","    within the CSV.\n","    \"\"\"\n","    content = {\n","        'market_notes': {},\n","        'headlines': [],\n","        'key_takeaways': []\n","    }\n","    tables = {\n","        'ht_borrow_df': pd.DataFrame(),\n","        'squeeze_df': pd.DataFrame()\n","    }\n","\n","    try:\n","        df = pd.read_csv(file_path)\n","\n","        # Extract Market Notes\n","        market_notes_df = df[df['Section'] == 'Market Notes']\n","        if not market_notes_df.empty:\n","            for index, row in market_notes_df.iterrows():\n","                note_type = row.get('Type', '').strip()\n","                if note_type == 'Average Fee':\n","                    content['market_notes']['avg_fee_bps'] = str(row.get('Value', 'N/A')).strip()\n","                    try:\n","                        content['market_notes']['avg_fee_change'] = float(str(row.get('Change', 0)).strip())\n","                    except (ValueError, TypeError):\n","                         content['market_notes']['avg_fee_change'] = 0\n","                elif note_type == 'Average Utilization':\n","                     content['market_notes']['avg_util_percent'] = str(row.get('Value', 'N/A')).strip()\n","                     try:\n","                        content['market_notes']['avg_util_change'] = float(str(row.get('Change', 0)).strip())\n","                     except (ValueError, TypeError):\n","                         content['market_notes']['avg_util_change'] = 0\n","                elif note_type == 'On Loan Value':\n","                     content['market_notes']['on_loan_value'] = str(row.get('Value', 'N/A')).strip()\n","                     try:\n","                        content['market_notes']['on_loan_value_change'] = float(str(row.get('Change', 0)).strip())\n","                     except (ValueError, TypeError):\n","                         content['market_notes']['on_loan_value_change'] = 0\n","                elif note_type == 'Total Lendable Value':\n","                     content['market_notes']['lendable_value'] = str(row.get('Value', 'N/A')).strip()\n","                     try:\n","                        content['market_notes']['lendable_value_change'] = float(str(row.get('Change', 0)).strip())\n","                     except (ValueError, TypeError):\n","                         content['market_notes']['lendable_value_change'] = 0\n","\n","        # Extract Headlines\n","        headlines_df = df[df['Section'] == 'Headline'].replace({np.nan: None})\n","        if not headlines_df.empty:\n","            for index, row in headlines_df.iterrows():\n","                content['headlines'].append({\n","                    'title': row.get('Title', ''),\n","                    'description': row.get('Description', ''),\n","                    'data_insight': row.get('Data Insight', '')\n","                })\n","\n","        # Extract Key Takeaways\n","        takeaways_df = df[df['Section'] == 'Key Takeaway'].replace({np.nan: None})\n","        if not takeaways_df.empty:\n","            for index, row in takeaways_df.iterrows():\n","                takeaway_text = row.get('Takeaway', '').strip()\n","                if takeaway_text:\n","                    content['key_takeaways'].append(takeaway_text)\n","\n","        # Extract Hot & Getting Hotter Table\n","        ht_borrow_table_start_index = df[df['Section'] == 'Hot & Getting Hotter Table'].index\n","        if not ht_borrow_table_start_index.empty:\n","            start_index = ht_borrow_table_start_index[0] + 1\n","            # Find the next section header to determine the end of the table data\n","            next_section_indices = df[df['Section'].isin(['Market Notes', 'Headline', 'Key Takeaway', 'Squeeze Metrics Table'])].index\n","            end_index = df.shape[0] # Default to end of dataframe\n","            for idx in next_section_indices:\n","                if idx > start_index:\n","                    end_index = idx\n","                    break\n","            tables['ht_borrow_df'] = df.iloc[start_index:end_index].copy().dropna(axis=1, how='all') # Drop empty columns\n","\n","        # Extract Market Technicals & Squeeze Metrics Table\n","        squeeze_table_start_index = df[df['Section'] == 'Squeeze Metrics Table'].index\n","        if not squeeze_table_start_index.empty:\n","            start_index = squeeze_table_start_index[0] + 1\n","            # Find the next section header to determine the end of the table data\n","            next_section_indices = df[df['Section'].isin(['Market Notes', 'Headline', 'Key Takeaway', 'Hot & Getting Hotter Table'])].index\n","            end_index = df.shape[0] # Default to end of dataframe\n","            for idx in next_section_indices:\n","                if idx > start_index:\n","                    end_index = idx\n","                    break\n","            tables['squeeze_df'] = df.iloc[start_index:end_index].copy().dropna(axis=1, how='all') # Drop empty columns\n","\n","\n","    except FileNotFoundError:\n","        print(f\"Error: Content file not found at {file_path}\")\n","        return None, None\n","    except Exception as e:\n","        print(f\"Error reading content from CSV file {file_path}: {e}\")\n","        return None, None\n","\n","    return content, tables\n","\n","\n","def read_csv_table(file_path):\n","    \"\"\"Reads a CSV file into a pandas DataFrame.\"\"\"\n","    try:\n","        df = pd.read_csv(file_path)\n","        return df\n","    except FileNotFoundError:\n","        print(f\"Error: File not found at {file_path}\")\n","        return pd.DataFrame()\n","    except Exception as e:\n","        print(f\"Error reading CSV file {file_path}: {e}\")\n","        return pd.DataFrame()\n","\n","def format_change(value, unit=' BPS'):\n","    try:\n","        cleaned_value = str(value).replace(',', '').strip()\n","        val = float(cleaned_value)\n","        color = '#16a34a' if val > 0 else '#dc2626'\n","        sign = '+' if val > 0 else ''\n","        return f'<span style=\"color:{color}; font-size:14px;\">{sign}{val:,.2f}{unit}</span>'\n","    except (ValueError, TypeError):\n","        return str(value).strip() if pd.notna(value) else ''\n","\n","def dataframe_to_html_table(df, format_change_cols=None):\n","    \"\"\"Converts a pandas DataFrame to an HTML table string.\"\"\"\n","    if df.empty:\n","        return \"<p>No data available.</p>\"\n","\n","    if format_change_cols is None:\n","        format_change_cols = []\n","\n","    html = \"\"\"\n","    <table cellpadding=\"0\" cellspacing=\"0\" border=\"1\" style=\"border-collapse:collapse; margin-bottom:20px; border-color:#dddddd; font-size:12px;\" width=\"100%\">\n","      <thead>\n","        <tr bgcolor=\"#0284c7\" style=\"color:#ffffff; font-weight:bold; text-align:left;\">\n","    \"\"\"\n","    for col in df.columns:\n","        html += f'<th style=\"padding:5px 8px; white-space: nowrap;\">{col}</th>'\n","    html += \"\"\"\n","        </tr>\n","      </thead>\n","      <tbody>\n","    \"\"\"\n","    for index, row in df.iterrows():\n","        html += '<tr style=\"font-size:12px; background-color:#ffffff; text-align:left;\">'\n","        for col in df.columns:\n","            cell_value = row[col]\n","            if col in format_change_cols:\n","                 # Apply special formatting for Fee WoW (bps) or SSS Week Diff\n","                 html += f'<td style=\"padding:4px 8px;\">{format_change(cell_value, unit=\"\" if \"SSS Week Diff\" in col else \" BPS\")}</td>'\n","            else:\n","                 # Apply formatting for Fee (BPS) column\n","                 if col == 'Fee (BPS)':\n","                     try:\n","                         fee_val = f\"{float(str(cell_value).replace(',', '')):,.2f}\"\n","                         html += f'<td style=\"padding:4px 8px;\">{fee_val}</td>'\n","                     except (ValueError, TypeError):\n","                         html += f'<td style=\"padding:4px 8px;\">{str(cell_value).strip() if pd.notna(cell_value) else \"\"}</td>'\n","                 else:\n","                     html += f'<td style=\"padding:4px 8px;\">{str(cell_value).strip() if pd.notna(cell_value) else \"\"}</td>'\n","        html += '</tr>'\n","    html += \"\"\"\n","      </tbody>\n","    </table>\n","    \"\"\"\n","    return html\n","\n","# --- 2. HTML Generation ---\n","\n","def create_digest_html(content, ht_borrow_html, squeeze_html):\n","    \"\"\"\n","    Generates the final HTML for the digest by populating a template.\n","    \"\"\"\n","    if not content:\n","        return \"<h1>Error: Could not generate content.</h1>\"\n","\n","    def format_market_note_change(value):\n","        color = '#16a34a' if value > 0 else '#dc2626'\n","        sign = '+' if value > 0 else ''\n","        return f'<span style=\"color:{color}; font-size:14px;\">{sign}{value:.2f}%</span>'\n","\n","    market_notes = content.get('market_notes', {})\n","    avg_fee_bps = market_notes.get('avg_fee_bps', 'N/A')\n","    avg_fee_change = format_market_note_change(market_notes.get('avg_fee_change', 0))\n","    avg_util_percent = market_notes.get('avg_util_percent', 'N/A')\n","    avg_util_change = format_market_note_change(market_notes.get('avg_util_change', 0))\n","    on_loan_value = market_notes.get('on_loan_value', 'N/A')\n","    on_loan_value_change = format_market_note_change(market_notes.get('on_loan_value_change', 0))\n","    lendable_value = market_notes.get('lendable_value', 'N/A')\n","    lendable_value_change = format_market_note_change(market_notes.get('lendable_value_change', 0))\n","\n","    headlines_html = \"\"\n","    for headline in content.get('headlines', []):\n","        headlines_html += f\"\"\"\n","        <div style=\"margin-top:20px;\">\n","            <strong style=\"font-size:16px;\">{headline.get('title', '')}</strong>\n","            <p style=\"margin:5px 0 0; white-space: pre-wrap;\">{headline.get('description', '')}</p>\n","            <ul style=\"margin:10px 0 0; padding-left:20px; color:#334155; list-style-type: disc;\">\n","              <li><strong>What Our Data Shows:</strong> {headline.get('data_insight', '')}</li>\n","            </ul>\n","        </div>\n","        \"\"\"\n","\n","    takeaways_html = \"\".join([f\"<li>{item}</li>\" for item in content.get('key_takeaways', [])])\n","\n","    html_template = f\"\"\"\n","<!DOCTYPE html>\n","<html lang=\"en\">\n","<head>\n","  <meta charset=\"UTF-8\">\n","  <title>EquiLend D&A Daily Digest - July 28, 2025</title>\n","</head>\n","<body style=\"margin:0; padding:0; font-family: Arial, sans-serif; background-color:#f1f5f9;\">\n","  <table width=\"100%\" cellpadding=\"0\" cellspacing=\"0\" border=\"0\" bgcolor=\"#f1f5f9\">\n","    <tr>\n","      <td align=\"center\">\n","        <table width=\"800\" cellpadding=\"0\" cellspacing=\"0\" border=\"0\" bgcolor=\"#ffffff\" style=\"margin:20px 0; border-radius:4px; overflow:hidden;\">\n","          <!-- Header -->\n","          <tr>\n","            <td bgcolor=\"#0284c7\" style=\"padding:20px; text-align:center;\">\n","              <h1 style=\"margin:0; font-size:24px; color:#ffffff;\">EquiLend D&amp;A Daily Digest</h1>\n","              <p style=\"margin:5px 0 0; font-size:16px; color:#bae6fd;\">July 28, 2025</p>\n","            </td>\n","          </tr>\n","          <!-- Content -->\n","          <tr>\n","            <td style=\"padding:20px; color:#333333; font-size:14px; line-height:1.5;\">\n","\n","              <!-- Market Notes -->\n","              <h2 style=\"font-size:18px; margin-bottom:10px; color:#0284c7;\">&#x1F4BC; Market Notes</h2>\n","              <table width=\"100%\" cellpadding=\"5\" cellspacing=\"0\" border=\"0\" bgcolor=\"#f8fafc\" style=\"margin-bottom:20px;\">\n","                <tr>\n","                  <td align=\"center\" width=\"50%\">\n","                    <p style=\"margin:0; font-size:12px; color:#64748b;\">Average Fee</p>\n","                    <p style=\"margin:5px 0 0; font-size:18px; font-weight:bold; color:#334155;\">\n","                      {avg_fee_bps} bps {avg_fee_change}\n","                    </p>\n","                  </td>\n","                  <td align=\"center\" width=\"50%\">\n","                    <p style=\"margin:0; font-size:12px; color:#64748b;\">Average Utilization</p>\n","                    <p style=\"margin:5px 0 0; font-size:18px; font-weight:bold; color:#334155;\">\n","                      {avg_util_percent}% {avg_util_change}\n","                    </p>\n","                  </td>\n","                </tr>\n","                <tr>\n","                  <td align=\"center\" width=\"50%\">\n","                    <p style=\"margin:0; font-size:12px; color:#64748b;\">On Loan Value</p>\n","                    <p style=\"margin:5px 0 0; font-size:18px; font-weight:bold; color:#334155;\">\n","                      ${on_loan_value} {on_loan_value_change}\n","                    </p>\n","                  </td>\n","                  <td align=\"center\" width=\"50%\">\n","                    <p style=\"margin:0; font-size:12px; color:#64748b;\">Total Lendable Value</p>\n","                    <p style=\"margin:5px 0 0; font-size:18px; font-weight:bold; color:#334155;\">\n","                      ${lendable_value} {lendable_value_change}\n","                    </p>\n","                  </td>\n","                </tr>\n","              </table>\n","\n","              <!-- Headlines -->\n","              <h2 style=\"font-size:18px; margin-bottom:10px; color:#0284c7;\">&#x1F4F0; Major Headlines and What Our Data Shows</h2>\n","              {headlines_html}\n","\n","              <!-- Tables Section -->\n","              <h2 style=\"font-size:18px; margin:20px 0 10px; color:#0284c7;\">&#x1F525; Hot & Getting Hotter</h2>\n","              {ht_borrow_html}\n","\n","              <h2 style=\"font-size:18px; margin:20px 0 10px; color:#0284c7;\">&#x1F52C; Market Technicals & Squeeze Metrics</h2>\n","              {squeeze_html}\n","\n","\n","              <!-- Key Takeaways -->\n","              <h2 style=\"font-size:18px; margin:20px 0 10px; color:#0284c7;\">&#x1F4A1; Key Takeaways</h2>\n","              <ul style=\"padding-left:20px; color:#334155; font-size:14px; margin:0;\">\n","                {takeaways_html}\n","              </ul>\n","\n","            </td>\n","          </tr>\n","          <!-- Footer -->\n","          <tr>\n","            <td align=\"center\" style=\"padding:10px; font-size:12px; color:#64748b;\">\n","              Source: EquiLend Data &amp; Analytics\n","            </td>\n","          </tr>\n","        </table>\n","      </td>\n","    </tr>\n","  </table>\n","</body>\n","</html>\n","    \"\"\"\n","    return html_template\n","\n","\n","# --- Main Execution ---\n","if __name__ == \"__main__\":\n","    print(\"Starting daily digest generation...\")\n","\n","    # 1. Get content and tables from the single CSV\n","    print(\"Reading content and tables from daily.csv...\")\n","    content, tables = read_daily_content_from_csv('/content/daily.csv')\n","\n","    if content is not None and tables is not None:\n","        # 2. Convert table data to HTML tables\n","        print(\"Generating tables from CSV data...\")\n","        # Assuming column names in the CSV for the tables are 'Fee WoW (BPS)' and 'SSS WoW'\n","        ht_borrow_html = dataframe_to_html_table(tables.get('ht_borrow_df', pd.DataFrame()), format_change_cols=['Fee WoW (BPS)'])\n","        squeeze_html = dataframe_to_html_table(tables.get('squeeze_df', pd.DataFrame()), format_change_cols=['SSS WoW'])\n","\n","        # 3. Generate the final HTML file\n","        print(\"Generating final HTML digest...\")\n","        final_html = create_digest_html(content, ht_borrow_html, squeeze_html)\n","\n","        # 4. Save the HTML to a file\n","        with open(OUTPUT_HTML_FILEBASED_PATH, 'w', encoding='utf-8') as f:\n","            f.write(final_html)\n","\n","        print(f\"\\nSuccessfully generated digest: {OUTPUT_HTML_FILEBASED_PATH}\")\n","        print(\"This version pulls data from the single provided CSV file.\")\n","    else:\n","        print(\"\\nFailed to generate digest due to errors reading the CSV file.\")"],"execution_count":13,"outputs":[{"output_type":"stream","name":"stdout","text":["Starting daily digest generation...\n","Reading content and tables from daily.csv...\n","Error reading content from CSV file /content/daily.csv: 'utf-8' codec can't decode byte 0x96 in position 413: invalid start byte\n","\n","Failed to generate digest due to errors reading the CSV file.\n"]}]}],"metadata":{"colab":{"provenance":[]},"kernelspec":{"display_name":"Python 3","name":"python3"}},"nbformat":4,"nbformat_minor":0}