{"cells":[{"cell_type":"code","source":["import os\n","import pandas as pd\n","\n","# --- DATA FOR THE REPORT ---\n","# This data is for the July 18, 2025 report.\n","\n","REPORT_DATE = \"July 18, 2025\"\n","\n","MARKET_NOTES = {\n","    \"fee\": \"45.7 bps\",\n","    \"fee_change\": \"+1.71%\",\n","    \"fee_direction\": \"up\",\n","    \"utilization\": \"7.05%\",\n","    \"utilization_change\": \"+0.80%\",\n","    \"utilization_direction\": \"up\"\n","}\n","\n","HEADLINES = [\n","    {\n","        \"title\": \"Asian Markets Rally on Tech and Export Optimism\",\n","        \"body\": \"Major Asian indices posted gains, led by semiconductor and export-heavy sectors. Investor confidence is rising on the back of AI-driven demand and signs of easing trade tensions, particularly between China and the West.\",\n","        \"data_shows\": \"Asian equities are showing significant growth year-over-year, with On Loan Value up to $2.28 billion on average in June 2025 (up $37 billion from June 2024) and borrowing cost rising 10 bps to an average of 123 bps for June this year.\"\n","    },\n","    {\n","        \"title\": \"Oil Prices Climb on Middle East Supply Concerns\",\n","        \"body\": \"Brent crude prices rose above $89 per barrel amid renewed tensions in the Strait of Hormuz. The potential for supply disruptions is fueling inflation concerns and complicating monetary policy decisions worldwide.\",\n","        \"data_shows\": \"In the Oil & Gas sector, New Fortress Energy Inc. has seen a 59% rise in On Loan Quantity Year-on-Year (34 million to 54 million) and an 81% (~$20) fall in its security price in that time (24.1 to 4.5).\"\n","    },\n","    {\n","        \"title\": \"S&P 500 Hits New High Despite Global Uncertainty\",\n","        \"body\": \"Equity markets continue to rally, with the S&P 500 reaching record levels. Investors appear to be looking past geopolitical risks and focusing on earnings and liquidity.\",\n","        \"data_shows\": \"Borrowing costs amongst US Equities have begun to settle. Having risen throughout the past months from around 40 bps in mid-May to a peak of 106 bps last week, this week EquiLend Data & Analytics highlights a 10-15 bp decline, potentially indicating the start of stabilization in the market.\"\n","    }\n","]\n","\n","KEY_TAKEAWAYS = [\n","    \"As Asian markets rally, a year-over-year increase in both On Loan Value and borrowing costs for regional equities could suggest that some investors are using the market strength to establish new hedges or short positions.\",\n","    \"Heightened geopolitical risk in the energy sector is reflected in specific securities, such as New Fortress Energy, where a significant year-over-year increase in shares on loan, paired with a price decline, may indicate sustained bearish sentiment.\",\n","    \"While the S&P 500 reaches new highs, a recent decline in average borrowing costs for U.S. equities from a recent peak could be signaling a reduction in broad market hedging and an increase in investor conviction in the rally.\"\n","]\n","\n","# Data from the user-provided image for the first table\n","HARD_TO_BORROW_DATA = [\n","    {\"ticker\": \"OP\", \"name\": \"OCEANPAL INC\", \"industry\": \"Transportation\", \"fee\": \"90,000+\", \"momentum\": \"+90,433 BPS\", \"momentum_direction\": \"up\"},\n","    {\"ticker\": \"FOXX\", \"name\": \"FOXX DEVELOPMENT\", \"industry\": \"Technology\", \"fee\": \"90,000+\", \"momentum\": \"+87,371 BPS\", \"momentum_direction\": \"up\"},\n","    {\"ticker\": \"NDRA\", \"name\": \"ENDRA LIFE SCIENCES\", \"industry\": \"Health Care\", \"fee\": \"70,000 to 89,999\", \"momentum\": \"+80,369 BPS\", \"momentum_direction\": \"up\"},\n","    {\"ticker\": \"SLRX\", \"name\": \"SALARIUS PHARMACEUTICALS\", \"industry\": \"Biotechnology\", \"fee\": \"70,000 to 89,999\", \"momentum\": \"+66,777 BPS\", \"momentum_direction\": \"up\"},\n","    {\"ticker\": \"BCT CN\", \"name\": \"BRIACELL THERAPEUTICS\", \"industry\": \"Biotechnology\", \"fee\": \"50,000 to 69,999\", \"momentum\": \"+22,678 BPS\", \"momentum_direction\": \"up\"}\n","]\n","\n","# Data from the user-provided image for the second table\n","SHORT_SQUEEZE_DATA = [\n","    {\"ticker\": \"VOR\", \"name\": \"VOR BIOPHARMA\", \"industry\": \"Biotechnology\", \"price\": \"2.38\", \"score\": \"88\", \"score_wow\": \"+12.00\", \"score_direction\": \"up\"},\n","    {\"ticker\": \"QS\", \"name\": \"QUANTUMSCAPE\", \"industry\": \"Automobiles & Components\", \"price\": \"13.60\", \"score\": \"84\", \"score_wow\": \"+14.00\", \"score_direction\": \"up\"},\n","    {\"ticker\": \"IMRX\", \"name\": \"IMMUNEERING CORPORATION\", \"industry\": \"Biotechnology\", \"price\": \"4.30\", \"score\": \"81\", \"score_wow\": \"+12.00\", \"score_direction\": \"up\"},\n","    {\"ticker\": \"CONL\", \"name\": \"GRANITESHARES ETF TRUST\", \"industry\": \"Financials\", \"price\": \"62.00\", \"score\": \"78\", \"score_wow\": \"+5.00\", \"score_direction\": \"up\"},\n","    {\"ticker\": \"RILY\", \"name\": \"B. RILEY FINANCIAL\", \"industry\": \"Diversified Financials\", \"price\": \"5.79\", \"score\": \"77\", \"score_wow\": \"+29.00\", \"score_direction\": \"up\"}\n","]\n","\n","\n","# --- DATA PROCESSING FUNCTIONS ---\n","\n","def get_fee_band(fee):\n","    \"\"\"Converts a numeric fee into a string-based band.\"\"\"\n","    try:\n","        fee = float(fee)\n","    except (ValueError, TypeError):\n","        return \"N/A\"\n","\n","    if fee >= 90000:\n","        return \"90,000+\"\n","    elif 70000 <= fee < 90000:\n","        return \"70,000 to 89,999\"\n","    elif 50000 <= fee < 70000:\n","        return \"50,000 to 69,999\"\n","    elif 30000 <= fee < 50000:\n","        return \"30,000 to 49,999\"\n","    elif 10000 <= fee < 30000:\n","        return \"10,000 to 29,999\"\n","    else:\n","        return \"< 10,000\"\n","\n","def process_htb_data(filepath):\n","    \"\"\"Processes the Hard-to-Borrow CSV file.\"\"\"\n","    if not filepath: return []\n","    try:\n","        df = pd.read_csv(filepath)\n","        df['Fee WoW (BPS)'] = pd.to_numeric(df['Fee WoW (BPS)'], errors='coerce')\n","        df_filtered = df[df['Fee WoW (BPS)'] > 0].sort_values(by='Fee', ascending=False)\n","        top_5 = df_filtered.head(5)\n","\n","        htb_list = []\n","        for _, row in top_5.iterrows():\n","            htb_list.append({\n","                \"ticker\": row['Ticker'],\n","                \"name\": row['Security Description'],\n","                \"industry\": row['GICS Industry Group Name'],\n","                \"fee\": get_fee_band(row['Fee']),\n","                \"momentum\": f\"+{int(row['Fee WoW (BPS)']):,} BPS\",\n","                \"momentum_direction\": \"up\"\n","            })\n","        return htb_list\n","    except FileNotFoundError:\n","        print(f\"Error: File not found at {filepath}\")\n","        return []\n","\n","def process_squeeze_data(filepath):\n","    \"\"\"Processes the Squeeze Metrics CSV file.\"\"\"\n","    if not filepath: return []\n","    try:\n","        df = pd.read_csv(filepath)\n","        df['Short Squeeze Score WoW'] = pd.to_numeric(df['Short Squeeze Score WoW'], errors='coerce')\n","        df_filtered = df[df['Short Squeeze Score WoW'] > 0].sort_values(by='Short Squeeze Score', ascending=False)\n","        top_5 = df_filtered.head(5)\n","\n","        squeeze_list = []\n","        for _, row in top_5.iterrows():\n","            squeeze_list.append({\n","                \"ticker\": row['Ticker'],\n","                \"name\": row['Security Name'],\n","                \"industry\": row['GICS Industry Group Name'],\n","                \"price\": f\"{row['Last Price']:.2f}\",\n","                \"score\": f\"{row['Short Squeeze Score']:.1f}\",\n","                \"score_wow\": f\"+{row['Short Squeeze Score WoW']:.2f}\",\n","                \"score_direction\": \"up\"\n","            })\n","        return squeeze_list\n","    except FileNotFoundError:\n","        print(f\"Error: File not found at {filepath}\")\n","        return []\n","\n","# --- HTML GENERATION FUNCTIONS (INLINE STYLES) ---\n","\n","def get_change_span_inline(change_value, direction):\n","    \"\"\"Returns a styled span for the change value.\"\"\"\n","    color = \"#16a34a\" if direction == \"up\" else \"#dc2626\"\n","    return f'<span style=\"color:{color}; font-size:14px;\">{change_value}</span>'\n","\n","def generate_market_notes_html_inline(notes):\n","    \"\"\"Generates the HTML for the Market Notes section with inline styles.\"\"\"\n","    fee_change_span = get_change_span_inline(notes['fee_change'], notes['fee_direction'])\n","    util_change_span = get_change_span_inline(notes['utilization_change'], notes['utilization_direction'])\n","\n","    return f\"\"\"\n","              <!-- Market Notes -->\n","              <h2 style=\"font-size:18px; margin-bottom:10px;\">ðŸ“ˆ Market Notes</h2>\n","              <table width=\"100%\" cellpadding=\"5\" cellspacing=\"0\" border=\"0\" bgcolor=\"#f8fafc\" style=\"margin-bottom:20px;\">\n","                <tr>\n","                  <td align=\"center\">\n","                    <p style=\"margin:0; font-size:12px; color:#64748b;\">Average Fee</p>\n","                    <p style=\"margin:5px 0 0; font-size:18px; font-weight:bold; color:#334155;\">\n","                      {notes['fee']} {fee_change_span}\n","                    </p>\n","                  </td>\n","                  <td align=\"center\">\n","                    <p style=\"margin:0; font-size:12px; color:#64748b;\">Average Utilization</p>\n","                    <p style=\"margin:5px 0 0; font-size:18px; font-weight:bold; color:#334155;\">\n","                      {notes['utilization']} {util_change_span}\n","                    </p>\n","                  </td>\n","                </tr>\n","              </table>\n","    \"\"\"\n","\n","def generate_headlines_html_inline(headlines_data):\n","    \"\"\"Generates the HTML for the Major Headlines section with inline styles.\"\"\"\n","    articles_html = \"\"\n","    for i, headline in enumerate(headlines_data):\n","        margin_top = 'margin-top:20px;' if i > 0 else ''\n","        articles_html += f\"\"\"\n","              <div style=\"{margin_top}\">\n","                <strong style=\"font-size:16px;\">{headline['title']}</strong>\n","                <p style=\"margin:5px 0 0;\">{headline['body']}</p>\n","                <blockquote style=\"margin:10px 0 0; padding-left:10px; border-left:4px solid #7e22ce; color:#334155;\">\n","                  <strong>What Our Data Shows:</strong><br>\n","                  {headline['data_shows']}\n","                </blockquote>\n","              </div>\n","        \"\"\"\n","    return f\"\"\"\n","              <!-- Headlines -->\n","              <h2 style=\"font-size:18px; margin-bottom:10px;\">ðŸ“° Major Headlines and What Our Data Shows</h2>\n","              {articles_html}\n","    \"\"\"\n","\n","def generate_htb_table_html_inline(data):\n","    \"\"\"Generates the HTML for the Hard-to-Borrow table with inline styles.\"\"\"\n","    if not data:\n","        return \"<p><i>Hard-to-Borrow table data is pending.</i></p>\"\n","    rows_html = \"\"\n","    for row in data:\n","        momentum_span = get_change_span_inline(row['momentum'], row['momentum_direction'])\n","        rows_html += f\"\"\"\n","                  <tr style=\"font-size:12px; background-color:#ffffff; text-align:left;\">\n","                    <td style=\"padding:4px 8px;\">{row['ticker']}</td>\n","                    <td style=\"padding:4px 8px;\">{row['name']}</td>\n","                    <td style=\"padding:4px 8px;\">{row['industry']}</td>\n","                    <td style=\"padding:4px 8px;\">{row['fee']}</td>\n","                    <td style=\"padding:4px 8px;\">{momentum_span}</td>\n","                  </tr>\n","        \"\"\"\n","    return f\"\"\"\n","              <!-- Hard-to-Borrow Table -->\n","              <table cellpadding=\"0\" cellspacing=\"0\" border=\"1\" style=\"border-collapse:collapse; margin-bottom:20px; border-color:#dddddd; font-size:12px;\">\n","                <thead>\n","                  <tr bgcolor=\"#0284c7\" style=\"color:#ffffff; font-weight:bold; text-align:left;\">\n","                    <th style=\"padding:5px 8px;\">Ticker</th>\n","                    <th style=\"padding:5px 8px;\">Name</th>\n","                    <th style=\"padding:5px 8px;\">Industry</th>\n","                    <th style=\"padding:5px 8px;\">Fee (BPS)</th>\n","                    <th style=\"padding:5px 8px;\">Momentum (WoW)</th>\n","                  </tr>\n","                </thead>\n","                <tbody>\n","                  {rows_html}\n","                </tbody>\n","              </table>\n","    \"\"\"\n","\n","def generate_squeeze_table_html_inline(data):\n","    \"\"\"Generates the HTML for the Short Squeeze table with inline styles.\"\"\"\n","    if not data:\n","        return \"<p><i>Market Technicals & Squeeze Metrics table data is pending.</i></p>\"\n","    rows_html = \"\"\n","    for row in data:\n","        score_wow_span = get_change_span_inline(row['score_wow'], row['score_direction'])\n","        rows_html += f\"\"\"\n","                  <tr style=\"font-size:12px; background-color:#ffffff; text-align:left;\">\n","                    <td style=\"padding:4px 8px;\">{row['ticker']}</td>\n","                    <td style=\"padding:4px 8px;\">{row['name']}</td>\n","                    <td style=\"padding:4px 8px;\">{row['industry']}</td>\n","                    <td style=\"padding:4px 8px;\">${row['price']}</td>\n","                    <td style=\"padding:4px 8px;\">{row['score']}</td>\n","                    <td style=\"padding:4px 8px;\">{score_wow_span}</td>\n","                  </tr>\n","        \"\"\"\n","    return f\"\"\"\n","              <!-- Short Squeeze Table -->\n","              <table cellpadding=\"0\" cellspacing=\"0\" border=\"1\" style=\"border-collapse:collapse; border-color:#dddddd; font-size:12px;\">\n","                <thead>\n","                  <tr bgcolor=\"#0284c7\" style=\"color:#ffffff; font-weight:bold; text-align:left;\">\n","                    <th style=\"padding:5px 8px;\">Ticker</th>\n","                    <th style=\"padding:5px 8px;\">Company Name</th>\n","                    <th style=\"padding:5px 8px;\">Industry</th>\n","                    <th style=\"padding:5px 8px;\">Price</th>\n","                    <th style=\"padding:5px 8px;\">Short Squeeze Score</th>\n","                    <th style=\"padding:5px 8px;\">Score (WoW)</th>\n","                  </tr>\n","                </thead>\n","                <tbody>\n","                  {rows_html}\n","                </tbody>\n","              </table>\n","    \"\"\"\n","\n","def generate_takeaways_html_inline(takeaways_data):\n","    \"\"\"Generates the HTML for the Key Takeaways section with inline styles.\"\"\"\n","    list_items_html = \"\"\n","    for item in takeaways_data:\n","        list_items_html += f\"<li>{item}</li>\\n\"\n","\n","    return f\"\"\"\n","              <!-- Key Takeaways -->\n","              <h2 style=\"font-size:18px; margin:20px 0 10px;\">ðŸ’¡ Key Takeaways</h2>\n","              <ul style=\"padding-left:20px; color:#334155; font-size:14px; margin:0;\">\n","                {list_items_html}\n","              </ul>\n","    \"\"\"\n","\n","def create_report_html_inline(date, market_notes, headlines, htb_data, squeeze_data, takeaways):\n","    \"\"\"Assembles the full HTML document from all the pieces using inline styles.\"\"\"\n","\n","    market_notes_section = generate_market_notes_html_inline(market_notes)\n","    headlines_section = generate_headlines_html_inline(headlines)\n","    htb_table_section = generate_htb_table_html_inline(htb_data)\n","    squeeze_table_section = generate_squeeze_table_html_inline(squeeze_data)\n","    takeaways_section = generate_takeaways_html_inline(takeaways)\n","\n","    full_html = f\"\"\"<!DOCTYPE html>\n","<html lang=\"en\">\n","<head>\n","  <meta charset=\"UTF-8\">\n","  <title>EquiLend D&A Daily Digest - {date}</title>\n","</head>\n","<body style=\"margin:0; padding:0; font-family: Arial, sans-serif; background-color:#f1f5f9;\">\n","  <table width=\"100%\" cellpadding=\"0\" cellspacing=\"0\" border=\"0\" bgcolor=\"#f1f5f9\">\n","    <tr>\n","      <td align=\"center\">\n","        <table width=\"800\" cellpadding=\"0\" cellspacing=\"0\" border=\"0\" bgcolor=\"#ffffff\" style=\"margin:20px 0; border-radius:4px; overflow:hidden;\">\n","          <!-- Header -->\n","          <tr>\n","            <td bgcolor=\"#0284c7\" style=\"padding:20px; text-align:center;\">\n","              <h1 style=\"margin:0; font-size:24px; color:#ffffff;\">EquiLend D&amp;A Daily Digest</h1>\n","              <p style=\"margin:5px 0 0; font-size:16px; color:#bae6fd;\">{date}</p>\n","            </td>\n","          </tr>\n","          <!-- Content -->\n","          <tr>\n","            <td style=\"padding:20px; color:#333333; font-size:14px; line-height:1.5;\">\n","              {market_notes_section}\n","              {headlines_section}\n","\n","              <!-- Tables Section -->\n","              <h2 style=\"font-size:18px; margin:20px 0 10px;\">ðŸ“Š Today's Specials and Hard-to-Borrow</h2>\n","              {htb_table_section}\n","\n","              <h2 style=\"font-size:18px; margin:20px 0 10px;\">ðŸ“‰ Market Technicals & Squeeze Metrics</h2>\n","              {squeeze_table_section}\n","\n","              {takeaways_section}\n","            </td>\n","          </tr>\n","          <!-- Footer -->\n","          <tr>\n","            <td align=\"center\" style=\"padding:10px; font-size:12px; color:#64748b;\">\n","              Source: EquiLend Data &amp; Analytics\n","            </td>\n","          </tr>\n","        </table>\n","      </td>\n","    </tr>\n","  </table>\n","</body>\n","</html>\n","\"\"\"\n","    return full_html\n","\n","# --- MAIN EXECUTION ---\n","if __name__ == \"__main__\":\n","    # This script now uses hardcoded data for the tables based on the user's image.\n","    # The file processing functions are kept for potential future use with CSVs.\n","\n","    # Generate the full HTML content\n","    report_html = create_report_html_inline(\n","        REPORT_DATE,\n","        MARKET_NOTES,\n","        HEADLINES,\n","        HARD_TO_BORROW_DATA,\n","        SHORT_SQUEEZE_DATA,\n","        KEY_TAKEAWAYS\n","    )\n","\n","    # Write the HTML to a file\n","    file_name = f\"daily_digest_inline_{REPORT_DATE.replace(' ', '_').replace(',', '')}.html\"\n","    with open(file_name, \"w\", encoding=\"utf-8\") as f:\n","        f.write(report_html)\n","\n","    print(f\"Report successfully generated: {os.path.abspath(file_name)}\")"],"outputs":[{"output_type":"stream","name":"stdout","text":["Report successfully generated: /content/daily_digest_inline_July_18_2025.html\n"]}],"execution_count":1,"metadata":{"id":"0lmk-fcZDfM1","executionInfo":{"status":"ok","timestamp":1752850897623,"user_tz":240,"elapsed":850,"user":{"displayName":"Bob Sheehan","userId":"08159093702253523584"}},"outputId":"0feb86ae-c233-4278-b4f3-5b3cbcc4a4cc","colab":{"base_uri":"https://localhost:8080/"}}}],"metadata":{"colab":{"provenance":[]},"kernelspec":{"display_name":"Python 3","name":"python3"}},"nbformat":4,"nbformat_minor":0}