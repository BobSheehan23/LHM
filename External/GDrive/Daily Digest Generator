{"cells":[{"cell_type":"code","source":["import pandas as pd\n","import docx\n","from datetime import datetime\n","import re\n","import numpy as np\n","\n","# --- Configuration ---\n","# File paths for the input data.\n","# Make sure these files are in the same directory as the script, or provide the full path.\n","CONTENT_DOC_PATH = 'daily_content.docx'\n","TABLES_CSV_PATH = 'daily_tables.csv'\n","OUTPUT_HTML_PATH = f\"equilend_daily_digest_{datetime.now().strftime('%Y_%m_%d')}.html\"\n","\n","# --- 1. DOCX Content Parsing ---\n","\n","def parse_daily_content(doc_path):\n","    \"\"\"\n","    Parses the .docx file to extract market notes, headlines, and key takeaways.\n","\n","    Args:\n","        doc_path (str): The file path to the .docx document.\n","\n","    Returns:\n","        dict: A dictionary containing the parsed content.\n","              Keys are 'market_notes', 'headlines', and 'key_takeaways'.\n","    \"\"\"\n","    try:\n","        document = docx.Document(doc_path)\n","    except Exception as e:\n","        print(f\"Error opening or parsing DOCX file: {e}\")\n","        return None\n","\n","    content = {'market_notes': {}, 'headlines': [], 'key_takeaways': []}\n","\n","    # Use an iterator to allow looking ahead\n","    para_iter = iter(document.paragraphs)\n","\n","    current_section = None\n","\n","    for para in para_iter:\n","        text = para.text.strip()\n","        if not text:\n","            continue\n","\n","        # Section detection\n","        if 'Market Notes:' in text:\n","            current_section = 'market_notes'\n","            continue\n","        elif 'Major Headlines & What Our Data Shows' in text:\n","            current_section = 'headlines'\n","            continue\n","        elif 'Key Takeaways:' in text:\n","            current_section = 'key_takeaways'\n","            continue\n","\n","        # Section-specific parsing\n","        if current_section == 'market_notes':\n","            if 'Average Fee:' in text:\n","                # Use regex to find bps and percentage change\n","                fee_match = re.search(r'(\\d+\\.?\\d*)\\s*bps\\s*([+-]?\\d+\\.?\\d*)%', text)\n","                if fee_match:\n","                    content['market_notes']['avg_fee_bps'] = fee_match.group(1)\n","                    content['market_notes']['avg_fee_change'] = float(fee_match.group(2))\n","            elif 'Average Utilization:' in text:\n","                util_match = re.search(r'(\\d+\\.?\\d*)%\\s*([+-]?\\d+\\.?\\d*)%', text)\n","                if util_match:\n","                    content['market_notes']['avg_util_percent'] = util_match.group(1)\n","                    content['market_notes']['avg_util_change'] = float(util_match.group(2))\n","\n","        elif current_section == 'headlines':\n","            # Assuming structure: Headline (bold), Description, Data Insight\n","            headline_text = text\n","            try:\n","                description_text = next(para_iter).text.strip()\n","                data_insight_text = next(para_iter).text.strip().replace('* What our data is saying:', '').strip()\n","\n","                content['headlines'].append({\n","                    'title': headline_text,\n","                    'description': description_text,\n","                    'data_insight': data_insight_text\n","                })\n","            except StopIteration:\n","                # Reached end of document while parsing a headline block\n","                break\n","\n","        elif current_section == 'key_takeaways':\n","            # Assumes takeaways are list items, but we'll just grab any text in this section\n","            if text.startswith('*'):\n","                text = text[1:].strip()\n","            content['key_takeaways'].append(text)\n","\n","    return content\n","\n","# --- 2. CSV Table Parsing ---\n","\n","def parse_tables_to_html(csv_path):\n","    \"\"\"\n","    Parses the .csv file, splits it into two tables, and generates HTML table rows.\n","    It assumes the two tables in the CSV are separated by a blank line.\n","\n","    Args:\n","        csv_path (str): The file path to the .csv file.\n","\n","    Returns:\n","        tuple: A tuple containing two strings:\n","               - The HTML for the 'Hard-to-Borrow' table body.\n","               - The HTML for the 'Market Technicals' table body.\n","    \"\"\"\n","    try:\n","        df = pd.read_csv(csv_path, skip_blank_lines=False)\n","    except Exception as e:\n","        print(f\"Error opening or parsing CSV file: {e}\")\n","        return \"\", \"\"\n","\n","    # Find the index of the first blank row, which separates the two tables\n","    blank_rows = df[df.isnull().all(axis=1)].index\n","    if not blank_rows.any():\n","        print(\"Warning: No blank line found in CSV to separate tables. Trying to split by columns.\")\n","        # Fallback: try to split based on unique column names if no blank line\n","        if 'Short Squeeze Score' in df.columns:\n","             # This is a heuristic and might not be robust\n","            ht_borrow_df = df[df['Short Squeeze Score'].isnull()]\n","            squeeze_df = df[df['Short Squeeze Score'].notnull()]\n","        else:\n","            print(\"Could not reliably split CSV. Please add a blank row between tables.\")\n","            return \"\", \"\"\n","    else:\n","        split_index = blank_rows[0]\n","        ht_borrow_df = df.iloc[:split_index].dropna(how='all')\n","        squeeze_df = df.iloc[split_index+1:].dropna(how='all')\n","        # Reset headers if the second table's headers are in the first row\n","        squeeze_df.columns = squeeze_df.iloc[0]\n","        squeeze_df = squeeze_df[1:]\n","\n","\n","    # --- Helper to format momentum/score changes ---\n","    def format_change(value, unit=' BPS'):\n","        try:\n","            val = float(value)\n","            color = '#16a34a' if val > 0 else '#dc2626' # Green for positive, Red for negative\n","            sign = '+' if val > 0 else ''\n","            return f'<span style=\"color:{color}; font-size:14px;\">{sign}{val:,.0f}{unit}</span>'\n","        except (ValueError, TypeError):\n","            return str(value)\n","\n","    # --- Generate HTML for Hard-to-Borrow table ---\n","    ht_borrow_html = \"\"\n","    for _, row in ht_borrow_df.iterrows():\n","        ht_borrow_html += '<tr style=\"font-size:12px; background-color:#ffffff; text-align:left;\">\\n'\n","        ht_borrow_html += f'  <td style=\"padding:4px 8px;\">{row.get(\"Ticker\", \"\")}</td>\\n'\n","        ht_borrow_html += f'  <td style=\"padding:4px 8px;\">{row.get(\"Name\", \"\")}</td>\\n'\n","        ht_borrow_html += f'  <td style=\"padding:4px 8px;\">{row.get(\"Industry\", \"\")}</td>\\n'\n","        ht_borrow_html += f'  <td style=\"padding:4px 8px;\">{row.get(\"Fee (BPS)\", \"\")}</td>\\n'\n","        ht_borrow_html += f'  <td style=\"padding:4px 8px;\">{format_change(row.get(\"Momentum (WoW)\"))}</td>\\n'\n","        ht_borrow_html += '</tr>\\n'\n","\n","    # --- Generate HTML for Market Technicals table ---\n","    squeeze_html = \"\"\n","    for _, row in squeeze_df.iterrows():\n","        squeeze_html += '<tr style=\"font-size:12px; background-color:#ffffff; text-align:left;\">\\n'\n","        squeeze_html += f'  <td style=\"padding:4px 8px;\">{row.get(\"Ticker\", \"\")}</td>\\n'\n","        squeeze_html += f'  <td style=\"padding:4px 8px;\">{row.get(\"Company Name\", \"\")}</td>\\n'\n","        squeeze_html += f'  <td style=\"padding:4px 8px;\">{row.get(\"Industry\", \"\")}</td>\\n'\n","        squeeze_html += f'  <td style=\"padding:4px 8px;\">{row.get(\"Price\", \"\")}</td>\\n'\n","        squeeze_html += f'  <td style=\"padding:4px 8px;\">{row.get(\"Short Squeeze Score\", \"\")}</td>\\n'\n","        squeeze_html += f'  <td style=\"padding:4px 8px;\">{format_change(row.get(\"Score (WoW)\"), unit=\"\")}</td>\\n'\n","        squeeze_html += '</tr>\\n'\n","\n","    return ht_borrow_html, squeeze_html\n","\n","\n","# --- 3. HTML Generation ---\n","\n","def create_digest_html(content, table_html_tuple):\n","    \"\"\"\n","    Generates the final HTML for the digest by populating a template with the parsed content.\n","    \"\"\"\n","    if not content:\n","        return \"<h1>Error: Could not parse content from DOCX file.</h1>\"\n","\n","    ht_borrow_table, squeeze_table = table_html_tuple\n","\n","    # --- Helper for Market Notes ---\n","    def format_market_note_change(value):\n","        color = '#16a34a' if value > 0 else '#dc2626'\n","        sign = '+' if value > 0 else ''\n","        return f'<span style=\"color:{color}; font-size:14px;\">{sign}{value:.2f}%</span>'\n","\n","    # --- Dynamic Sections ---\n","    market_notes = content.get('market_notes', {})\n","    avg_fee_bps = market_notes.get('avg_fee_bps', 'N/A')\n","    avg_fee_change = format_market_note_change(market_notes.get('avg_fee_change', 0))\n","    avg_util_percent = market_notes.get('avg_util_percent', 'N/A')\n","    avg_util_change = format_market_note_change(market_notes.get('avg_util_change', 0))\n","\n","    headlines_html = \"\"\n","    for headline in content.get('headlines', []):\n","        headlines_html += f\"\"\"\n","        <div style=\"margin-top:20px;\">\n","            <strong style=\"font-size:16px;\">{headline['title']}</strong>\n","            <p style=\"margin:5px 0 0;\">{headline['description']}</p>\n","            <blockquote style=\"margin:10px 0 0; padding-left:10px; border-left:4px solid #7e22ce; color:#334155;\">\n","              <strong>What Our Data Shows:</strong><br>\n","              {headline['data_insight']}\n","            </blockquote>\n","        </div>\n","        \"\"\"\n","\n","    takeaways_html = \"\"\n","    for item in content.get('key_takeaways', []):\n","        takeaways_html += f\"<li>{item}</li>\\n\"\n","\n","    # --- Full HTML Template ---\n","    # Using the structure from your provided HTML file\n","    html_template = f\"\"\"\n","<!DOCTYPE html>\n","<html lang=\"en\">\n","<head>\n","  <meta charset=\"UTF-8\">\n","  <title>EquiLend D&A Daily Digest - {datetime.now().strftime('%B %d, %Y')}</title>\n","</head>\n","<body style=\"margin:0; padding:0; font-family: Arial, sans-serif; background-color:#f1f5f9;\">\n","  <table width=\"100%\" cellpadding=\"0\" cellspacing=\"0\" border=\"0\" bgcolor=\"#f1f5f9\">\n","    <tr>\n","      <td align=\"center\">\n","        <table width=\"800\" cellpadding=\"0\" cellspacing=\"0\" border=\"0\" bgcolor=\"#ffffff\" style=\"margin:20px 0; border-radius:4px; overflow:hidden;\">\n","          <!-- Header -->\n","          <tr>\n","            <td bgcolor=\"#0284c7\" style=\"padding:20px; text-align:center;\">\n","              <h1 style=\"margin:0; font-size:24px; color:#ffffff;\">EquiLend D&amp;A Daily Digest</h1>\n","              <p style=\"margin:5px 0 0; font-size:16px; color:#bae6fd;\">{datetime.now().strftime('%B %d, %Y')}</p>\n","            </td>\n","          </tr>\n","          <!-- Content -->\n","          <tr>\n","            <td style=\"padding:20px; color:#333333; font-size:14px; line-height:1.5;\">\n","\n","              <!-- Market Notes -->\n","              <h2 style=\"font-size:18px; margin-bottom:10px;\">&#x1F4BC; Market Notes</h2>\n","              <table width=\"100%\" cellpadding=\"5\" cellspacing=\"0\" border=\"0\" bgcolor=\"#f8fafc\" style=\"margin-bottom:20px;\">\n","                <tr>\n","                  <td align=\"center\">\n","                    <p style=\"margin:0; font-size:12px; color:#64748b;\">Average Fee</p>\n","                    <p style=\"margin:5px 0 0; font-size:18px; font-weight:bold; color:#334155;\">\n","                      {avg_fee_bps} bps {avg_fee_change}\n","                    </p>\n","                  </td>\n","                  <td align=\"center\">\n","                    <p style=\"margin:0; font-size:12px; color:#64748b;\">Average Utilization</p>\n","                    <p style=\"margin:5px 0 0; font-size:18px; font-weight:bold; color:#334155;\">\n","                      {avg_util_percent}% {avg_util_change}\n","                    </p>\n","                  </td>\n","                </tr>\n","              </table>\n","\n","              <!-- Headlines -->\n","              <h2 style=\"font-size:18px; margin-bottom:10px;\">&#x1F4F0; Major Headlines and What Our Data Shows</h2>\n","              {headlines_html}\n","\n","              <!-- Tables Section -->\n","              <h2 style=\"font-size:18px; margin:20px 0 10px;\">&#x1F4B6; Today's Specials and Hard-to-Borrow</h2>\n","              <table cellpadding=\"0\" cellspacing=\"0\" border=\"1\" style=\"border-collapse:collapse; margin-bottom:20px; border-color:#dddddd; font-size:12px;\">\n","                <thead>\n","                  <tr bgcolor=\"#0284c7\" style=\"color:#ffffff; font-weight:bold; text-align:left;\">\n","                    <th style=\"padding:5px 8px;\">Ticker</th>\n","                    <th style=\"padding:5px 8px;\">Name</th>\n","                    <th style=\"padding:5px 8px;\">Industry</th>\n","                    <th style=\"padding:5px 8px;\">Fee (BPS)</th>\n","                    <th style=\"padding:5px 8px;\">Momentum (WoW)</th>\n","                  </tr>\n","                </thead>\n","                <tbody>\n","                  {ht_borrow_table}\n","                </tbody>\n","              </table>\n","\n","              <h2 style=\"font-size:18px; margin:20px 0 10px;\">&#x1F4A1; Market Technicals & Squeeze Metrics</h2>\n","              <table cellpadding=\"0\" cellspacing=\"0\" border=\"1\" style=\"border-collapse:collapse; border-color:#dddddd; font-size:12px;\">\n","                <thead>\n","                  <tr bgcolor=\"#0284c7\" style=\"color:#ffffff; font-weight:bold; text-align:left;\">\n","                    <th style=\"padding:5px 8px;\">Ticker</th>\n","                    <th style=\"padding:5px 8px;\">Company Name</th>\n","                    <th style=\"padding:5px 8px;\">Industry</th>\n","                    <th style=\"padding:5px 8px;\">Price</th>\n","                    <th style=\"padding:5px 8px;\">Short Squeeze Score</th>\n","                    <th style=\"padding:5px 8px;\">Score (WoW)</th>\n","                  </tr>\n","                </thead>\n","                <tbody>\n","                  {squeeze_table}\n","                </tbody>\n","              </table>\n","\n","              <!-- Key Takeaways -->\n","              <h2 style=\"font-size:18px; margin:20px 0 10px;\">&#x1F4A1; Key Takeaways</h2>\n","              <ul style=\"padding-left:20px; color:#334155; font-size:14px; margin:0;\">\n","                {takeaways_html}\n","              </ul>\n","\n","            </td>\n","          </tr>\n","          <!-- Footer -->\n","          <tr>\n","            <td align=\"center\" style=\"padding:10px; font-size:12px; color:#64748b;\">\n","              Source: EquiLend Data &amp; Analytics\n","            </td>\n","          </tr>\n","        </table>\n","      </td>\n","    </tr>\n","  </table>\n","</body>\n","</html>\n","    \"\"\"\n","    return html_template\n","\n","# --- Main Execution ---\n","if __name__ == \"__main__\":\n","    print(\"Starting daily digest generation...\")\n","\n","    # 1. Parse content from the Word document\n","    print(f\"Reading content from {CONTENT_DOC_PATH}...\")\n","    parsed_content = parse_daily_content(CONTENT_DOC_PATH)\n","\n","    # 2. Parse data from the CSV and generate HTML tables\n","    print(f\"Reading tables from {TABLES_CSV_PATH}...\")\n","    table_html = parse_tables_to_html(TABLES_CSV_PATH)\n","\n","    # 3. Generate the final HTML file\n","    print(\"Generating final HTML digest...\")\n","    final_html = create_digest_html(parsed_content, table_html)\n","\n","    # 4. Save the HTML to a file\n","    with open(OUTPUT_HTML_PATH, 'w', encoding='utf-8') as f:\n","        f.write(final_html)\n","\n","    print(f\"\\nSuccessfully generated digest: {OUTPUT_HTML_PATH}\")\n","    print(\"You can now open this file in a browser or use it in your email client.\")"],"outputs":[{"output_type":"stream","name":"stdout","text":["Starting daily digest generation...\n","Reading content from daily_content.docx...\n","Reading tables from daily_tables.csv...\n","Generating final HTML digest...\n","\n","Successfully generated digest: equilend_daily_digest_2025_07_21.html\n","You can now open this file in a browser or use it in your email client.\n"]}],"execution_count":6,"metadata":{"colab":{"base_uri":"https://localhost:8080/"},"id":"ZxpsNupZZnuc","executionInfo":{"status":"ok","timestamp":1753092050873,"user_tz":240,"elapsed":35,"user":{"displayName":"Bob Sheehan","userId":"08159093702253523584"}},"outputId":"e9c405a6-4143-44f9-f43d-78507d30f376"}},{"cell_type":"code","metadata":{"colab":{"base_uri":"https://localhost:8080/"},"id":"091adf85","executionInfo":{"status":"ok","timestamp":1753091634007,"user_tz":240,"elapsed":9704,"user":{"displayName":"Bob Sheehan","userId":"08159093702253523584"}},"outputId":"58ca659a-d73d-4d84-f530-504b3be13a84"},"source":["%pip install python-docx"],"execution_count":2,"outputs":[{"output_type":"stream","name":"stdout","text":["Collecting python-docx\n","  Downloading python_docx-1.2.0-py3-none-any.whl.metadata (2.0 kB)\n","Requirement already satisfied: lxml>=3.1.0 in /usr/local/lib/python3.11/dist-packages (from python-docx) (5.4.0)\n","Requirement already satisfied: typing_extensions>=4.9.0 in /usr/local/lib/python3.11/dist-packages (from python-docx) (4.14.1)\n","Downloading python_docx-1.2.0-py3-none-any.whl (252 kB)\n","\u001b[?25l   \u001b[90m━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\u001b[0m \u001b[32m0.0/253.0 kB\u001b[0m \u001b[31m?\u001b[0m eta \u001b[36m-:--:--\u001b[0m\r\u001b[2K   \u001b[91m━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\u001b[0m\u001b[91m╸\u001b[0m\u001b[90m━\u001b[0m \u001b[32m245.8/253.0 kB\u001b[0m \u001b[31m8.0 MB/s\u001b[0m eta \u001b[36m0:00:01\u001b[0m\r\u001b[2K   \u001b[90m━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\u001b[0m \u001b[32m253.0/253.0 kB\u001b[0m \u001b[31m5.4 MB/s\u001b[0m eta \u001b[36m0:00:00\u001b[0m\n","\u001b[?25hInstalling collected packages: python-docx\n","Successfully installed python-docx-1.2.0\n"]}]}],"metadata":{"colab":{"provenance":[]},"kernelspec":{"display_name":"Python 3","name":"python3"}},"nbformat":4,"nbformat_minor":0}